<div class="container-fluid px-5 mb-4">

    <div class="m-3">
        <a th:href="@{/quizes}" class="btn btn-outline-primary btn-sm position-absolute mt-3">
            <i class="bi bi-arrow-left-short"></i> Back
        </a>
        <h1 class="text-center">Quiz</h1>
    </div>
    <!-- Course Selection -->
    <div class="row mb-4">

        <div class="col-md-6">
            <div class="form-group">
                <label for="course" class="form-label fw-bold ">Select Course</label>
                <select id="course" name="course" class="form-select" onchange="reloadPage()">
                    <option value="default">-- Select a Course --</option>
                    <option
                            th:each="course : ${courses}"
                            th:value="${course.id}"
                            th:text="${course.name}"
                    >
                    </option>
                </select>
            </div>
        </div>

        <!-- Quiz Title Input -->
        <div class="col-md-6">
            <div class="form-group">
                <label for="quizTitle" class="form-label fw-bold">Quiz Title</label>
                <input type="text" class="form-control" id="quizTitle" th:value="${quiz.name}" readonly>
            </div>
        </div>

    </div>

    <div class="row">
        <!-- Question Library -->
        <div class="col-md-6">
            <div class="card">

                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-book fa-sm me-2"></i>Question Library
                    </h5>
                </div>

                <div class="card-body card-body-height-1">
                    <div class="accordion" id="courseChapters">

                        <!-- Show another quiz here -->

                        <div class="accordion-item" th:each="quiz : ${quizes}">

                            <div class="accordion-header">
                                <div class="accordion-button fw-bold collapsed" type="button"
                                     data-bs-toggle="collapse" th:data-bs-target="'#chapter' + ${quiz.id}"
                                     aria-expanded="false"
                                     th:text="${quiz.name}">
                                </div>
                            </div>

                            <div th:id="'chapter' + ${quiz.id}" class="accordion-collapse collapse">

                                <div class="accordion-body">
                                    <ul class="list-group">
                                        <!-- Danh sách câu hỏi từ thư viện -->
                                        <li class="list-group-item d-flex justify-content-between align-items-center hover-effect"
                                            th:each="question : ${quiz.questions}">
                                            <span th:utext="${question.questionText}">Question Text</span>

                                            <!-- Form chuyển từng câu hỏi -->
                                            <form th:action="@{/questions/transfer}" method="post" class="d-inline">
                                                <input type="hidden" name="questionId" th:value="${question.id}" />
                                                <input type="hidden" name="targetQuizId" th:value="${currentQuiz.id}" />
                                                <button type="submit" class="btn btn-sm rounded-pill px-3 bc-f8f8f8">
                                                    <i class="fas fa-plus fa-xs me-1"></i>
                                                </button>
                                            </form>
                                        </li>
                                    </ul>

                                    <!-- Nút Add All để gửi tất cả câu hỏi -->
                                    <form th:action="@{/questions/transfer-all}" method="post" class="mt-2">
                                        <input type="hidden" name="sourceQuizId" th:value="${quiz.id}" />
                                        <input type="hidden" name="targetQuizId" th:value="${currentQuiz.id}" />
                                        <button type="submit" class="btn btn-primary">
                                            Add All Questions
                                        </button>
                                    </form>
                                </div>

                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Selected Questions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle fa-sm me-2"></i>Selected Questions
                    </h5>
                </div>
                <div class="card-body card-body-height-2">
                    <!-- Popup form thêm question -->
                    <div class="d-flex justify-content-center z-3 top-0">
                        <a id="addQuestionBtn" class="add-area w-100 btn btn-outline-primary py-2 mb-3">
                            + Add a new question
                        </a>
                        <div id="questionModal" class="modal justify-content-center align-items-center"
                             style="display: none;">
                            <div class="modal-content py-3 px-4">
                                <div class="position-relative px-3 my-2 text-center">
                                    <span id="closeModalBtn" class="close position-absolute end-2">
                                        <i class="bi bi-x h-0"></i>
                                    </span>
                                    <h3 class="mb-3">Add a new question</h3>
                                </div>

                                <!-- Form get Question data to Create -->
                                <form id="addQuestionForm"
                                      th:action="@{'/quizes/detail/'+ ${quiz.id} +'/questions/create'}"
                                      th:object="${question}" method="post" class="needs-validation">
                                    <label for="questionDescription" class="form-label fw-bold mb-3">Question</label>

                                    <!-- Get data from CKEditor -->
                                    <textarea id="questionDescription" class="form-control cke_notification d-none"
                                              th:field="*{questionText}"></textarea>

                                    <!-- Choose questionType -->
                                    <div class="mb-3 mt-4">
                                        <label for="questionType" class="form-label fw-bold mb-3">Type</label>
                                        <select id="questionType" class="form-select" th:field="*{questionType}"
                                                required onchange="checkType()">
                                            <option value="">-- Select a Question Type --</option>
                                            <option
                                                    th:each="type : ${types}"
                                                    th:value="${type}"
                                                    th:text="${type}"></option>
                                        </select>
                                        <div id="invalid-question-type" class="invalid"></div>
                                    </div>

                                    <!-- Answer Options -->
                                    <div class="mb-3" id="answerOptions"
                                         style="display: none;">
                                        <label class="form-label fw-bold">Answers</label>
                                        <div id="answersContainer">

                                        </div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2"
                                                id="addAnswerBtn">
                                            + Add another answer
                                        </button>
                                    </div>

                                    <!-- Modal Footer -->
                                    <div class="modal-footer gap-2">
                                        <button id="saveQuestionBtn" class="btn btn-save btn-sm"
                                                type="submit">
                                            <i class="fas fa-save fa-lg me-1"></i> Save
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- List danh sách câu hỏi -->
                    <div>
                        <ul class="list-group accordion-body">
                            <div id="quiz-question-container" class="accordion">

                                <!-- Show question here -->

                                <div class="accordion-item row mx-0 py-1" th:each=" question : ${quiz.questions}" th:data-order="${question.questionNo}">

                                    <div class="col-md-11 pe-4">
                                        <div class="accordion-header d-flex align-items-center">
                                            <div class="accordion-button collapsed position-relative z-0"
                                                 data-bs-toggle="collapse"
                                                 th:data-bs-target="'#question' + ${question.id}"
                                                 aria-expanded="false"
                                                 th:utext="${question.questionText}">
                                            </div>

                                        </div>

                                        <div th:id="'question' + ${question.id}" class="accordion-collapse collapse">

                                            <div class="accordion-body">
                                                <ul class="list-group">

                                                    <li th:each="answerOption : ${question.answerOptions}"
                                                        th:class="${answerOption.isCorrect} ?
                                                    'list-group-item d-flex justify-content-between align-items-center hover-effect c-correct' :
                                                    'list-group-item d-flex justify-content-between align-items-center hover-effect'">
                                                        <span th:text="${answerOption.optionLabel} + '. ' + ${answerOption.optionText}">Question Text</span>
                                                    </li>

                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Chức năng vị trí câu hỏi -->
                                    <div class="col-md-1 d-flex justify-content-end align-items-center gap-2">
                                        <div class="d-flex flex-column align-items-center gap-1">
                                            <a href="#" class="btn btn-edit btn-sm"
                                               onclick="editQuestion(${question.id})"
                                               th:onclick="'editQuestion(' + ${question.id} + ')'">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a class="btn btn-clear btn-sm"
                                               th:data-question-id="${question.id}"
                                               th:onclick="|deleteQuestion(event, ${question.id}, 'Are you sure you want to delete this question?')|">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                        <div class="d-flex flex-column align-items-center gap-1">
                                            <button id="moveFirst" class="question-no btn btn-edit btn-sm rounded-circle
                                                d-flex justify-content-center align-items-center fs-6"
                                                    th:onclick="|moveQuestion(${question.id}, 1)|"
                                                    th:disabled="${question.questionNo == 1}">
                                                <i class="fas fa-angle-double-up"></i>
                                            </button>

                                            <button id="moveUp" class="question-no btn btn-edit btn-sm rounded-circle
                                                d-flex justify-content-center align-items-center fs-6"
                                                    th:onclick="|moveQuestion(${question.id}, ${question.questionNo - 1})|"
                                                    th:disabled="${question.questionNo == 1}">
                                                <i class="fas fa-angle-up"></i>
                                            </button>

                                            <input id="questionNo" class="question-no text-center"
                                                   th:value="${question.questionNo}" th:onchange="|changeSortOrder(this, ${quiz.id})|">

                                            <button id="moveDown" class="question-no btn btn-edit btn-sm rounded-circle
                                                d-flex justify-content-center align-items-center fs-6"
                                                    th:onclick="|moveQuestion(${question.id}, ${question.questionNo + 1})|"
                                                    th:disabled="${question.questionNo == totalQuestions}">
                                                <i class="fas fa-angle-down"></i>
                                            </button>

                                            <button id="moveLast" class="question-no btn btn-edit btn-sm rounded-circle
                                                d-flex justify-content-center align-items-center fs-6"
                                                    th:onclick="|moveQuestion(${question.id}, ${totalQuestions})|"
                                                    th:disabled="${question.questionNo == totalQuestions}">
                                                <i class="fas fa-angle-double-down"></i>
                                            </button>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </ul>
                    </div>

                </div>
                <div class="card-footer">
                    <div class="d-flex gap-2">
                        <a th:href="'/quizes/detail/'+${quiz.id}+'/view-all'" class="btn btn-edit btn-sm me-auto">
                            <i class="bi bi-eye bi-lg me-1"></i> View All
                        </a>
                        <a href="#" class="btn btn-clear btn-sm"
                           onclick="deleteAllQuestions(event, 'Are you sure you want to delete all questions?')">
                            <i class="bi bi-trash bi-lg me-1"></i> Clear All
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Question Modal -->
<div id="editQuestionModal" class="modal justify-content-center align-items-center" style="display: none;">
    <div class="modal-content py-3 px-4">
        <div class="position-relative px-3 my-2 text-center">
                        <span id="closeEditModalBtn" class="close position-absolute end-2">
                            <i class="bi bi-x h-0"></i>
                        </span>
            <h3 class="mb-3">Edit Question</h3>
        </div>

        <form id="editQuestionForm">
            <input type="hidden" id="editQuestionId" name="id"/>

            <label for="editQuestionDescription" class="form-label fw-bold mb-3">Question</label>
            <textarea id="editQuestionDescription" class="form-control"></textarea>

            <div class="mb-3 mt-4">
                <label for="editQuestionType" class="form-label fw-bold mb-3">Type</label>
                <select id="editQuestionType" class="form-select" name="questionType" required onchange="checkEditType()">
                    <option value="">-- Select a Question Type --</option>
                    <option th:each="type : ${types}" th:value="${type}" th:text="${type}"></option>
                </select>
            </div>

            <div class="mb-3" id="editAnswerOptions" style="display: none;">
                <label class="form-label fw-bold">Answers</label>
                <div id="editAnswersContainer"></div>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addEditAnswerBtn">
                    + Add another answer
                </button>
            </div>

            <div class="modal-footer gap-2">
                <button type="button" class="btn btn-save btn-sm" onclick="saveEditedQuestion()">
                    <i class="fas fa-save fa-lg me-1"></i> Save
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.ckeditor.com/4.20.2/standard/ckeditor.js"></script>
<script>

    const button = document.querySelector('button');
    const questionId = button.dataset.questionId;

    function deleteQuestion(event, questionId, message) {
        event.preventDefault();
        if (confirm(message)) {
            fetch(`/quizes/detail/${quizId}/questions/${questionId}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("Failed to delete question.");
                }
            })
            .catch(error => {
                console.error("Error deleting question:", error);
                alert("An error occurred while deleting the question.");
            });
        }
    }

    function deleteAllQuestions(event, message) {
        event.preventDefault();
        if (confirm(message)) {
            fetch(`/quizes/detail/${quizId}/questions`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("Failed to delete all questions.");
                }
            })
            .catch(error => {
                console.error("Error deleting all questions:", error);
                alert("An error occurred while deleting all questions.");
            });
        }
    }

    // variable
    let questionType = document.getElementById("questionType");
    let answerOption = document.getElementById("answerOptions");
    let addAnswerBtn = document.getElementById("addAnswerBtn");

    // open popup screen
    document.addEventListener("DOMContentLoaded", function () {
        let addQuestionBtn = document.getElementById('addQuestionBtn');
        if (addQuestionBtn) {
            addQuestionBtn.onclick = function () {
                let modal = document.getElementById('questionModal');
                if (modal) {
                    modal.style.display = "flex";
                    console.log("Modal is opened");
                }
            }
        } else {
            console.error("Element with ID 'addQuestionBtn' not found.");
        }
    });

    // check type of question to hidden/show answer option
    function checkType() {
        switch (questionType.value) {
            case "TEXT":
                answerOption.style.display = 'none';
                var answer = document.getElementsByClassName('answer-option');
                if (answer.length > 0) {
                    var answerArray = Array.from(answer);
                    for (var answerKey of answerArray) {
                        answerKey.remove();
                    }
                }
                break;
            case "MCQ":
                answerOption.style.display = 'block';
                var checkInput1 = document.getElementsByClassName("form-check-input");
                for (var mKey of checkInput1) {
                    mKey.setAttribute("onchange", "");
                }
                break;
            case "SCQ":
                answerOption.style.display = 'block';
                var checkInput2 = document.getElementsByClassName("form-check-input");
                for (var cKey of checkInput2) {
                    cKey.setAttribute("onchange", "ensureSingleSelection(this)");
                    cKey.checked = false;
                }
                break;
        }
    }

    // add input form to new answer option
    if (addAnswerBtn) {
        addAnswerBtn.addEventListener("click", function () {
            let container = document.getElementById("answersContainer");
            if (!container) {
                console.error("Element with ID 'answersContainer' not found.");
                return;
            }

            var index = container.getElementsByClassName("answer-option").length;
            const labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J']; // Expand as needed
            const label = labels[index % labels.length]; // Cycle through labels

            let newAnswer = document.createElement("div");
            newAnswer.classList.add("answer-option", "d-flex", "align-items-center", "mb-2");
            newAnswer.innerHTML = `
                <span class="me-2">${label}.</span>
                <input type="text" class="form-control me-2"
                name="answerOptions[${index}].optionText" placeholder="Enter an answer">
                <input type="checkbox" name="answerOptions[${index}].correct"
                class="form-check-input" onchange="${questionType.value === "MCQ" ? "" : "ensureSingleSelection(this)"}"> <i class="bi bi-check"></i>
                <button type="button" class="remove-answer text-danger btn btn-remove btn-sm ms-2">
                    <i class="bi bi-x"></i>
                </button>
            `;
            container.appendChild(newAnswer);

            // event remove answer option
            newAnswer.querySelector(".remove-answer").addEventListener("click", function () {
                newAnswer.remove();
            });
        });
    } else {
        console.error("Element with ID 'addAnswerBtn' not found.");
    }

    // just one checkbox are choose
    function ensureSingleSelection(selectedCheckbox) {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function (checkbox) {
            if (checkbox !== selectedCheckbox) {
                checkbox.checked = false;
            }
        });
    }

    // close popup screen
    let closeModalBtn = document.getElementById('closeModalBtn');
    if (closeModalBtn) {
        closeModalBtn.onclick = function () {
            let modal = document.getElementById('questionModal');
            if (modal) {
                modal.style.display = "none";
                console.log("Modal is closed");
            }
        }
    }

    let saveQuestionBtn = document.getElementById('saveQuestionBtn');
    if (saveQuestionBtn) {
        saveQuestionBtn.onclick = function () {
            let questionText = document.getElementById('questionDescription')?.value || "";
            let answers = [];
            document.querySelectorAll('.answer-option input[type="text"]').forEach((input) => {
                if (input.value) answers.push(input.value);
            });

            console.log("Question:", questionText);
            console.log("Answers:", answers);

            let modal = document.getElementById('questionModal');
            if (modal) modal.style.display = "none";
        }
    }

    let clearFieldsBtn = document.getElementById('clearFieldsBtn');
    if (clearFieldsBtn) {
        clearFieldsBtn.onclick = function () {
            document.getElementById('questionDescription').value = '';
            document.querySelectorAll('.answer-option input[type="text"]').forEach(input => input.value = '');
            document.querySelectorAll('.answer-option input[type="radio"]').forEach(radio => radio.checked = false);
        };
    }

    if (document.getElementById('questionDescription')) {
        CKEDITOR.replace('questionDescription', {
            removePlugins: 'easyimage, cloudservices'
        });
    }

    // reload page after filter by course
    function reloadPage() {
        let selectBox = document.getElementById("course");
        if (selectBox) {
            let selectedValue = selectBox.options[selectBox.selectedIndex].value;
            if (selectedValue == 'default') {
                window.location.href = window.location.pathname;
            } else {
                window.location.href = '?course=' + selectedValue;
            }
        }
    }

    // keep value after reload page
    document.addEventListener("DOMContentLoaded", function () {
        let selectBox = document.getElementById("course");
        if (selectBox) {
            let urlParams = new URLSearchParams(window.location.search);
            let course = urlParams.get("course");
            if (course) {
                selectBox.value = course;
            }
        }
    });

    // confirm
    function confirmNavigation(event, message) {
        if (!(message)) {
            event.preventDefault();
        }
    }

    // validate add question form
    document.getElementById("addQuestionForm").addEventListener("submit", function (event) {
        const select = document.getElementById("questionType");
        const errorDiv = document.getElementById("invalid-question-type");

        // Kiểm tra xem giá trị đã chọn có phải là giá trị mặc định hay không
        if (select.value === "") {
            event.preventDefault();  // Ngăn chặn form submit
            errorDiv.textContent = "Vui lòng chọn một mục khác!";
        } else {
            errorDiv.textContent = "";  // Xóa thông báo lỗi nếu chọn hợp lệ
        }
    });

    // Chức năng thay đổi vị trí
    const quizId = [[${quiz.id}]];
    function moveQuestion(questionId, newPosition) {
        fetch(`/quizes/detail/${quizId}/questions/${questionId}/move?newPosition=${newPosition}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error("Error updating question position");
            })
            .then(data => {
                console.log(data);
                location.reload(); // Reload để cập nhật danh sách câu hỏi
            })
            .catch(error => console.error(`Error updating question position for Question ID ${questionId}:`, error));
    }

    // sắp xếp các phần tử accordition-item
    function sortOrderQuestions() {
        var container = document.getElementById("quiz-question-container");
        var items = Array.from(container.querySelectorAll(".accordion-item"));
        items.sort(function(a, b) {
            return a.getAttribute("data-order") - b.getAttribute("data-order");
        });
        items.forEach(function(item) {
            container.appendChild(item);
        });
    }

    document.addEventListener("DOMContentLoaded", sortOrderQuestions);

    function changeSortOrder(element, questionId) {
        var newOrder = element.value;
        if (newOrder === "") {
            return; // Nếu giá trị rỗng, không làm gì cả
        }
        moveQuestion(questionId, newOrder);
    }

    function checkEditType() {
        const editQuestionType = document.getElementById("editQuestionType");
        const editAnswerOptions = document.getElementById("editAnswerOptions");

        switch (editQuestionType.value) {
            case "TEXT":
                editAnswerOptions.style.display = 'none';
                const answers = document.getElementsByClassName('edit-answer-option');
                Array.from(answers).forEach(answer => answer.remove());
                break;
            case "MCQ":
                editAnswerOptions.style.display = 'block';
                const checkInputs1 = document.getElementsByClassName("edit-form-check-input");
                Array.from(checkInputs1).forEach(input => {
                    input.setAttribute("onchange", "");
                });
                break;
            case "SCQ":
                editAnswerOptions.style.display = 'block';
                const checkInputs2 = document.getElementsByClassName("edit-form-check-input");
                Array.from(checkInputs2).forEach(input => {
                    input.setAttribute("onchange", "ensureEditSingleSelection(this)");
                    input.checked = false;
                });
                break;
        }
    }

    function editQuestion(questionId) {
        // Khởi tạo CKEditor
        if (!CKEDITOR.instances.editQuestionDescription) {
            CKEDITOR.replace('editQuestionDescription', {
                removePlugins: 'easyimage, cloudservices'
            });
        }

        // Reset form
        document.getElementById('editQuestionForm').reset();
        document.getElementById('editAnswersContainer').innerHTML = '';

        // Hiển thị modal
        let modal = document.getElementById('editQuestionModal');
        modal.style.display = "flex";

        // Fetch question data
        fetch(`/quizes/detail/questions/${questionId}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // Populate form
                document.getElementById('editQuestionId').value = data.id;
                CKEDITOR.instances.editQuestionDescription.setData(data.questionText);

                const typeSelect = document.getElementById('editQuestionType');
                typeSelect.value = data.questionType;
                checkEditType();

                if (data.answerOptions && data.answerOptions.length > 0) {
                    data.answerOptions.forEach((option, index) => {
                        addEditAnswerOption(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load question details. Please try again.');
                closeEditModal();
            });
    }

    function saveEditedQuestion() {
        const questionId = document.getElementById('editQuestionId').value;
        const questionText = CKEDITOR.instances.editQuestionDescription.getData();
        const questionType = document.getElementById('editQuestionType').value;

        // Đơn giản hóa cấu trúc dữ liệu
        const answerOptions = Array.from(document.querySelectorAll('#editAnswersContainer .edit-answer-option'))
            .map((div, index) => ({
                id: div.querySelector('input[type="hidden"]')?.value || null,
                optionLabel: String.fromCharCode(65 + index),
                optionText: div.querySelector('input[type="text"]').value,
                correct: div.querySelector('input[type="checkbox"]').checked // Đổi isCorrect thành correct
            }));

        const data = {
            questionText,
            questionType,
            answerOptions
        };

        console.log('Data being sent:', data);

        fetch(`/quizes/detail/${quizId}/questions/${questionId}/update`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector("meta[name='_csrf']").getAttribute("content")
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update question');
            return response.json();
        })
        .then(() => {
            closeEditModal();
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            location.reload();
        });
    }

    function addEditAnswerOption(option = null) {
        const container = document.getElementById('editAnswersContainer');
        const index = container.children.length;
        const label = String.fromCharCode(65 + index);

        const div = document.createElement('div');
        div.className = 'edit-answer-option d-flex align-items-center mb-2';

        div.innerHTML = `
            <span class="me-2">${label}.</span>
            ${option?.id ? `<input type="hidden" value="${option.id}">` : ''}
            <input type="text" class="form-control me-2"
                   value="${option ? option.optionText : ''}"
                   placeholder="Enter an answer">
            <input type="checkbox" class="form-check-input"
                   ${option && option.isCorrect ? 'checked' : ''}>
            <button type="button" class="btn btn-remove btn-sm ms-2" onclick="this.parentElement.remove()">
                <i class="bi bi-x"></i>
            </button>
        `;

        container.appendChild(div);
    }

    // Thêm event listener cho nút thêm answer
    document.getElementById('addEditAnswerBtn')?.addEventListener('click', () => {
        addEditAnswerOption();
    });

    // Thêm function để đóng modal edit
    function closeEditModal() {
        let modal = document.getElementById('editQuestionModal');
        if (modal) {
            modal.style.display = "none";
        }
    }

    // Thêm event listener cho nút đóng
    document.getElementById('closeEditModalBtn')?.addEventListener('click', closeEditModal);

    document.addEventListener("DOMContentLoaded", function() {
        var form = document.getElementById("quiz-form");
        
        if (form) {
            // Đảm bảo elapsedTime có giá trị mặc định
            document.getElementById("elapsedTime").value = "0";
            
            form.addEventListener("submit", function() {
                var startTime = new Date().getTime();
                var now = new Date().getTime();
                var elapsedSeconds = Math.floor((now - startTime) / 1000);
                
                // Đảm bảo elapsedTime không bao giờ rỗng
                document.getElementById("elapsedTime").value = elapsedSeconds || "0";
            });
        }
        
        updateTime();
    });

</script>
<style>

    .card-body-height-2 {
        height: 44vh;
        overflow-y: auto;
    }

    .card-body-height-1 {
        height: 50vh;
        overflow-y: auto;
    }

    /* Modal container */
    .modal {
        /*position: fixed;*/
        z-index: 1;
        /*left: 0;*/
        /*top: 0;*/
        /*width: 100%;*/
        /*height: 100%;*/
        background-color: rgba(0, 0, 0, 0.5);
    }

    /* Modal content */
    .modal-content {
        /*background-color: #fff;*/
        /*border-radius: 8px;*/
        width: 100vh;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        height: 80vh;
        overflow-y: auto;
        /*position: relative;*/
        /*margin: auto;*/
    }

    /* Close button */
    .close {
        right: 10px;
        font-size: 30px;
        color: #888;
        cursor: pointer;
    }

    .close:hover {
        color: #000;
    }

    .modal-footer .add-area {
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 5px;
        cursor: pointer;
    }

    .add-area {
        /*font-size: 16px;*/
        border-radius: 5px;
        border-style: dashed;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .accordion-header button {
        background-color: #F8F8F8;
        color: black !important;
        border-color: black;
        box-shadow: none !important;
    }

    .cke_notification {
        display: none !important;
    }

    .bc-f8f8f8 {
        background-color: #F8F8F8;
    }

    .c-correct {
        background-color: #d9f7d9;
        color: #1cbba9;
    }

    /*clear button*/
    .btn-clear {
        --bs-btn-color: #000;
        --bs-btn-bg: #fff;
        --bs-btn-border-color: #000;
        --bs-btn-hover-color: #fff;
        --bs-btn-hover-bg: #dc3545;
        --bs-btn-hover-border-color: #dc3545;
        --bs-btn-focus-shadow-rgb: 225, 83, 97;
        --bs-btn-active-color: #fff;
        --bs-btn-active-bg: #b02a37;
        --bs-btn-active-border-color: #a52834;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        --bs-btn-disabled-color: #fff;
        --bs-btn-disabled-bg: #dc3545;
        --bs-btn-disabled-border-color: #dc3545;
    }

    .btn-save {
        --bs-btn-color: #000;
        --bs-btn-bg: #fff;
        --bs-btn-border-color: #000;
        --bs-btn-hover-color: #fff;
        --bs-btn-hover-bg: #0d6efd;
        --bs-btn-hover-border-color: #0d6efd;
        --bs-btn-focus-shadow-rgb: 225, 83, 97;
        --bs-btn-active-color: #fff;
        --bs-btn-active-bg: #0a58ca;
        --bs-btn-active-border-color: #0a53be;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        --bs-btn-disabled-color: #fff;
        --bs-btn-disabled-bg: #0d6efd;
        --bs-btn-disabled-border-color: #0d6efd;
    }

    .btn-remove {
        --bs-btn-color: #dc3545;
        --bs-btn-bg: #fff;
        --bs-btn-border-color: #fff;
        --bs-btn-hover-color: var(--bs-btn-color);
        --bs-btn-hover-bg: #fff;
        --bs-btn-hover-border-color: var(--bs-btn-color);
        --bs-btn-focus-shadow-rgb: 225, 83, 97;
        --bs-btn-active-color: #fff;
        --bs-btn-active-bg: #b02a37;
        --bs-btn-active-border-color: #a52834;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        --bs-btn-disabled-color: #fff;
        --bs-btn-disabled-bg: #dc3545;
        --bs-btn-disabled-border-color: #dc3545;
    }

    .btn-edit {
        --bs-btn-color: #000;
        --bs-btn-bg: #fff;
        --bs-btn-border-color: #000;
        --bs-btn-hover-color: #fff;
        --bs-btn-hover-bg: #6c757d;
        --bs-btn-hover-border-color: #6c757d;
        --bs-btn-focus-shadow-rgb: 108, 117, 125;
        --bs-btn-active-color: #fff;
        --bs-btn-active-bg: #6c757d;
        --bs-btn-active-border-color: #6c757d;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        --bs-btn-disabled-color: #6c757d;
        --bs-btn-disabled-bg: transparent;
        --bs-btn-disabled-border-color: #6c757d;
        --bs-gradient: none;
    }

    .question-no {
        font-size: 10px;
        width: 20px;
        height: 20px;
    }

    .invalid {
        color: red;
    }

    .modal-dialog {
        max-width: 800px;
    }

    .modal-content {
        width: 100%;
        height: auto;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal.fade .modal-dialog {
        transition: transform .3s ease-out;
        transform: translate(0,-50px);
    }

    .modal.show .modal-dialog {
        transform: none;
    }

</style>
<meta name="_csrf" content="${_csrf.token}"/>