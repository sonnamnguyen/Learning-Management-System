<div class="container-fluid px-5 mb-4">

    <h1 class="text-center m-3">Quiz</h1>

    <!-- Course Selection -->
    <div class="row mb-4">

        <div class="col-md-6">
            <div class="form-group">
                <label for="course" class="form-label fw-bold ">Select Course</label>
                <select id="course" name="course" class="form-select" onchange="reloadPage()">
                    <option value="default">-- Select a Course --</option>
                    <option
                            th:each="course : ${courses}"
                            th:value="${course.id}"
                            th:text="${course.name}"
                    >
                    </option>
                </select>
            </div>
        </div>

        <!-- Quiz Title Input -->
        <div class="col-md-6">
            <div class="form-group">
                <label for="quizTitle" class="form-label fw-bold">Quiz Title</label>
                <input type="text" class="form-control" id="quizTitle" th:value="${quiz.name}" readonly>
            </div>
        </div>

    </div>

    <div class="row">
        <!-- Question Library -->
        <div class="col-md-6">
            <div class="card">

                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-book fa-sm me-2"></i>Question Library
                    </h5>
                </div>

                <div class="card-body card-body-height-1">
                    <div class="accordion" id="courseChapters">

                        <!-- Show another quiz here -->

                        <div class="accordion-item" th:each="quiz : ${quizes}">

                            <div class="accordion-header">
                                <div class="accordion-button fw-bold collapsed" type="button"
                                     data-bs-toggle="collapse" th:data-bs-target="'#chapter' + ${quiz.id}"
                                     aria-expanded="false"
                                     th:text="${quiz.name}">
                                </div>
                            </div>

                            <div th:id="'chapter' + ${quiz.id}" class="accordion-collapse collapse">

                                <div class="accordion-body">
                                    <ul class="list-group">

                                        <li class="list-group-item d-flex justify-content-between align-items-center hover-effect"
                                            th:each="question : ${quiz.questions}">
                                            <span th:utext="${question.questionText}">Question Text</span>
                                            <a href="#" class="btn btn-sm rounded-pill px-3 bc-f8f8f8">
                                                <i class="fas fa-plus fa-xs me-1 "></i>
                                            </a>
                                        </li>

                                    </ul>
                                </div>

                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Selected Questions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle fa-sm me-2"></i>Selected Questions
                    </h5>
                </div>
                <div class="card-body card-body-height-2">
                    <div class="d-flex justify-content-center position-sticky z-3 top-0">
                        <a id="addQuestionBtn" class="add-area w-100 btn btn-outline-primary py-2 mb-3">
                            + Add a new question
                        </a>
                        <div id="questionModal" class="modal justify-content-center align-items-center"
                             style="display: none;">
                            <div class="modal-content py-3 px-4">
                                <div class="position-relative px-3 my-2 text-center">
                                    <span id="closeModalBtn" class="close position-absolute end-2">
                                        <i class="bi bi-x h-0"></i>
                                    </span>
                                    <h3 class="mb-3">Add a new question</h3>
                                </div>

                                <!-- Form get Question data to Create -->
                                <form th:action="@{'/quizes/detail/'+ ${quiz.id} +'/questions/create'}"
                                      th:object="${question}" method="post" class="needs-validation" novalidate>
                                    <label for="questionDescription" class="form-label fw-bold mb-3">Question</label>

                                    <!-- Get data from CKEditor -->
                                    <textarea id="questionDescription" class="form-control cke_notification"
                                              style="visibility: hidden; display: none;"
                                              th:field="*{questionText}"></textarea>

                                    <!-- Choose questionType -->
                                    <div class="mb-3 mt-4">
                                        <label for="questionType" class="form-label fw-bold mb-3">Type</label>
                                        <select id="questionType" class="form-select" th:field="*{questionType}"
                                                required onchange="checkType()">
                                            <option value="">-- Select a Question Type --</option>
                                            <option
                                                    th:each="type : ${types}"
                                                    th:value="${type}"
                                                    th:text="${type}"></option>
                                        </select>
                                        <div class="invalid-feedback">Question Type is required.</div>
                                    </div>

                                    <!-- Answer Options -->
                                    <div class="mb-3" id="answerOptions"
                                         style="display: none;">
                                        <label class="form-label fw-bold">Answers</label>
                                        <div id="answersContainer">

                                        </div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2"
                                                id="addAnswerBtn">
                                            + Add another answer
                                        </button>
                                    </div>

                                    <!-- Modal Footer -->
                                    <div class="modal-footer gap-2">
                                        <button id="saveQuestionBtn" class="btn btn-save btn-sm"
                                                type="submit">
                                            <i class="fas fa-save fa-lg me-1"></i> Save
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div>
                        <ul class="list-group accordion-body">
                            <div class="accordion">

                                <!-- Show question here -->

                                <div class="accordion-item position-relative" th:each=" question : ${quiz.questions}">

                                    <div class="accordion-header d-flex align-items-center">
                                        <div class="accordion-button collapsed position-relative z-0"
                                             data-bs-toggle="collapse"
                                             th:data-bs-target="'#question' + ${question.id}"
                                             aria-expanded="false"
                                             th:utext="${question.questionText}">
                                        </div>
                                        <div class="position-absolute z-2 end-0 me-3
                                        d-flex gap-2 justify-content-between align-items-center">
                                            <a href="" class="btn btn-edit btn-sm">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="" class="btn btn-clear btn-sm"
                                               onclick="confirmNavigation(event,'Are you sure you want to delete this question?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </div>

                                    <div th:id="'question' + ${question.id}" class="accordion-collapse collapse">

                                        <div class="accordion-body">
                                            <ul class="list-group">

                                                <li th:each="answerOption : ${question.answerOptions}"
                                                    th:class="${answerOption.isCorrect} ?
                                                    'list-group-item d-flex justify-content-between align-items-center hover-effect c-correct' :
                                                    'list-group-item d-flex justify-content-between align-items-center hover-effect'">
                                                    <span th:text="${answerOption.optionLabel} + '. ' + ${answerOption.optionText}">Question Text</span>
                                                </li>

                                            </ul>
                                        </div>

                                        <div class="position-absolute z-3 start-100 top-0 translate-middle-x
                                            d-flex gap-2 justify-content-between align-items-center h-100 my-auto ps-5">
                                            <div class="d-flex flex-column align-items-center gap-1">
                                                <button id="moveFirst" class="question-no btn btn-edit btn-sm rounded-circle
                                                d-flex justify-content-center align-items-center fs-6">
                                                    <i class="fas fa-angle-double-up"></i>
                                                </button>

                                                <button id="moveUp" class="question-no btn btn-edit btn-sm rounded-circle
                                                d-flex justify-content-center align-items-center fs-6">
                                                    <i class="fas fa-angle-up"></i>
                                                </button>

                                                <input id="questionNo" class="question-no text-center">

                                                <button id="moveDown" class="question-no btn btn-edit btn-sm rounded-circle
                                                d-flex justify-content-center align-items-center fs-6">
                                                    <i class="fas fa-angle-down"></i>
                                                </button>

                                                <button id="moveLast" class="question-no btn btn-edit btn-sm rounded-circle
                                                d-flex justify-content-center align-items-center fs-6">
                                                    <i class="fas fa-angle-double-down"></i>
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </ul>
                    </div>

                </div>
                <div class="card-footer">
                    <div class="d-flex gap-2">
                        <a href="#" class="btn btn-edit btn-sm me-auto">
                            <i class="bi bi-eye bi-lg me-1"></i> View All
                        </a>
                        <a href="#" class="btn btn-save btn-sm"
                           onclick="return confirmNavigation(event,'Are you sure?')">
                            <i class="bi bi-floppy bi-lg me-1"></i> Save
                        </a>
                        <a href="#" class="btn btn-clear btn-sm"
                           onclick="return confirmNavigation(event,'Are you sure?')">
                            <i class="bi bi-trash bi-lg me-1"></i> Clear All
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.ckeditor.com/4.20.2/standard/ckeditor.js"></script>
<script>

    // variable
    let questionType = document.getElementById("questionType");
    let answerOption = document.getElementById("answerOptions");
    let addAnswerBtn = document.getElementById("addAnswerBtn");

    // open popup screen
    document.addEventListener("DOMContentLoaded", function () {
        let addQuestionBtn = document.getElementById('addQuestionBtn');
        if (addQuestionBtn) {
            addQuestionBtn.onclick = function () {
                let modal = document.getElementById('questionModal');
                if (modal) {
                    modal.style.display = "flex";
                    console.log("Modal is opened");
                }
            }
        } else {
            console.error("Element with ID 'addQuestionBtn' not found.");
        }
    });

    // check type of question to hidden/show answer option
    function checkType() {
        if (questionType.value === "TEXT") {
            answerOption.style.display = 'none';
            var answer = document.getElementsByClassName('answer-option');
            if (answer.length > 0) {
                var answerArray = Array.from(answer);
                for (var answerKey of answerArray) {
                    answerKey.remove();
                }
            }
        } else {
            answerOption.style.display = 'block';
            var correctInput = document.getElementsByClassName("form-check-input");
            for (var correctKey of correctInput) {
                if (questionType.value === "MCQ") {
                    correctKey.setAttribute("onchange", "");
                } else {
                    correctKey.setAttribute("onchange", "ensureSingleSelection(this)");
                }
            }
        }
    }

    // add input form to new answer option
    if (addAnswerBtn) {
        addAnswerBtn.addEventListener("click", function () {
            let container = document.getElementById("answersContainer");
            if (!container) {
                console.error("Element with ID 'answersContainer' not found.");
                return;
            }

            var index = container.getElementsByClassName("answer-option").length;

            let newAnswer = document.createElement("div");
            newAnswer.classList.add("answer-option", "d-flex", "align-items-center", "mb-2");
            newAnswer.innerHTML = `
                <input type="text" class="form-control me-2"
                name="answerOptions[${index}].optionText" placeholder="Enter an answer">
                <input type="checkbox" name="answerOptions[${index}].correct"
                class="form-check-input"> <i class="bi bi-check"></i>
                <button type="button" class="remove-answer text-danger btn btn-remove btn-sm ms-2">
                    <i class="bi bi-x"></i>
                </button>
            `;
            container.appendChild(newAnswer);

            // event remove answer option
            newAnswer.querySelector(".remove-answer").addEventListener("click", function () {
                newAnswer.remove();
            });
        });
    } else {
        console.error("Element with ID 'addAnswerBtn' not found.");
    }

    // just one checkbox are choose
    function ensureSingleSelection(selectedCheckbox) {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function (checkbox) {
            if (checkbox !== selectedCheckbox) {
                checkbox.checked = false;
            }
        });
    }

    // close popup screen
    let closeModalBtn = document.getElementById('closeModalBtn');
    if (closeModalBtn) {
        closeModalBtn.onclick = function () {
            let modal = document.getElementById('questionModal');
            if (modal) {
                modal.style.display = "none";
                console.log("Modal is closed");
            }
        }
    }

    let saveQuestionBtn = document.getElementById('saveQuestionBtn');
    if (saveQuestionBtn) {
        saveQuestionBtn.onclick = function () {
            let questionText = document.getElementById('questionDescription')?.value || "";
            let answers = [];
            document.querySelectorAll('.answer-option input[type="text"]').forEach((input) => {
                if (input.value) answers.push(input.value);
            });

            console.log("Question:", questionText);
            console.log("Answers:", answers);

            let modal = document.getElementById('questionModal');
            if (modal) modal.style.display = "none";
        }
    }

    let clearFieldsBtn = document.getElementById('clearFieldsBtn');
    if (clearFieldsBtn) {
        clearFieldsBtn.onclick = function () {
            document.getElementById('questionDescription').value = '';
            document.querySelectorAll('.answer-option input[type="text"]').forEach(input => input.value = '');
            document.querySelectorAll('.answer-option input[type="radio"]').forEach(radio => radio.checked = false);
        };
    }

    if (document.getElementById('questionDescription')) {
        CKEDITOR.replace('questionDescription', {
            removePlugins: 'easyimage, cloudservices'
        });
    }

    // reload page after filter by course
    function reloadPage() {
        let selectBox = document.getElementById("course");
        if (selectBox) {
            let selectedValue = selectBox.options[selectBox.selectedIndex].value;
            if (selectedValue == 'default') {
                window.location.href = window.location.pathname;
            } else {
                window.location.href = '?course=' + selectedValue;
            }
        }
    }

    // keep value after reload page
    document.addEventListener("DOMContentLoaded", function () {
        let selectBox = document.getElementById("course");
        if (selectBox) {
            let urlParams = new URLSearchParams(window.location.search);
            let course = urlParams.get("course");
            if (course) {
                selectBox.value = course;
            }
        }
    });

    // confirm
    function confirmNavigation(event, message) {
        if (!(message)) {
            event.preventDefault();
        }
    }

</script>
<style>

    .card-body-height-2 {
        height: 44vh;
        overflow-y: auto;
    }

    .card-body-height-1 {
        height: 50vh;
        overflow-y: auto;
    }

    /* Modal container */
    .modal {
        /*position: fixed;*/
        z-index: 1;
        /*left: 0;*/
        /*top: 0;*/
        /*width: 100%;*/
        /*height: 100%;*/
        background-color: rgba(0, 0, 0, 0.5);
    }

    /* Modal content */
    .modal-content {
        /*background-color: #fff;*/
        /*border-radius: 8px;*/
        width: 100vh;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        height: 80vh;
        overflow-y: auto;
        /*position: relative;*/
        /*margin: auto;*/
    }

    /* Close button */
    .close {
        right: 10px;
        font-size: 30px;
        color: #888;
        cursor: pointer;
    }

    .close:hover {
        color: #000;
    }

    .modal-footer .add-area {
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 5px;
        cursor: pointer;
    }

    .add-area {
        /*font-size: 16px;*/
        border-radius: 5px;
        border-style: dashed;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .accordion-header button {
        background-color: #F8F8F8;
        color: black !important;
        border-color: black;
        box-shadow: none !important;
    }

    .cke_notification {
        display: none !important;
    }

    .bc-f8f8f8 {
        background-color: #F8F8F8;
    }

    .c-correct {
        background-color: #d9f7d9;
         color: #1cbba9;
    }

    /*clear button*/
    .btn-clear {
        --bs-btn-color: #000;
        --bs-btn-bg: #fff;
        --bs-btn-border-color: #000;
        --bs-btn-hover-color: #fff;
        --bs-btn-hover-bg: #dc3545;
        --bs-btn-hover-border-color: #dc3545;
        --bs-btn-focus-shadow-rgb: 225, 83, 97;
        --bs-btn-active-color: #fff;
        --bs-btn-active-bg: #b02a37;
        --bs-btn-active-border-color: #a52834;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        --bs-btn-disabled-color: #fff;
        --bs-btn-disabled-bg: #dc3545;
        --bs-btn-disabled-border-color: #dc3545;
    }

    .btn-save {
        --bs-btn-color: #000;
        --bs-btn-bg: #fff;
        --bs-btn-border-color: #000;
        --bs-btn-hover-color: #fff;
        --bs-btn-hover-bg: #0d6efd;
        --bs-btn-hover-border-color: #0d6efd;
        --bs-btn-focus-shadow-rgb: 225, 83, 97;
        --bs-btn-active-color: #fff;
        --bs-btn-active-bg: #0a58ca;
        --bs-btn-active-border-color: #0a53be;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        --bs-btn-disabled-color: #fff;
        --bs-btn-disabled-bg: #0d6efd;
        --bs-btn-disabled-border-color: #0d6efd;
    }

    .btn-remove {
        --bs-btn-color: #dc3545;
        --bs-btn-bg: #fff;
        --bs-btn-border-color: #fff;
        --bs-btn-hover-color: var(--bs-btn-color);
        --bs-btn-hover-bg: #fff;
        --bs-btn-hover-border-color: var(--bs-btn-color);
        --bs-btn-focus-shadow-rgb: 225, 83, 97;
        --bs-btn-active-color: #fff;
        --bs-btn-active-bg: #b02a37;
        --bs-btn-active-border-color: #a52834;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        --bs-btn-disabled-color: #fff;
        --bs-btn-disabled-bg: #dc3545;
        --bs-btn-disabled-border-color: #dc3545;
    }

    .btn-edit {
        --bs-btn-color: #000;
        --bs-btn-bg: #fff;
        --bs-btn-border-color: #000;
        --bs-btn-hover-color: #fff;sh
        --bs-btn-hover-bg: #6c757d;
        --bs-btn-hover-border-color: #6c757d;
        --bs-btn-focus-shadow-rgb: 108, 117, 125;
        --bs-btn-active-color: #fff;
        --bs-btn-active-bg: #6c757d;
        --bs-btn-active-border-color: #6c757d;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        --bs-btn-disabled-color: #6c757d;
        --bs-btn-disabled-bg: transparent;
        --bs-btn-disabled-border-color: #6c757d;
        --bs-gradient: none;
    }

    .question-no {
        font-size: 10px;
        width: 20px;
        height: 20px;
    }

</style>