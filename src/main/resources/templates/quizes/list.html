<!-- Thông báo lỗi -->
<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Thông báo thành công -->
<div th:if="${successMessage}" class="alert alert-primary alert-dismissible fade show" role="alert">
    <i class="bi bi-info-circle-fill"></i>
    <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="px-5 flex-grow-1">
    <h1 class="text-center">Quizes</h1>
    <div>
        <div>
            <a th:href="@{/}" class="btn btn-outline-primary btn-sm" style="margin-bottom: 15px;">
                <i class="bi bi-arrow-left-short"></i> Back
            </a>
        </div>
        <div class="d-flex align-items-center mb-3">
            <div class="flex-fill">
                <!-- Search Form -->
                <form action="/quizes" method="get" class="d-flex gap-2" id="searchForm">
                    <div class="d-flex gap-2">
                        <!-- Course Filter -->
                        <select id="course" name="course" class="form-select" style="width: 200px;">
                            <option value="">-- Select a Course --</option>
                            <option
                                    th:each="course : ${courses}"
                                    th:value="${course.id}"
                                    th:text="${course.name}"
                                    th:selected="${param.course != null and param.course[0] == course.id.toString()}"
                            >
                            </option>
                        </select>

                        <!-- Tag Filter -->
                        <div class="dropdown" style="width: 200px;">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="tagFilterButton" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-tags me-1"></i>
                                Select Tags
                            </button>
                            <ul class="dropdown-menu w-100 p-0">
                                <!-- Search box for tags -->
                                <li class="px-3 py-2 border-bottom">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" class="form-control form-control-sm"
                                               id="searchTags"
                                               placeholder="Search tags">
                                    </div>
                                </li>
                                <!-- Tags list -->
                                <div class="tags-scroll px-3 py-2">
                                    <div id="tagsContainer" class="d-flex flex-wrap gap-2">
                                        <div class="form-check" th:each="tag : ${tags}">
                                            <input class="form-check-input tag-checkbox"
                                                   type="checkbox"
                                                   th:id="'tag-' + ${tag.id}"
                                                   th:value="${tag.id}"
                                                   onchange="handleTagChange()"
                                                   th:checked="${param.tags != null and param.tags.contains(tag.id.toString())}">
                                            <label class="form-check-label" th:for="'tag-' + ${tag.id}" th:text="${tag.name}"></label>
                                        </div>
                                    </div>
                                </div>
                                <!-- Footer -->
                                <li class="px-3 py-2 border-top bg-light">
                                    <button type="button" class="btn btn-sm btn-outline-secondary w-100" onclick="clearAllTags()">
                                        <i class="bi bi-x-circle me-1"></i>Clear
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <!-- Search Input -->
                        <input type="text" class="form-control" name="searchQuery" th:value="${searchQuery}"
                               placeholder="Search by quiz name" aria-label="Search" style="width: 200px;">

                        <!-- Hidden input for tags -->
                        <input type="hidden" name="tags" id="selectedTags">

                        <button class="btn btn-outline-secondary" type="submit" onclick="return prepareSearch()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </form>
            </div>
            <div>
                <a href="/quizes/print" class="btn btn-outline-secondary me-2" target="_blank">
                    <i class="bi bi-printer"></i> Print
                </a>
                <!-- Export Button -->
                <a href="quizes/export" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-file-earmark-excel"></i> Export
                </a>

                <!--Convert-->
                <a href="tools" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-arrow-repeat"></i> Convert
                </a>

                <!-- Import Button that triggers modal -->
                <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="bi bi-upload"></i> Import
                </button>

                <a href="/quizes/create" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Create New Quiz
                </a>
            </div>
        </div>
        <div class="d-flex align-items-center mb-3">
            <button id="toggleView" class="btn btn-primary btn-sm">
                <i class="bi bi-table"></i> Switch to Table View
            </button>
        </div>
        <div id="cardView" class="row">
            <div th:each="quize : ${quizes}" class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title" th:text="${quize.getName()}"></h5>
                        <p class="card-text text-muted" th:text="${quize.getDescription()}"></p>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Attempts:</strong> <span th:text="${quize.getAttemptLimit()}"></span></li>
                            <li class="list-group-item"><strong>Start:</strong> <span th:text="${#temporals.format(quize.getStartTime(), 'dd-MM-yyyy HH:mm:ss')}"></span></li>
                            <li class="list-group-item"><strong>End:</strong> <span th:text="${#temporals.format(quize.getEndTime(), 'dd-MM-yyyy HH:mm:ss')}"></span></li>
                            <li class="list-group-item"><strong>Status:</strong> <span th:text="${quize.getQuizType()}"></span></li>
                        </ul>
                        <div class="mt-3 d-flex gap-2">
                            <a th:href="@{'/quizes/edit/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a th:href="@{'/quizes/detail/' + ${quize.getId()}}" class="btn btn-outline-primary btn-sm" title="Detail">
                                <i class="bi bi-info-circle"></i>
                            </a>
                            <a th:href="@{'/quizes/delete/' + ${quize.getId()}}" class="btn btn-outline-danger btn-sm"
                               onclick="return confirm('Are you sure?')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </a>
                            <a th:href="@{'/quizes/participants/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Participants">
                                <i class="bi bi-person-circle"></i>
                            </a>
                            <form th:action="@{'/quizes/apply/' + ${quize.id}}" method="post"
                                  th:if="${quize.getQuizType().name() == 'OPEN'}"
                                  onsubmit="return confirm('Do you want to join this quiz?');"
                                  class="d-inline-block ms-auto">
                                <button type="submit" class="btn btn-outline-primary btn-sm d-flex align-items-center w-100" title="Apply">
                                    <i class="bi bi-caret-right-fill"></i> Apply
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tableView" class="scrollable-table">
            <table class="table table-bordered">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th class="text-center">#</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Attempt</th>
                    <th>Time Start</th>
                    <th>Time End</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="quize, iterStat : ${quizes}">
                    <td class="text-center" th:text="${iterStat.index + 1}"></td>
                    <td th:text="${quize.getName()}"></td>
                    <td th:text="${quize.getDescription()}"></td>
                    <td th:text="${quize.getAttemptLimit()}"></td>
                    <td th:text="${#temporals.format(quize.getStartTime(), 'dd-MM-yyyy HH:mm:ss')}"></td>
                    <td th:text="${#temporals.format(quize.getEndTime(), 'dd-MM-yyyy HH:mm:ss')}"></td>

                    <td th:text="${quize.getQuizType()}"></td>

                    <td class="d-flex align-items-center gap-1">
                        <a th:href="@{'/quizes/edit/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a th:href="@{'/quizes/participants/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Participants">
                            <i class="bi bi-person-circle"></i>
                        </a>
                        <a th:href="@{'/quizes/detail/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Detail">
                            <i class="bi bi-info-circle"></i>
                        </a>
                        <a th:href="@{'/quizes/delete/' + ${quize.getId()}}" class="btn btn-outline-danger btn-sm"
                           onclick="return confirm('Are you sure?')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </a>

                        <!-- Nút Apply khi QuizType là OPEN -->
                        <form th:action="@{'/quizes/apply/' + ${quize.id}}" method="post"
                              th:if="${quize.getQuizType().name() == 'OPEN'}"
                              onsubmit="return confirm('Do you want to join this quiz?');">
                            <button type="submit" class="btn btn-outline-primary btn-sm d-flex align-items-center" title="Apply">
                                <i class="bi bi-caret-right-fill"></i> Apply
                            </button>
                        </form>

                        <!-- Nút Closed khi QuizType là CLOSE -->
                        <button type="button" class="btn btn-outline-secondary btn-sm d-flex align-items-center" title="Closed" disabled
                                th:if="${quize.getQuizType().name() == 'CLOSE'}">
                            <i class="bi bi-caret-right-fill"></i> Closed
                        </button>
                    </td>

                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="row justify-content-center">
            <div class="pagination col-4 justify-content-center pe-0" th:if="${totalPages > 0}">
                <ul class="pagination">
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${0}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course})}"><<</a>
                    </li>

                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${currentPage - 1}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course})}"><</a>
                    </li>

                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                        th:classappend="${currentPage == i} ? 'active'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${i}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course})}"
                           th:text="${i + 1}"></a>
                    </li>

                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${currentPage + 1}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course})}">></a>
                    </li>

                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${totalPages - 1}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course})}">>></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Import -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Roles from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Information about the template -->
                <!--                    <div class="mb-3">-->
                <!--                        <p>Download the Excel template before uploading your file:</p>-->
                <!--                        <a href="/templates/roles.xlsx" class="btn btn-link" download>Download Role Template</a>-->
                <!--                    </div>-->
                <!-- Import form -->
                <form method="post" enctype="multipart/form-data" th:action="@{/quizes/modal}">
                    <div>
                        <label for="course" class="form-label fw-bold ">Select Course</label>
                        <select id="course" name="course" class="form-select" onchange="reloadPage()">
                            <option value="">-- Select a Course --</option>
                            <option
                                    th:each="course : ${courses}"
                                    th:value="${course.name}"
                                    th:text="${course.name}"
                            >
                            </option>
                        </select>
                    </div>

                    <div>
                        <label for="fileType" class="form-label fw-bold ">Select File Type</label>
                        <select id="fileType" name="fileType" class="form-select" onchange="reloadPage()" required>
                            <option value="">-- Select file type --</option>
                            <option
                                    th:each="fileType : ${fileTypes}"
                                    th:value="${fileType}"
                                    th:text="${fileType}"
                                    th:selected="${fileType==chosenType}"
                            >
                            </option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="file" class="form-label">Choose Excel File</label>
                        <input type="file" name="file" id="file" class="form-control" required>
                        <p class="mt-2 text-success" th:if="${chosenFile}">
                            Chosen file: <span th:text="${chosenFile}"></span>
                        </p>
                    </div>
                    <button type="submit" name="action" value="import" class="btn btn-primary">Import</button>
                    <button type="submit" name="action" value="review" class="btn btn-primary">Review file</button>
                </form>
                <div th:if="${error}" class="alert alert-danger">
                    <p th:text="${error}"></p>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmImportModal" tabindex="-1" aria-labelledby="confirmImportLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmImportLabel">Confirm Import</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="importMessage">The file contains <strong id="questionCount"></strong> questions. Do you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmImportButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!--&lt;!&ndash; Card View &ndash;&gt;-->
<!--<div  class="row">-->
<!--    <div th:each="quize : ${quizes}" class="col-md-4 mb-4">-->
<!--        <div class="card h-100 shadow-sm">-->
<!--            <div class="card-body">-->
<!--                <h5 class="card-title" th:text="${quize.getName()}"></h5>-->
<!--                <p class="card-text text-muted" th:text="${quize.getDescription()}"></p>-->
<!--                <ul class="list-group list-group-flush">-->
<!--                    <li class="list-group-item"><strong>Attempts:</strong> <span th:text="${quize.getAttemptLimit()}"></span></li>-->
<!--                    <li class="list-group-item"><strong>Start:</strong> <span th:text="${#temporals.format(quize.getStartTime(), 'dd-MM-yyyy HH:mm:ss')}"></span></li>-->
<!--                    <li class="list-group-item"><strong>End:</strong> <span th:text="${#temporals.format(quize.getEndTime(), 'dd-MM-yyyy HH:mm:ss')}"></span></li>-->
<!--                    <li class="list-group-item"><strong>Status:</strong> <span th:text="${quize.getQuizType()}"></span></li>-->
<!--                </ul>-->
<!--                <div class="mt-3 d-flex gap-2">-->
<!--                    <a th:href="@{'/quizes/edit/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Edit">-->
<!--                        <i class="bi bi-pencil"></i>-->
<!--                    </a>-->
<!--                    <a th:href="@{'/quizes/detail/' + ${quize.getId()}}" class="btn btn-outline-primary btn-sm" title="Detail">-->
<!--                        <i class="bi bi-info-circle"></i>-->
<!--                    </a>-->
<!--                    <a th:href="@{'/quizes/delete/' + ${quize.getId()}}" class="btn btn-outline-danger btn-sm"-->
<!--                       onclick="return confirm('Are you sure?')" title="Delete">-->
<!--                        <i class="bi bi-trash"></i>-->
<!--                    </a>-->
<!--                    <a th:href="@{'/quizes/participants/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Participants">-->
<!--                        <i class="bi bi-person-circle"></i>-->
<!--                    </a>-->
<!--                    <form th:action="@{'/quizes/apply/' + ${quize.id}}" method="post"-->
<!--                          th:if="${quize.getQuizType().name() == 'OPEN'}"-->
<!--                          onsubmit="return confirm('Do you want to join this quiz?');"-->
<!--                          class="d-inline-block">-->
<!--                        <button type="submit" class="btn btn-outline-primary btn-sm d-flex align-items-center w-100" title="Apply">-->
<!--                            <i class="bi bi-caret-right-fill"></i> Apply-->
<!--                        </button>-->
<!--                    </form>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let viewMode = localStorage.getItem("viewMode") || "table";
    updateView(viewMode);

    document.getElementById("toggleView").addEventListener("click", function () {
        viewMode = (viewMode === "table") ? "card" : "table";
        localStorage.setItem("viewMode", viewMode);
        updateView(viewMode);
    });

    // Prevent dropdown from closing when clicking inside
    const dropdownMenu = document.querySelector('.dropdown-menu');
    if (dropdownMenu) {
        dropdownMenu.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }

    // Thêm event listener cho searchTags input
    const searchInput = document.getElementById('searchTags');
    if (searchInput) {
        searchInput.addEventListener('input', searchTags);
    }

    // Initialize selected tags text
    updateSelectedTagsText();
});

function searchTags() {
    const query = document.getElementById('searchTags').value.trim();
    const tagsContainer = document.getElementById('tagsContainer');

    // Nếu query rỗng, load lại tất cả tags
    if (!query) {
        fetch('/quizes/tags', {
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(handleResponse)
        .then(renderTags)
        .catch(handleError);
        return;
    }

    // Show loading state
    tagsContainer.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split me-2"></i> Loading...</div>';

    fetch(`/quizes/tags/search?name=${encodeURIComponent(query)}`, {
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(handleResponse)
    .then(renderTags)
    .catch(handleError);
}

function handleResponse(response) {
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
}

function renderTags(tags) {
    const tagsContainer = document.getElementById('tagsContainer');
    tagsContainer.innerHTML = '';

    if (!tags || tags.length === 0) {
        tagsContainer.innerHTML = '<div class="alert alert-info">No tags found</div>';
        return;
    }

    const tagsArray = Array.isArray(tags) ? tags : [tags];
    tagsArray.forEach(tag => {
        if (tag && tag.id) {
            const sanitizedName = tag.name
                ? tag.name.replace(/[<>]/g, '')
                : 'Unnamed Tag';

            const isChecked = document.querySelector(`input[value="${tag.id}"]`)?.checked || false;

            tagsContainer.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input tag-checkbox"
                           type="checkbox"
                           id="tag-${tag.id}"
                           value="${tag.id}"
                           onchange="handleTagChange()"
                           ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="tag-${tag.id}">
                        ${sanitizedName}
                    </label>
                </div>
            `;
        }
    });
}

function handleError(error) {
    console.error('Error:', error);
    const tagsContainer = document.getElementById('tagsContainer');
    tagsContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-circle me-2"></i>
            Unable to load tags. Please try refreshing the page.
        </div>`;
}

function handleTagChange() {
    updateSelectedTagsText();
    document.getElementById('searchForm').submit();
}

function clearAllTags() {
    document.querySelectorAll('.tag-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedTagsText();
    document.getElementById('selectedTags').value = '';
    document.getElementById('searchForm').submit();
}

function updateSelectedTagsText() {
    const button = document.getElementById('tagFilterButton');
    const selectedTags = document.querySelectorAll('.tag-checkbox:checked');
    const selectedCount = selectedTags.length;

    if (selectedCount === 0) {
        button.innerHTML = '<i class="bi bi-tags me-1"></i>Select Tags';
    } else {
        button.innerHTML = `<i class="bi bi-tags-fill me-1"></i>${selectedCount} selected`;
    }

    document.getElementById('selectedTags').value = Array.from(selectedTags)
        .map(checkbox => checkbox.value)
        .join(',');
}

function updateView(mode) {
    let toggleButton = document.getElementById("toggleView");
    if (mode === "table") {
        document.getElementById("tableView").style.display = "block";
        document.getElementById("cardView").style.display = "none";
        toggleButton.innerHTML = '<i class="bi bi-grid"></i> Switch to Card View';
        toggleButton.classList.replace("btn-primary", "btn-secondary");
    } else {
        document.getElementById("tableView").style.display = "none";
        document.getElementById("cardView").style.display = "flex";
        toggleButton.innerHTML = '<i class="bi bi-table"></i> Switch to Table View';
        toggleButton.classList.replace("btn-secondary", "btn-primary");
    }
}
</script>

<style>
.dropdown-menu {
    max-height: 300px;
    overflow-y: auto;
    padding: 0;
}

.dropdown-menu .form-check {
    padding: 8px 16px;
    margin: 0;
}

.dropdown-menu .form-check:hover {
    background-color: rgba(0,0,0,0.05);
}

.dropdown-toggle::after {
    float: right;
    margin-top: 8px;
}

/* Đảm bảo dropdown menu không bị ẩn bởi các phần tử khác */
.dropdown {
    position: relative;
    z-index: 1000;
}

.tags-scroll {
    max-height: 200px;
    overflow-y: auto;
}

.tags-scroll .form-check {
    margin: 8px 0;
}

.tags-scroll .form-check:hover {
    background-color: rgba(0,0,0,0.05);
    border-radius: 4px;
}

.dropdown-menu input[type="text"] {
    border-radius: 4px;
}

.dropdown-menu .btn-sm {
    padding: 0.25rem 0.75rem;
}
</style>