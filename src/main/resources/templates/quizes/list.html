<!-- Thông báo lỗi -->
<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Thông báo thành công -->
<div th:if="${successMessage}" class="alert alert-primary alert-dismissible fade show" role="alert">
    <i class="bi bi-info-circle-fill"></i>
    <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="container-fluid px-5 flex-grow-1">
    <h1 class="text-center">Quizes</h1>
    <div>
        <div>
            <a th:href="@{/}" class="btn btn-outline-primary btn-sm" style="margin-bottom: 15px;">
                <i class="bi bi-arrow-left-short"></i> Back
            </a>
        </div>
        <div class="d-flex align-items-center mb-3">
            <div class="flex-fill">
                <!-- Search Form -->
                <form action="/quizes" method="get" class="d-flex gap-2" id="searchForm">
                    <div class="d-flex gap-2">
                        <!-- Course Filter -->
                        <select id="course" name="course" class="form-select" style="width: 200px;">
                            <option value="">-- Select a Course --</option>
                            <option
                                    th:each="course : ${courses}"
                                    th:value="${course.id}"
                                    th:text="${course.name}"
                                    th:selected="${param.course != null and param.course[0] == course.id.toString()}"
                            >
                            </option>
                        </select>

                        <!-- Tag Filter -->
                        <div class="dropdown" style="width: 200px;">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="tagFilterButton" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-tags me-1"></i>
                                <span id="tagFilterText">Select Tags</span>
                            </button>
                            <ul class="dropdown-menu w-100 shadow" aria-labelledby="tagFilterButton">
                                <!-- Search box for tags -->
                                <li class="px-3 py-2 border-bottom">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" class="form-control form-control-sm"
                                               id="searchTags"
                                               placeholder="Search tags">
                                    </div>
                                </li>
                                <!-- Tags list -->
                                <li>
                                    <div class="tags-scroll px-3 py-2">
                                        <div id="tagsContainer">
                                            <!-- Tags will be loaded here -->
                                            <div class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span class="ms-2">Loading tags...</span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <!-- Footer -->
                                <li class="px-3 py-2 border-top bg-light d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary flex-fill" onclick="clearAllTags()">
                                        <i class="bi bi-x-circle me-1"></i>Clear
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary flex-fill" onclick="applyTagFilter()">
                                        <i class="bi bi-check-circle me-1"></i>Apply
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <!-- Search Input -->
                        <input type="text" class="form-control" name="searchQuery" th:value="${searchQuery}"
                               placeholder="Search by quiz name" aria-label="Search" style="width: 200px;">

                        <!-- Hidden input for tags -->
                        <input type="hidden" name="tags" id="selectedTags">

                        <button class="btn btn-outline-secondary" type="submit" onclick="return prepareSearch()">
                            <i class="bi bi-search"></i>
                        </button>

                        <!-- Thêm nút Clear All -->
                        <button id="clearAllFilters" type="button" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-x-circle me-1"></i> Clear All
                        </button>
                    </div>
                </form>
            </div>
            <div>
                <th:block th:unless="${isStudent}">
                    <a href="/quizes/print" class="btn btn-outline-secondary me-2" target="_blank">
                        <i class="bi bi-printer"></i> Print
                    </a>
                    <a href="quizes/export" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-file-earmark-excel"></i> Export
                    </a>
                    <a href="tools" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-repeat"></i> Convert
                    </a>
                    <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#importModal">
                        <i class="bi bi-upload"></i> Import
                    </button>
                    <a href="/quizes/create" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create New Quiz
                    </a>
                </th:block>

                <!-- Dashboard buttons based on role -->
                <th:block th:if="${isStudent}">
                    <!-- Student Dashboard -->
                    <a href="#" class="btn btn-outline-info me-2" id="studentDashboardBtn">
                        <i class="bi bi-graph-up"></i> My Dashboard
                    </a>
                </th:block>
                <th:block th:unless="${isStudent}">
                    <!-- Admin Dashboard -->
                    <a th:href="@{/quizes/admin/dashboard}" class="btn btn-outline-dark me-2">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </th:block>
            </div>
        </div>
        <div class="d-flex align-items-center mb-3">
            <button id="toggleView" class="btn btn-primary btn-sm">
                <i class="bi bi-table"></i> Switch to Table View
            </button>
        </div>
        <div id="cardView" class="row">
            <div th:each="quize : ${quizes}" class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm" th:data-quiz-id="${quize.getId()}">
                    <div class="card-body">
                        <h5 class="card-title" th:text="${quize.getName()}"></h5>
                        <p class="card-text text-muted" th:text="${quize.getDescription()}"></p>
                        <!-- Hiển thị tags -->
                        <div class="mb-2 tag-container">
                            <th:block th:if="${not #lists.isEmpty(quize.getTags())}">
                                <span th:each="tag, tagStat : ${quize.getTags()}" th:if="${tagStat.index < 2}"
                                      class="badge bg-primary me-1 mb-1" th:text="${tag.name}"></span>
                                <span th:if="${quize.getTags().size() > 2}" class="badge bg-secondary more-tags me-1 mb-1">
                                    +<span th:text="${quize.getTags().size() - 2}"></span>
                                    <div class="tag-tooltip">
                                        <span th:each="tag, tagStat : ${quize.getTags()}" th:if="${tagStat.index >= 2}"
                                              class="badge bg-primary me-1 mb-1" th:text="${tag.name}"></span>
                                    </div>
                                </span>
                            </th:block>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Attempts:</strong> <span th:text="${quize.getAttemptLimit()}"></span></li>
                            <li class="list-group-item"><strong>Start:</strong> <span th:text="${#temporals.format(quize.getStartTime(), 'dd-MM-yyyy HH:mm:ss')}"></span></li>
                            <li class="list-group-item"><strong>End:</strong> <span th:text="${#temporals.format(quize.getEndTime(), 'dd-MM-yyyy HH:mm:ss')}"></span></li>
                            <li class="list-group-item"><strong>Status:</strong> <span th:text="${quize.getQuizType()}"></span></li>
                        </ul>
                        <div class="mt-3 d-flex gap-2">
                            <th:block th:unless="${isStudent}">
                                <a th:href="@{'/quizes/edit/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a th:href="@{'/quizes/detail/' + ${quize.getId()}}" class="btn btn-outline-primary btn-sm" title="Detail">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                                <a href="#" class="btn btn-outline-danger btn-sm"
                                   th:onclick="'deleteQuiz(' + ${quize.getId()} + '); return false;'" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </th:block>

                            <!-- Participants button available for all roles -->
                            <a th:href="@{'/quizes/participants/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Participants">
                                <i class="bi bi-person-circle"></i>
                            </a>

                            <!-- Show Apply button only for STUDENT when quiz is OPEN -->
                            <th:block th:if="${isStudent}">
                                <form th:action="@{'/quizes/apply/' + ${quize.id}}" method="post"
                                      th:if="${quize.getQuizType().name() == 'OPEN'}"
                                      onsubmit="return confirm('Do you want to join this quiz?');"
                                      class="d-inline-block ms-auto">
                                    <button type="submit" class="btn btn-outline-primary btn-sm d-flex align-items-center w-100" title="Apply">
                                        <i class="bi bi-caret-right-fill"></i> Apply
                                    </button>
                                </form>
                            </th:block>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tableView" class="scrollable-table">
            <table class="table table-bordered">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th class="text-center">#</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Tags</th>
                    <th>Attempt</th>
                    <th>Time Start</th>
                    <th>Time End</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:data-quiz-id="${quize.getId()}" th:each="quize, iterStat : ${quizes}">
                    <td class="text-center" th:text="${iterStat.index + 1}"></td>
                    <td th:text="${quize.getName()}"></td>
                    <td th:text="${quize.getDescription()}"></td>
                    <td>
                        <div class="tag-container">
                            <th:block th:if="${not #lists.isEmpty(quize.getTags())}">
                                <span th:each="tag, tagStat : ${quize.getTags()}" th:if="${tagStat.index < 2}"
                                      class="badge bg-primary me-1" th:text="${tag.name}"></span>
                                <span th:if="${quize.getTags().size() > 2}" class="badge bg-secondary more-tags me-1">
                                    +<span th:text="${quize.getTags().size() - 2}"></span>
                                    <div class="tag-tooltip">
                                        <span th:each="tag, tagStat : ${quize.getTags()}" th:if="${tagStat.index >= 2}"
                                              class="badge bg-primary me-1 mb-1" th:text="${tag.name}"></span>
                                    </div>
                                </span>
                            </th:block>
                        </div>
                    </td>
                    <td th:text="${quize.getAttemptLimit()}"></td>
                    <td th:text="${#temporals.format(quize.getStartTime(), 'dd-MM-yyyy HH:mm:ss')}"></td>
                    <td th:text="${#temporals.format(quize.getEndTime(), 'dd-MM-yyyy HH:mm:ss')}"></td>
                    <td th:text="${quize.getQuizType()}"></td>
                    <td class="d-flex align-items-center gap-1">
                        <th:block th:unless="${isStudent}">
                            <a th:href="@{'/quizes/edit/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a th:href="@{'/quizes/detail/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Detail">
                                <i class="bi bi-info-circle"></i>
                            </a>
                            <a href="#" class="btn btn-outline-danger btn-sm"
                               th:onclick="'deleteQuiz(' + ${quize.getId()} + '); return false;'" title="Delete">
                                <i class="bi bi-trash"></i>
                            </a>
                        </th:block>

                        <!-- Participants button available for all roles -->
                        <a th:href="@{'/quizes/participants/' + ${quize.getId()}}" class="btn btn-outline-secondary btn-sm" title="Participants">
                            <i class="bi bi-person-circle"></i>
                        </a>

                        <!-- Show Apply/Closed buttons only for STUDENT -->
                        <th:block th:if="${isStudent}">
                            <form th:action="@{'/quizes/apply/' + ${quize.id}}" method="post"
                                  th:if="${quize.getQuizType().name() == 'OPEN'}"
                                  onsubmit="return confirm('Do you want to join this quiz?');">
                                <button type="submit" class="btn btn-outline-primary btn-sm d-flex align-items-center" title="Apply">
                                    <i class="bi bi-caret-right-fill"></i> Apply
                                </button>
                            </form>

                            <button type="button" class="btn btn-outline-secondary btn-sm d-flex align-items-center" title="Closed" disabled
                                    th:if="${quize.getQuizType().name() == 'CLOSE'}">
                                <i class="bi bi-caret-right-fill"></i> Closed
                            </button>
                        </th:block>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="row justify-content-center">
            <div class="pagination col-4 justify-content-center pe-0" th:if="${totalPages > 0}">
                <ul class="pagination">
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${0}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course}, tags=${param.tags})}"><<</a>
                    </li>

                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${currentPage - 1}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course}, tags=${param.tags})}"><</a>
                    </li>

                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                        th:classappend="${currentPage == i} ? 'active'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${i}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course}, tags=${param.tags})}"
                           th:text="${i + 1}"></a>
                    </li>

                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${currentPage + 1}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course}, tags=${param.tags})}">></a>
                    </li>

                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/quizes(page=${totalPages - 1}, pageSize=${pageSize}, searchQuery=${searchQuery}, course=${param.course}, tags=${param.tags})}">>></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Only show import modal for non-students -->
<th:block th:unless="${isStudent}">
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">Import Roles from Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Import form -->
                    <form method="post" enctype="multipart/form-data" th:action="@{/quizes/modal}">
                        <div>
                            <label for="course" class="form-label fw-bold ">Select Course</label>
                            <select id="course" name="course" class="form-select" onchange="reloadPage()">
                                <option value="">-- Select a Course --</option>
                                <option
                                        th:each="course : ${courses}"
                                        th:value="${course.name}"
                                        th:text="${course.name}"
                                >
                                </option>
                            </select>
                        </div>

                        <div>
                            <label for="fileType" class="form-label fw-bold ">Select File Type</label>
                            <select id="fileType" name="fileType" class="form-select" onchange="reloadPage()" required>
                                <option value="">-- Select file type --</option>
                                <option
                                        th:each="fileType : ${fileTypes}"
                                        th:value="${fileType}"
                                        th:text="${fileType}"
                                        th:selected="${fileType==chosenType}"
                                >
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="file" class="form-label">Choose File</label>
                            <input type="file" name="file" id="file" class="form-control" required>
                            <p class="mt-2 text-success" th:if="${chosenFile}">
                                Chosen file: <span th:text="${chosenFile}"></span>
                            </p>
                        </div>
                        <button type="submit" name="action" value="import" class="btn btn-primary">Import</button>
                        <button type="submit" name="action" value="review" class="btn btn-primary">Review file</button>
                        <a href="/quizes/download-template" class="btn btn-primary">
                            <i class="bi bi-download"></i> Download Template
                        </a>
                    </form>
                    <div th:if="${error}" class="alert alert-danger">
                        <p th:text="${error}"></p>
                    </div>

                </div>
            </div>
        </div>
    </div>
</th:block>

<div class="modal fade" id="confirmImportModal" tabindex="-1" aria-labelledby="confirmImportLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmImportLabel">Confirm Import</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="importMessage">The file contains <strong id="questionCount"></strong> questions. Do you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmImportButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Initialize all dropdowns with the new Bootstrap 5 syntax
    var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
    var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
        return new bootstrap.Dropdown(dropdownToggleEl);
    });

    let viewMode = localStorage.getItem("viewMode") || "table";
    updateView(viewMode);

    document.getElementById("toggleView").addEventListener("click", function () {
        viewMode = (viewMode === "table") ? "card" : "table";
        localStorage.setItem("viewMode", viewMode);
        updateView(viewMode);
    });

    // Improved dropdown handling for tags
    const tagFilterButton = document.getElementById('tagFilterButton');
    if (tagFilterButton) {
        // Proper selection of dropdown menu
        const dropdownMenu = tagFilterButton.nextElementSibling;

        if (dropdownMenu) {
            // Prevent clicks in dropdown from closing it
            dropdownMenu.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    e.stopPropagation();
                }
            });

            // Fix checkbox click handling
            const checkboxes = dropdownMenu.querySelectorAll('.tag-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation();
                    handleTagChange();
                });
            });

            // Properly handle Apply and Clear buttons
            const applyBtn = dropdownMenu.querySelector('button[onclick="applyTagFilter()"]');
            if (applyBtn) {
                // Replace onclick with clean event listener
                applyBtn.removeAttribute('onclick');
                applyBtn.addEventListener('click', function() {
                    applyTagFilter();
                });
            }

            const clearBtn = dropdownMenu.querySelector('button[onclick="clearAllTags()"]');
            if (clearBtn) {
                // Replace onclick with clean event listener
                clearBtn.removeAttribute('onclick');
                clearBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    clearAllTags();
                });
            }
        }
    }

    // Fix course dropdown if present
    const courseDropdown = document.getElementById('course');
    if (courseDropdown) {
        courseDropdown.addEventListener('change', function() {
            // Submit form when course selection changes
            document.getElementById('searchForm').submit();
        });
    }

    // Tải tất cả tag ban đầu
    fetchAllTags();

    // Initialize selected tags text
    updateSelectedTagsText();

    // Xử lý nút Clear All Filters
    const clearAllFiltersBtn = document.getElementById('clearAllFilters');
    if (clearAllFiltersBtn) {
        clearAllFiltersBtn.addEventListener('click', function() {
            clearAllFilters();
        });
    }

    // Restore the student dashboard button functionality
    const studentDashboardBtn = document.getElementById('studentDashboardBtn');
    const currentUserId = document.getElementById('currentUserId');

    if (studentDashboardBtn && currentUserId) {
        studentDashboardBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = `/quizes/dashboard/${currentUserId.value}`;
        });
    }

    // Khởi tạo chức năng tìm kiếm tag
    initializeTagSearch();
});

// Lấy tất cả tag từ server và lưu trữ
function fetchAllTags() {
    fetch('/quizes/tags', {
        headers: {
            'Accept': 'application/json'
        },
        credentials: 'same-origin' // Add credentials to handle authentication
    })
    .then(handleResponse)
    .then(tags => {
        window.allTags = Array.isArray(tags) ? tags : [tags];
        // Update the tags in the dropdown
        const tagsContainer = document.getElementById('tagsContainer');
        if (tagsContainer) {
            renderTagsInContainer(tags);
        }
    })
    .catch(error => {
        console.error('Failed to fetch tags:', error);
        // Show error in the tags container if it exists
        const tagsContainer = document.getElementById('tagsContainer');
        if (tagsContainer) {
            tagsContainer.innerHTML = `
                <div class="alert alert-danger mt-2">
                    <i class="bi bi-exclamation-circle"></i> Failed to load tags.
                    Please refresh the page or try again later.
                </div>`;
        }
    });
}

// Helper function to render tags in the container
function renderTagsInContainer(tags, selectedTagIds = []) {
    const tagsContainer = document.getElementById('tagsContainer');
    if (!tagsContainer) return;

    tagsContainer.innerHTML = '';

    if (!tags || tags.length === 0) {
        tagsContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No tags found
            </div>`;
        return;
    }

    // Lấy các tag đã chọn từ URL nếu không có selectedTagIds
    if (!selectedTagIds.length) {
        const urlParams = new URLSearchParams(window.location.search);
        selectedTagIds = urlParams.getAll('tags');
    }

    tags.forEach(tag => {
        if (tag && tag.id) {
            const isChecked = selectedTagIds.includes(tag.id.toString());
            tagsContainer.innerHTML += `
                <div class="form-check mb-2">
                    <input class="form-check-input tag-checkbox"
                           type="checkbox"
                           id="tag-${tag.id}"
                           name="tagIds"
                           value="${tag.id}"
                           onchange="handleTagChange()"
                           ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="tag-${tag.id}">${tag.name}</label>
                </div>`;
        }
    });

    // Cập nhật text hiển thị số lượng tag đã chọn
    updateSelectedTagsText();
}

function handleResponse(response) {
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
}

function handleTagChange() {
    updateSelectedTagsText();
}

function applyTagFilter() {
    // Lấy tất cả tag đã chọn
    const selectedTags = document.querySelectorAll('.tag-checkbox:checked');
    const selectedTagIds = Array.from(selectedTags).map(checkbox => checkbox.value);

    // Xóa tất cả các input hidden cũ của tags nếu có
    document.querySelectorAll('input[name="tags"]').forEach(input => {
        input.remove();
    });

    // Tạo một input hidden mới cho mỗi tag ID đã chọn
    const searchForm = document.getElementById('searchForm');
    selectedTagIds.forEach(tagId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'tags';
        input.value = tagId;
        searchForm.appendChild(input);
    });

    // Submit form
    searchForm.submit();
}

function clearAllTags() {
    document.querySelectorAll('.tag-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedTagsText();
    document.getElementById('selectedTags').value = '';
}

function prepareSearch() {
    // Đảm bảo giá trị tags được cập nhật trước khi submit
    const selectedTags = document.querySelectorAll('.tag-checkbox:checked');
    const selectedTagIds = Array.from(selectedTags).map(checkbox => checkbox.value);

    // Xóa tất cả các input hidden cũ của tags nếu có
    document.querySelectorAll('input[name="tags"]').forEach(input => {
        input.remove();
    });

    // Tạo một input hidden mới cho mỗi tag ID đã chọn
    const searchForm = document.getElementById('searchForm');
    selectedTagIds.forEach(tagId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'tags';
        input.value = tagId;
        searchForm.appendChild(input);
    });

    return true;
}

function updateSelectedTagsText() {
    const tagFilterTextElement = document.getElementById('tagFilterText');
    const selectedTags = document.querySelectorAll('.tag-checkbox:checked');
    const selectedCount = selectedTags.length;

    if (selectedCount === 0) {
        tagFilterTextElement.innerHTML = 'Select Tags';
        tagFilterButton.querySelector('i').className = 'bi bi-tags me-1';
    } else {
        tagFilterTextElement.innerHTML = `${selectedCount} selected`;
        tagFilterButton.querySelector('i').className = 'bi bi-tags-fill me-1';
    }
}

function updateView(mode) {
    let toggleButton = document.getElementById("toggleView");
    if (mode === "table") {
        document.getElementById("tableView").style.display = "block";
        document.getElementById("cardView").style.display = "none";
        toggleButton.innerHTML = '<i class="bi bi-grid"></i> Switch to Card View';
        toggleButton.classList.replace("btn-primary", "btn-secondary");
    } else {
        document.getElementById("tableView").style.display = "none";
        document.getElementById("cardView").style.display = "flex";
        toggleButton.innerHTML = '<i class="bi bi-table"></i> Switch to Table View';
        toggleButton.classList.replace("btn-secondary", "btn-primary");
    }
}

function clearAllFilters() {
    // Xóa giá trị course
    document.getElementById('course').value = '';

    // Xóa giá trị search tags và bỏ chọn tất cả các checkbox
    document.getElementById('searchTags').value = '';
    document.querySelectorAll('.tag-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    // Cập nhật text của tag filter button
    updateSelectedTagsText();

    // Xóa giá trị trong ô search quiz
    const searchInput = document.querySelector('input[name="searchQuery"]');
    if (searchInput) {
        searchInput.value = '';
    }

    // Xóa tất cả các input hidden của tags
    document.querySelectorAll('input[name="tags"]').forEach(input => {
        input.remove();
    });

    // Submit form để reset lại trang với các giá trị đã xóa
    document.getElementById('searchForm').submit();
}

function initializeTagSearch() {
    const searchInput = document.getElementById('searchTags');
    if (searchInput) {
        // Thêm debounce để tránh gọi API quá nhiều lần
        let debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchTags(this.value);
            }, 300); // Đợi 300ms sau khi người dùng ngừng gõ
        });
    }
}

// Cập nhật hàm searchTags để nhận giá trị tìm kiếm
function searchTags(query) {
    const tagsContainer = document.getElementById('tagsContainer');
    if (!tagsContainer) return;

    // Hiển thị trạng thái loading
    tagsContainer.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split me-2"></i> Loading...</div>';

    // Nếu không có query, lấy tất cả tags
    if (!query || query.trim() === '') {
        fetchAllTags();
        return;
    }

    // Tìm kiếm tags dựa trên query
    fetch(`/quizes/tags/search?name=${encodeURIComponent(query.trim())}`, {
        headers: {
            'Accept': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(tags => {
        // Lưu lại các tag đã chọn trước đó
        const selectedTags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);

        // Render kết quả tìm kiếm
        renderTagsInContainer(tags, selectedTags);
    })
    .catch(error => {
        console.error('Error searching tags:', error);
        tagsContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-circle me-2"></i>
            Error searching tags. Please try again.
        </div>`;
    });
}

function deleteQuiz(quizId) {
    if (confirm('Are you sure?')) {
        fetch(`/quizes/delete/${quizId}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            // Kiểm tra nếu response là redirect (thành công) hoặc JSON (lỗi)
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                return response.json().then(data => ({ isJson: true, data }));
            } else {
                return { isJson: false, status: response.status };
            }
        })
        .then(result => {
            if (!result.isJson || (result.isJson && result.data.success)) {
                // Xóa thành công (redirect hoặc JSON success)
                // Remove quiz from DOM
                const quizElements = document.querySelectorAll(`[data-quiz-id="${quizId}"]`);
                quizElements.forEach(element => element.remove());

                // Show success toast
                const toastHtml = `
                    <div class="toast-container position-fixed top-0 start-0 p-3" style="z-index: 9999">
                        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="toast-header bg-success text-white">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <strong class="me-auto">Success</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">
                                Quiz has been successfully deleted
                            </div>
                        </div>
                    </div>
                `;

                // Remove any existing toast
                const existingToast = document.querySelector('.toast-container');
                if (existingToast) {
                    existingToast.remove();
                }

                document.body.insertAdjacentHTML('beforeend', toastHtml);

                // Auto-hide after 3 seconds
                setTimeout(() => {
                    const toast = document.querySelector('.toast-container .toast');
                    if (toast) {
                        const bsToast = new bootstrap.Toast(toast);
                        bsToast.hide();
                    }
                }, 3000);
            } else {
                // Error case (JSON error response)
                const toastHtml = `
                    <div class="toast-container position-fixed top-0 start-0 p-3" style="z-index: 9999">
                        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="toast-header bg-danger text-white">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong class="me-auto">Error</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">
                                ${result.data.message || 'Unable to delete a quiz that already has assignment data.'}
                            </div>
                        </div>
                    </div>
                `;

                // Remove any existing toast
                const existingToast = document.querySelector('.toast-container');
                if (existingToast) {
                    existingToast.remove();
                }

                document.body.insertAdjacentHTML('beforeend', toastHtml);

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    const toast = document.querySelector('.toast-container .toast');
                    if (toast) {
                        const bsToast = new bootstrap.Toast(toast);
                        bsToast.hide();
                    }
                }, 5000);
            }
        })
        .catch(error => {
            console.error('Error deleting quiz:', error);
            // Show error toast instead of alert
            const toastHtml = `
                <div class="toast-container position-fixed top-0 start-0 p-3" style="z-index: 9999">
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-danger text-white">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong class="me-auto">Error</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            Error occurred while deleting quiz. Please try again later.
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing toast
            const existingToast = document.querySelector('.toast-container');
            if (existingToast) {
                existingToast.remove();
            }

            document.body.insertAdjacentHTML('beforeend', toastHtml);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                const toast = document.querySelector('.toast-container .toast');
                if (toast) {
                    const bsToast = new bootstrap.Toast(toast);
                    bsToast.hide();
                }
            }, 5000);
        });
    }
}
</script>

<style>
/* Reset và cơ bản */
.tag-container {
    position: relative;
    display: inline-flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 4px;
    max-width: 100%;
}

/* Bootstrap dropdown fixes */
.dropdown-menu {
    max-height: 400px;
    overflow-y: auto;
}

.tags-scroll {
    max-height: 250px;
    overflow-y: auto;
}

/* Style cho badges */
.badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    margin: 0;
    white-space: nowrap;
}

.badge.bg-primary {
    background-color: #0d6efd !important;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
}

/* More tags button */
.more-tags {
    cursor: pointer;
    position: relative;
    display: inline-flex;
    align-items: center;
    padding: 0.35em 0.65em;
    font-size: 0.75rem;
    z-index: 1;
}

/* Tooltip styling */
.tag-tooltip {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    z-index: 1040;
    min-width: max-content;
    max-width: 300px;

    /* Positioning */
    left: 100%;
    top: 0;
    margin-left: 8px;
}

/* Tooltip arrow */
.tag-tooltip:before,
.tag-tooltip:after {
    content: '';
    position: absolute;
    left: -6px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
}

.tag-tooltip:before {
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-right: 6px solid #dee2e6;
    margin-left: -1px;
}

.tag-tooltip:after {
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    border-right: 5px solid white;
}

/* Show tooltip on hover */
.more-tags:hover .tag-tooltip {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

/* Badges inside tooltip */
.tag-tooltip .badge {
    margin: 2px;
}

/* Table specific styles */
table .tag-container {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    max-width: 100%;
}

/* Card specific styles */
.card .tag-container {
    margin-bottom: 0.5rem;
}

/* Modal z-index handling */
.modal {
    z-index: 1050 !important;
}

.modal-backdrop {
    z-index: 1040 !important;
}

/* Hide tooltips when modal is shown */
.modal.show ~ * .tag-tooltip {
    display: none !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .tag-tooltip {
        position: absolute;
        left: auto;
        right: 0;
        top: 100%;
        margin-top: 8px;
        margin-left: 0;
    }

    .tag-tooltip:before,
    .tag-tooltip:after {
        left: auto;
        right: 10px;
        top: -6px;
        transform: translateY(0);
    }

    .tag-tooltip:before {
        border: 6px solid transparent;
        border-bottom-color: #dee2e6;
    }

    .tag-tooltip:after {
        border: 5px solid transparent;
        border-bottom-color: white;
        top: -5px;
    }
}

/* Fix for table cell overflow */
table td {
    position: relative;
    max-width: 200px;
    overflow: visible;
}

/* Ensure proper stacking context */
thead.table-light {
    position: sticky;
    top: 0;
    z-index: 1;
    background: white;
}
</style>

<!-- Add back the hidden input for currentUserId -->
<input type="hidden" id="currentUserId" th:value="${currentUserId}">

<script>
        document.addEventListener("DOMContentLoaded", function () {
            let urlParams = new URLSearchParams(window.location.search);
            let openModal = urlParams.get("openModal");

            if (openModal) {
                let modalElement = document.getElementById(openModal);
                if (modalElement) {
                    let modal = new bootstrap.Modal(modalElement);
                    modal.show();
                }
            }
        });
    </script>