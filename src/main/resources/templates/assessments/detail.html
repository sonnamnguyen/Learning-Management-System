<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Assessment Detail</title>
    <link rel="stylesheet" href="/style.css"/>
    <!-- Bootstrap & Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

    <style>
        /* Breadcrumb styling */
        .breadcrumb {
            display: flex;
            flex-wrap: wrap;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            list-style: none;
            background-color: transparent;
            border-radius: 0.25rem;
        }
        .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
            padding: 0 0.5rem;
            color: #6c757d;
        }
        /* Scrollable container if needed */
        .scrollable-table {
            overflow: auto;
            max-height: 650px;
        }
        /* Scroll-to-top button */
        #scrollToTopButton {
            position: fixed;
            bottom: 3vh;
            right: 20px;
            display: none;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            outline: none;
            border-radius: 50%;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            justify-content: center;
            align-items: center;
            opacity: 0.8;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 80;
        }
        #scrollToTopButton:hover {
            transform: scale(1.2);
            opacity: 1;
            background: linear-gradient(45deg, #2575fc, #6a11cb);
        }
        @media (max-width: 1200px) {
            .scrollable-table { max-height: 500px; }
        }
        @media (max-width: 768px) {
            .scrollable-table { max-height: 400px; }
        }
        @media (max-width: 576px) {
            .scrollable-table { max-height: 300px; }
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
            <li class="breadcrumb-item"><a th:href="@{/assessments}">Assessment List</a></li>
            <li class="breadcrumb-item active" aria-current="page">Assessment Detail</li>
        </ol>
    </nav>

    <h1 class="text-center mt-2" th:text="${assessment.title}">Assessment Title</h1>

    <!-- Assessment Details Section -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0" th:text="${assessment.title}">Assessment Title</h2>
            <div>
                <a th:href="@{/assessments/edit/{id}(id=${assessment.id})}" class="btn btn-outline-secondary">Edit</a>
                <a th:href="@{/assessments}" class="btn btn-secondary ml-2">Back to Assessments</a>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Left Column: Course and Type -->
                <div class="col-md-6">
                    <p>
                        <strong>Course:</strong> <span th:text="${assessment.course.name}">Course Name</span><br/>
                        <strong>Assessment Type:</strong> <span th:text="${assessment.assessmentType.name}">Type</span>
                    </p>
                </div>
                <!-- Right Column: Duration and Passing Score -->
                <div class="col-md-6">
                    <p>
                        <strong>Duration:</strong> <span th:text="${assessment.timeLimit}">0</span> Minutes<br/>
                        <strong>Minimum Passing Score:</strong> <span th:text="${assessment.qualifyScore}">0</span>%
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Two-Column Layout for Exercises and Questions -->
    <div class="row mb-4">
        <!-- Exercises Section -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Exercises</h3>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <ul class="list-group">
                        <li class="list-group-item" th:each="exercise : ${assessment.exercises}">
                            <a th:href="@{/exercises/detail/{exerciseId}(exerciseId=${exercise.id})}" target="_blank" th:text="${exercise.name}">Exercise Name</a>
                        </li>
                        <li class="list-group-item text-muted" th:if="${#lists.isEmpty(assessment.exercises)}">
                            No exercises assigned.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Questions Section -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Multiple Choice</h3>
                    <!-- View All Button opens modal -->
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#viewAllModal">View All</button>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <ul class="list-group">
                        <li class="list-group-item" th:each="question, iterStat : ${questions}">
                            <span th:text="${iterStat.count}"></span>. <span th:utext="${question.questionText}">Question text</span>
                        </li>
                        <li class="list-group-item text-muted" th:if="${#lists.isEmpty(questions)}">
                            No questions assigned.
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Modal for View All Questions with Answers -->
        <div class="modal fade" id="viewAllModal" tabindex="-1" aria-labelledby="viewAllModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewAllModalLabel">All Multiple Choice Questions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="scrollable-table">
                            <div th:each="question, iterStat : ${questions}" class="mb-4 border-bottom pb-3">
                                <p class="fw-bold">
                                    <strong th:text="${iterStat.count}"></strong>.
                                    <span th:text="${question.questionText}">Question text</span>
                                </p>
                                <ul class="list-group">
                                    <li class="list-group-item"
                                        th:each="ans : ${questionAnswerOptionsMap[question.id] != null ? questionAnswerOptionsMap[question.id] : T(java.util.Collections).emptyList()}">
                                        <span th:text="${ans.optionText}">Answer Option Text</span>
                                        <span th:if="${ans.isCorrect}" class="badge bg-success ms-2">Correct</span>
                                    </li>
                                    <li class="list-group-item text-muted" th:if="${#lists.isEmpty(questionAnswerOptionsMap[question.id])}">
                                        No answers assigned.
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registered Attempts Section (non-AJAX pagination) -->
    <div class="card" id="registeredAttemptsContainer">
        <div class="card-header">
            <h3>Registered Attempts</h3>
        </div>
        <div class="card-body">
            <table class="table table-sm table-bordered">
                <thead class="thead-light">
                <tr>
                    <th>#</th>
                    <th>Candidate</th>
                    <th>Email</th>
                    <th>Invitation Date</th>
                    <th>Quiz Score</th>
                    <th>Assignment Score</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="attempt, iterStat : ${registeredAttempts}">
                    <td th:text="${iterStat.count}"></td>
                    <td th:text="${attempt.candidateUsername}"></td>
                    <td th:text="${attempt.email}"></td>
                    <td th:text="${#temporals.format(attempt.attemptDate, 'yyyy-MM-dd HH:mm')}"></td>
                    <td th:text="${attempt.scoreQuiz}"></td>
                    <td th:text="${attempt.scoreAss}"></td>
                    <td>
                        <a th:href="@{/assessments/viewReport/{assessmentId}(assessmentId=${assessment.id}, attempt-id=${attempt.id})}" class="btn btn-sm btn-outline-primary">View</a>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(registeredAttempts)}">
                    <td colspan="7" class="text-center text-muted">No attempts yet.</td>
                </tr>
                </tbody>
            </table>
            <nav aria-label="Registered Attempts Pagination" th:if="${registeredAttemptsPage.totalPages > 0}">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${registeredAttemptsPage.number == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageReg=0, pageInv=${invitedCandidatesPage.number}, searchEmail=${searchEmail})}">First</a>
                    </li>
                    <li class="page-item" th:classappend="${registeredAttemptsPage.number == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageReg=${registeredAttemptsPage.number - 1}, pageInv=${invitedCandidatesPage.number}, searchEmail=${searchEmail})}">Previous</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, registeredAttemptsPage.totalPages - 1)}"
                        th:classappend="${registeredAttemptsPage.number == i} ? 'active'">
                        <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageReg=${i}, pageInv=${invitedCandidatesPage.number}, searchEmail=${searchEmail})}" th:text="${i + 1}">1</a>
                    </li>
                    <li class="page-item" th:classappend="${registeredAttemptsPage.number == registeredAttemptsPage.totalPages - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageReg=${registeredAttemptsPage.number + 1}, pageInv=${invitedCandidatesPage.number}, searchEmail=${searchEmail})}">Next</a>
                    </li>
                    <li class="page-item" th:classappend="${registeredAttemptsPage.number == (registeredAttemptsPage.totalPages - 1)} ? 'disabled'">
                        <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageReg=${registeredAttemptsPage.totalPages - 1}, pageInv=${invitedCandidatesPage.number}, searchEmail=${searchEmail})}" th:text="'Last'">Last</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- All Invited Candidates Section (non-AJAX pagination) -->
    <div class="card mt-4" th:if="${currentUser != null and (currentUser.roles.?[id == 1].size() > 0 or currentUser.roles.?[name=='SUPERADMIN'].size() > 0)}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>All Invited Candidates</h3>
            <!-- Search Bar -->
            <form id="searchCandidatesForm" th:action="@{/assessments/detail/{id}(id=${assessment.id})}" method="get" class="d-flex">
                <input type="hidden" name="pageReg" th:value="${registeredAttemptsPage.number}"/>
                <input type="hidden" name="pageInv" value="0"/>
                <input type="text" name="searchEmail" placeholder="Search email..." class="form-control" style="max-width: 200px; margin-right: 10px;" th:value="${searchEmail}"/>
                <button class="btn btn-primary" type="submit"><i class="fa fa-search"></i></button>
            </form>
        </div>
        <div class="card-body">
            <div id="invitedCandidatesContainer">
                <table class="table table-sm table-bordered">
                    <thead class="thead-light">
                    <tr>
                        <th>#</th>
                        <th>Email</th>
                        <th>Invitation Date</th>
                        <th>Expiration Date</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="candidate, stat : ${invitedCandidates}">
                        <td th:text="${stat.count}"></td>
                        <td th:text="${candidate.email}"></td>
                        <td th:text="${candidate.invitationDate}"></td>
                        <td th:text="${candidate.expirationDate}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(invitedCandidates)}">
                        <td colspan="4" class="text-center text-muted">No invited candidates yet.</td>
                    </tr>
                    </tbody>
                </table>
                <nav aria-label="Invited Candidates Pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:classappend="${invitedCandidatesPage.number == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageInv=0, pageReg=${registeredAttemptsPage.number}, searchEmail=${searchEmail})}">First</a>
                        </li>
                        <li class="page-item" th:classappend="${invitedCandidatesPage.number == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageInv=${invitedCandidatesPage.number - 1}, pageReg=${registeredAttemptsPage.number}, searchEmail=${searchEmail})}">Previous</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, invitedCandidatesPage.totalPages - 1)}"
                            th:classappend="${invitedCandidatesPage.number == i} ? 'active'">
                            <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageInv=${i}, pageReg=${registeredAttemptsPage.number}, searchEmail=${searchEmail})}" th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${invitedCandidatesPage.number == invitedCandidatesPage.totalPages - 1} ? 'disabled'">
                            <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageInv=${invitedCandidatesPage.number + 1}, pageReg=${registeredAttemptsPage.number}, searchEmail=${searchEmail})}">Next</a>
                        </li>
                        <li class="page-item" th:classappend="${invitedCandidatesPage.number == (invitedCandidatesPage.totalPages - 1)} ? 'disabled'">
                            <a class="page-link" th:href="@{/assessments/detail/{id}(id=${assessment.id}, pageInv=${invitedCandidatesPage.totalPages - 1}, pageReg=${registeredAttemptsPage.number}, searchEmail=${searchEmail})}" th:text="'Last'">Last</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Scroll to top button -->
    <button onclick="scrollToTop()" id="scrollToTopButton" title="Go to top">
        <i class="fas fa-arrow-up"></i>
    </button>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<script>
    // Scroll-to-top functionality
    window.onscroll = function () {
        const scrollToTopButton = document.getElementById("scrollToTopButton");
        if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
            scrollToTopButton.style.display = "flex";
        } else {
            scrollToTopButton.style.display = "none";
        }
    };

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>
