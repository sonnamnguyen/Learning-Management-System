<div class="container mt-4">
    <!-- Style-->
    <style>
        .custom-select_assessment-edit {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: none !important;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        .filter-icon_assessment-edit {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            pointer-events: none;
        }

        .custom-select-wrapper_assessment-edit {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .question-answers {
            width: 100%;
            display: none;
            margin-top: 10px;
        }
        .question-answers.show {
            display: block;
        }

        .custom-switch {
            width: 2.5rem;
            height: 1.4rem;
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }

        .custom-switch:checked {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
        }

        .d-flex.align-items-center {
            display: flex;
            align-items: center;
        }

        .form-check-input {
            transition: all 0.3s ease-in-out;
        }

        .btn-add-question:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .btn-add-question:active:not(:disabled) {
            transform: scale(0.95);
        }

        .btn-add-question:disabled {
            background-color: #a0aec0 !important;
            color: #e2e8f0 !important;
            cursor: not-allowed;
            transform: none;
        }

        #similarQuestionsModal .modal-dialog {
            max-width: 75vw;
        }

        #similarQuestionsModalBody {
            max-height: 60vh;
            overflow-y: auto;
        }

        td {
            white-space: nowrap;
        }

        .readonly-style {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>


    <form th:action="@{/assessments/update/{id}(id=${assessment.id})}" th:object="${assessment}" method="POST" id="assessment-form">

        <input type="hidden" id="assessmentId" th:value="${assessment.id}" name="id"/>
        <input type="hidden" id="newAddedQuestionsInput" name="newAddedQuestions">

        <div class="d-flex justify-content-between mb-3">
            <a id="backToList" th:href="@{/assessments}" style="text-decoration: none; color: #6c757d; transition: color 0.3s ease;"
               onmouseover="this.style.color='#343a40';"
               onmouseout="this.style.color='#6c757d';">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
            <div>
                <a id="previewAssessment" th:href="@{/assessments/{id}/preview(id=${assessment.id})}" class="mx-2"
                   style="text-decoration: none; color: #007bff; transition: color 0.3s ease;"
                   onmouseover="this.style.color='#0056b3';"
                   onmouseout="this.style.color='#007bff';">
                    <i class="fas fa-eye"></i> Preview Assessment
                </a>
                <span style="color: #ccc; margin: 0 10px;">|</span>
                <button id="saveAssessmentBtn" class="btn btn-success"
                        style="text-decoration: none; color: white; transition: background-color 0.3s ease;"
                        onmouseover="this.style.backgroundColor='#1e7e34';"
                        onmouseout="this.style.backgroundColor='#28a745';">
                    <i class="fas fa-save"></i> Save Assessment
                </button>
            </div>
        </div>

        <div class="col-md-8 mt-4 position-relative">
            <div class="position-relative">
                <!-- Title Display -->
                <h1 id="title-display" class="m-0 pe-4" th:text="${assessment.title}"></h1>

                <!-- Edit Icon (Top-Right Positioned) -->
                <a href="#" id="edit-title" class="position-absolute top-0 end-0"
                   style="text-decoration: none; color: #007bff;">
                    <i class="fas fa-edit"></i>
                </a>
            </div>

            <!-- Hidden Input Field -->
            <input id="title-input" type="text" name="title" class="form-control d-none mt-2"
                   placeholder="Enter assessment title" maxlength="255" th:value="${assessment.title}" required>

            <!-- Save Button (Appears Only in Edit Mode) -->
            <a href="#" id="save-title" class="d-none mt-2 d-inline-block"
               style="text-decoration: none; color: #28a745;">
                <i class="fas fa-save"></i> Save Title
            </a>

            <!-- Error Message for Duplicate Title -->
            <div id="duplicateTitleError" class="alert alert-danger mt-2 d-none"></div>

            <hr class="my-3">

            <!-- Created By Text with Highlighted Email -->
            <p class="text-muted">
                <th:block th:if="${updater != null}">
                    This assessment has been updated by
                    <span class="text-primary fw-bold fst-italic" th:text="${updater?.email}"></span>
                    at <span class="text-primary fw-bold fst-italic" th:text="${formattedUpdatedAt}"></span>
                </th:block>
                <th:block th:if="${updater == null}">
                    This assessment has been created by
                    <span class="text-primary fw-bold fst-italic" th:text="${creator?.email}"></span>
                    at <span class="text-primary fw-bold fst-italic" th:text="${formattedCreateAt}"></span>
                </th:block>
            </p>
        </div>

        <div class="card mb-1 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="assessmentType" class="form-label">Assessment Type</label>
                        <!--                        <input type="text" id="assessmentType" name="assessmentType" th:value="${assessment?.assessmentType}" class="form-control">-->
                        <div class="position-relative">
                            <select name="assessmentType" id="assessmentType" class="form-control" required>
                                <option th:each="type : ${assessmentTypes}"
                                        th:value="${type.id}"
                                        th:selected="${assessment?.assessmentType?.id == type.id}"
                                        th:text="${type.name}">
                                </option>
                            </select>
                            <i class="bi bi-chevron-down" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none;"></i>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="course" class="form-label">Course</label>
                        <!--                        <input type="text" id="course" name="course" th:value="${assessment?.course}" class="form-control">-->
                        <div class="position-relative">
                            <select name="course" id="course" class="form-control" required>
                                <option value="" disabled>Select a course</option>
                                <option th:each="c : ${courses}"
                                        th:value="${c.id}"
                                        th:selected="${assessment?.course?.id == c.id}"
                                        th:text="${c.name}">
                                </option>
                            </select>
                            <i class="bi bi-chevron-down" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercises/Questions/Settings Section -->
        <div class="card mb-4 shadow">
            <!--            <div class="card-header bg-secondary text-white">-->
            <!--                <h4>Exercises/Questions/Settings</h4>-->
            <!--            </div>-->
            <div class="card-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="exercises-tab" data-bs-toggle="tab" data-bs-target="#exercises" type="button" role="tab" aria-controls="exercises" aria-selected="true">Exercises</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab" aria-controls="questions" aria-selected="false">Questions</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Settings</button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="myTabContent">
                    <!-- Exercises Tab -->
                    <div class="tab-pane fade show active p-3" id="exercises" role="tabpanel" aria-labelledby="exercises-tab">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3 d-flex align-items-center">
                                    <div style="max-width: 150px; margin-right: 10px;">
                                        <div class="custom-select-wrapper_assessment-edit">
                                            <select name="language" id="id_language" class="form-select custom-select_assessment-edit">
                                                <option value="" class="text-muted fw-bold">All</option>
                                                <!-- Iterate over languages -->
                                                <option class="text-muted fw-bold"
                                                        th:each="language : ${languages}"
                                                        th:value="${language.id}"
                                                        th:text="${#strings.capitalize(language.language)}">
                                                </option>
                                            </select>
                                            <i class="bi bi-funnel filter-icon_assessment-edit"></i>

                                        </div>
                                    </div>
                                    <div class="search-container" style="display: flex; align-items: center; gap: 8px;">
                                        <input type="text" id="search-exercises" class="form-control" placeholder="Search for exercises...">
                                        <button id="search-btn" class="btn btn-primary">Search</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5 class="fw-bold text-dark border-bottom pb-1 mb-2">Exercises</h5>

                                <!-- Loading Spinner (Hidden by Default) -->
                                <div id="loading-spinner" class="text-center py-2" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>

                                <!-- Exercise List -->
                                <div id="exercise-list" class="list-group overflow-auto border" style="max-height: 300px;">
                                    <input type="hidden" name="exerciseIds" id="exerciseIds">

                                    <!-- Iterate over exercises -->
                                    <th:block th:each="exercise : ${exercises}">
                                        <div class="list-group-item exercise-item d-flex align-items-center"
                                             th:data-exercise-id="${exercise.id}"
                                             th:data-language-id="${exercise.language.id}"
                                             data-filtered="true">

                                            <input class="form-check-input me-2" type="checkbox" name="exercises"
                                                   th:value="${exercise.id}"
                                                   th:id="'exercise-' + ${exercise.id}"
                                                   th:checked="${selectedExercises != null and #lists.contains(selectedExercises, exercise.id)}">

                                            <label class="form-check-label" th:for="'exercise-' + ${exercise.id}" th:text="${exercise.name}"></label>

                                            <span class="badge rounded-pill bg-light text-dark small ms-auto border border-primary"
                                                  th:text="${#strings.capitalize(exercise.language.language)}"></span>

                                            <span class="exercise-description d-none" th:text="${exercise.description}"></span>

                                            <button type="button" class="btn btn-link text-secondary view-button ms-2"
                                                    onclick="toggleViewButton(this)">
                                                <i class="bi bi-eye-slash text-secondary"></i>
                                            </button>
                                        </div>
                                    </th:block>
                                </div>

                                <!-- No Results Message (Hidden by Default) -->
                                <div id="no-results-message" class="text-center py-2 text-danger fst-italic" style="display: none;">
                                    üö´ No exercises match your search. Try a different keyword!
                                </div>

                                <!-- Filtered Exercises List (Hidden by Default) -->
                                <div id="filtered-exercises" class="list-group overflow-auto border" style="max-height: 300px; display: none;"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-1 mb-2">
                                    <h5 class="fw-bold text-dark mb-0">Preview Selected Exercise</h5>
                                </div>
                                <div id="exercise-content" class="border p-2 overflow-auto" style="max-height: 300px;">
                                    <p>Select an exercise's icon from the list to preview its content here.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Tab -->
                    <div class="tab-pane fade" id="questions" role="tabpanel" aria-labelledby="questions-tab">
                        <div class="row">
                            <!-- Search Bar -->
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">üîç</span>
                                        <input type="text" id="search-questions" class="form-control" placeholder="Search for questions..." onkeyup="filterQuestions()">
                                    </div>
                                </div>
                            </div>

                            <!-- Multiple Choice Library -->
                            <div class="col-md-5">
                                <div class="shadow-sm hover-shadow">
                                    <div class="d-flex justify-content-between align-items-center border-bottom pb-1 mb-2">
                                        <h5 class="mb-0">Multiple Choice Library</h5>
                                    </div>

                                    <div class="question-library"
                                         style="max-height: 400px; overflow-y: auto; scrollbar-width: thin;">
                                        <div class="accordion" id="quizAccordion">
                                            <th:block th:each="quiz : ${allQuizzes}">
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header" th:id="'heading' + ${quiz.id}">
                                                        <div class="quiz-dropdown border rounded p-2 mb-2 bg-light position-relative"
                                                             th:id="'quizDropdown' + ${quiz.id}" style="cursor: pointer;">
                                                            <div class="quiz-header d-flex justify-content-between align-items-center border-bottom pb-1 mb-1"
                                                                 style="font-size: 0.8rem;">
                                                                <div class="position-relative">
                                        <span class="quiz-title h6 fw-bold" style="font-size: 16px; margin-right: 10px;"
                                              th:text="${quiz.name}"></span>
                                                                    <span class="badge bg-success" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;"
                                                                          th:text="${#lists.size(quizQuestionsMap.get(quiz.id))} + ' questions'"></span>
                                                                </div>
                                                                <button type="button" class="btn btn-add-question add-questions d-flex align-items-center justify-content-center"
                                                                        th:data-quiz-id="${quiz.id}"
                                                                        data-question-id=""
                                                                        style="background-color: #007bff; color: white; border: none; width: auto; height: 40px; border-radius: 20px; padding: 0 12px; font-size: 1rem; display: flex; gap: 8px; transition: transform 0.2s ease;">
                                                                    <span class="plus-sign" style="font-size: 1.3rem;">+</span>
                                                                    <span class="add-all-text">Add All</span>
                                                                </button>
                                                            </div>

                                                            <i class="bi bi-chevron-down quiz-dropdown-icon position-absolute"
                                                               style="font-size: 1rem; bottom: -7px; left: 50%; transform: translateX(-50%); transition: transform 0.3s ease;"></i>
                                                        </div>
                                                    </h2>
                                                    <div th:id="'collapse' + ${quiz.id}" class="accordion-collapse collapse"
                                                         th:attr="aria-labelledby='heading' + ${quiz.id}" data-bs-parent="#quizAccordion">
                                                        <div class="accordion-body">
                                                            <ul class="list-group"
                                                                style="max-height: 400px; overflow-y: auto; scrollbar-width: thin;">
                                                                <th:block th:each="question : ${quizQuestionsMap.get(quiz.id)}">
                                                                    <li class="list-group-item d-flex align-items-start justify-content-between shadow-sm" th:data-question-id="${question.id}">
                                                                        <div class="d-flex flex-column w-100">
                                                                            <div class="d-flex justify-content-between align-items-center">
                                                    <span class="question-text"
                                                          th:utext="${question.questionText}"></span>
                                                                                <div class="d-flex gap-1">
                                                                                    <button class="btn btn-sm btn-primary library-add-question"
                                                                                            type="button"
                                                                                            th:data-question-id="${question.id}"
                                                                                            style="border-radius: 5px; height: 30px; width: 30px; display: flex; align-items: center; justify-content: center; padding: 0;">
                                                                                        +
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </li>
                                                                </th:block>
                                                            </ul>
                                                            <p class="text-danger text-center fst-italic" th:if="${#lists.isEmpty(quizQuestionsMap.get(quiz.id))}">
                                                                There's no questions available for this quiz!
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </th:block>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Selected Questions -->
                            <div class="col-md-7">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-1 mb-2">
                                    <h5 class="mb-0">Selected Questions</h5>
                                </div>
                                <div style="max-height: 800px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px;">
                                    <ul class="list-group" id="selected-questions">
                                        <!-- Selected questions will be added here -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Settings Tab -->
                    <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-muted">General Settings</h6>
                            </div>
                            <div class="col-md-4">
                                <label for="id_qualify_score" class="form-label">Minimum Score:</label>
                                <input type="number" name="qualifyScore"
                                       th:value="${assessment?.qualifyScore ?: ''}"
                                       class="form-control"
                                       placeholder="Enter minimum score to qualify"
                                       required
                                       id="id_qualify_score"
                                       min="0"
                                       max="100"
                                       oninput="limitScore(this)">
                            </div>

                            <div class="col-md-4">
                                <label for="id_time_limit" class="form-label">Time Limit (minutes):</label>
                                <input type="number" name="timeLimit"
                                       th:value="${assessment?.timeLimit ?: ''}"
                                       class="form-control"
                                       placeholder="Enter time limit for assessment"
                                       required
                                       id="id_time_limit"
                                       min="1"
                                       max="300"
                                       oninput="limitTime(this)">
                            </div>
                        </div>

                        <hr>

                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-muted">Score Distribution</h6>
                            </div>
                            <div class="col-md-3">
                                <label for="id_quiz_score_ratio" class="form-label">Quiz Score Ratio (%):</label>
                                <input type="number" name="quizScoreRatio"
                                       th:value="${assessment?.quizScoreRatio ?: ''}"
                                       class="form-control"
                                       placeholder="Enter quiz score ratio"
                                       min="0"
                                       required
                                       id="id_quiz_score_ratio">
                            </div>

                            <div class="col-md-3">
                                <label for="id_exercise_score_ratio" class="form-label">Exercise Score Ratio (%):</label>
                                <input type="number" name="exerciseScoreRatio"
                                       th:value="${assessment?.exerciseScoreRatio ?: ''}"
                                       class="form-control"
                                       placeholder="Enter exercise score ratio"
                                       min="0"
                                       required
                                       id="id_exercise_score_ratio">
                            </div>
                        </div>

                        <hr/>

                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-muted">Additional Settings</h6>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="form-label me-3 mb-0">Shuffle Question Order:</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input custom-switch" type="checkbox"
                                           name="shuffled"
                                           th:checked="${assessment?.shuffled ?: false}"
                                           id="id_shuffled">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="similarQuestionsModal" tabindex="-1" aria-labelledby="similarQuestionsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="similarQuestionsModalLabel">Duplicate Questions Found</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="similarQuestionsModalBody">
                        <!-- Content dynamically updated by JS -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelBtn" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmSaveAnywayBtn">Save Anyway</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div id="fullscreen-preview" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white" style="z-index: 1050;">
    <!-- Content will be dynamically injected here -->
</div>

<!-- JavaScript for Tab and Preview Handling -->
<script type="application/json" id="selectedQuestionsJson" th:utext="${selectedQuestionsJson}"></script>

<script type="application/json" id="answersJson" th:text="${answersJson}"></script>

<script th:inline="javascript">
    function limitScore(input) {
        let value = parseInt(input.value, 10);
        if (isNaN(value)) return;
        input.value = Math.max(0, Math.min(100, value));
    }

    function limitTime(input) {
        let value = parseInt(input.value, 10);
        if (isNaN(value)) return;
        input.value = Math.max(1, Math.min(300, value));
    }

    document.addEventListener("DOMContentLoaded", function () {
        const assessmentTypeSelect = document.getElementById("assessmentType");
        const exercisesTab = document.getElementById("exercises-tab");
        const questionsTab = document.getElementById("questions-tab");
        const exerciseCheckboxes = document.querySelectorAll('input[name="exercises"]');
        const suffleCheckbox = document.getElementById("id_shuffled");

        function updateTabs() {
            const selectedType = assessmentTypeSelect.options[assessmentTypeSelect.selectedIndex].text.toLowerCase();

            if (selectedType.includes("quiz") && !selectedType.includes("assignment")) {
                let questionsTabElement = new bootstrap.Tab(questionsTab);
                questionsTabElement.show();

                exercisesTab.classList.add("disabled");
                questionsTab.classList.remove("disabled");

                exerciseCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });

                suffleCheckbox.disabled = false;
                updateSelectedExercises();
            } else if (selectedType.includes("assignment") && !selectedType.includes("quiz")) {
                let exercisesTabElement = new bootstrap.Tab(exercisesTab);
                exercisesTabElement.show();

                questionsTab.classList.add("disabled");
                exercisesTab.classList.remove("disabled");

                suffleCheckbox.checked = false;
                suffleCheckbox.disabled = true;
            } else {
                let exercisesTabElement = new bootstrap.Tab(exercisesTab);
                exercisesTabElement.show();
                exercisesTab.classList.remove("disabled");
                questionsTab.classList.remove("disabled");
                suffleCheckbox.disabled = false;
            }
        }

        updateTabs();

        assessmentTypeSelect.addEventListener("change", updateTabs);
    });

    document.addEventListener("DOMContentLoaded", function () {
        const assessmentTypeSelect = document.getElementById("assessmentType");
        const quizRatioInput = document.getElementById("id_quiz_score_ratio");
        const exerciseRatioInput = document.getElementById("id_exercise_score_ratio");

        function updateRatios() {
            const selectedType = assessmentTypeSelect.options[assessmentTypeSelect.selectedIndex].text.toLowerCase();

            if (selectedType.includes("quiz") && !selectedType.includes("assignment")) {
                quizRatioInput.value = 100;
                exerciseRatioInput.value = 0;
                quizRatioInput.readOnly = true;
                exerciseRatioInput.readOnly = true;

                quizRatioInput.classList.add("readonly-style");
                exerciseRatioInput.classList.add("readonly-style");

                quizRatioInput.addEventListener("input", function () {
                    let quizValue = parseInt(quizRatioInput.value) || 0;
                    quizValue = Math.min(100, Math.max(0, quizValue)); // Gi·ªõi h·∫°n t·ª´ 0 - 100
                    exerciseRatioInput.value = 100 - quizValue;
                });

            } else if (selectedType.includes("assignment") && !selectedType.includes("quiz")) {
                quizRatioInput.value = 0;
                exerciseRatioInput.value = 100;
                quizRatioInput.readOnly = true;
                exerciseRatioInput.readOnly = true;

                quizRatioInput.classList.add("readonly-style");
                exerciseRatioInput.classList.add("readonly-style");

                exerciseRatioInput.addEventListener("input", function () {
                    let exerciseValue = parseInt(exerciseRatioInput.value) || 0;
                    exerciseValue = Math.min(100, Math.max(0, exerciseValue));
                    quizRatioInput.value = 100 - exerciseValue;
                });
            } else {
                quizRatioInput.readOnly = false;
                exerciseRatioInput.readOnly = false;

                quizRatioInput.classList.remove("readonly-style");
                exerciseRatioInput.classList.remove("readonly-style");

                quizRatioInput.addEventListener("input", function () {
                    let quizValue = parseInt(quizRatioInput.value) || 0;
                    if (quizValue > 100) {
                        quizValue = 100;
                        quizRatioInput.value = 100;
                    }
                    exerciseRatioInput.value = 100 - quizValue;
                });

                exerciseRatioInput.addEventListener("input", function () {
                    let exerciseValue = parseInt(exerciseRatioInput.value) || 0;
                    if (exerciseValue > 100){
                        exerciseValue = 100;
                        exerciseRatioInput.value = 100;
                    }
                    quizRatioInput.value = 100 - exerciseValue;
                });
            }
        }

        updateRatios();
        assessmentTypeSelect.addEventListener("change", updateRatios);
    });

    document.addEventListener("DOMContentLoaded", () => {
        // Enable tab switching using Bootstrap's default behavior
        const tabButtons = document.querySelectorAll('#myTab button[data-bs-toggle="tab"]');

        tabButtons.forEach(tabButton => {
            tabButton.addEventListener('click', event => {
                event.preventDefault();
                const targetTab = tabButton.dataset.bsTarget;
                const allTabs = document.querySelectorAll('.tab-pane');

                allTabs.forEach(tab => tab.classList.remove('show', 'active'));
                document.querySelector(targetTab).classList.add('show', 'active');
            });
        });

        // Preview Fullscreen Logic
        const previewButton = document.querySelector("a[th\:href='@{/assessments/{id}/preview(id=${assessment.id})}']");
        const fullscreenPreview = document.getElementById('fullscreen-preview');

        if (previewButton) {
            previewButton.addEventListener('click', (e) => {
                e.preventDefault();
                fullscreenPreview.classList.remove('d-none');
                fullscreenPreview.innerHTML = `<iframe src="${previewButton.getAttribute('href')}" class="w-100 h-100 border-0"></iframe>`;
            });

            fullscreenPreview.addEventListener('click', () => {
                fullscreenPreview.classList.add('d-none');
                fullscreenPreview.innerHTML = '';
            });
        }
    });

    // Javascript for exercises filter
    document.getElementById("id_language").addEventListener("change", function () {
        filterExercises();
        document.getElementById("search-exercises").value = "";
    });

    function filterExercises() {
        let selectedLanguageId = document.getElementById("id_language").value.trim();
        let exercises = document.querySelectorAll(".exercise-item");
        let noResultsMessage = document.getElementById("no-results-message");
        let loadingIndicator = document.getElementById("loading-spinner");
        let exerciseList = document.getElementById("exercise-list");

        // Show loading animation
        loadingIndicator.style.display = "block";
        exerciseList.style.display = "none";
        noResultsMessage.style.display = "none";

        setTimeout(() => {
            let anyVisible = false;

            exercises.forEach(exercise => {
                let exerciseLanguageId = exercise.getAttribute("data-language-id");
                let matchesLanguage = selectedLanguageId === "" || exerciseLanguageId === selectedLanguageId;

                if (matchesLanguage) {
                    exercise.classList.remove("hidden");
                    exercise.dataset.filtered = "true";
                    anyVisible = true;
                } else {
                    exercise.classList.add("hidden");
                    exercise.dataset.filtered = "false";
                }
            });

            // Hide loading animation
            loadingIndicator.style.display = "none";

            if (anyVisible) {
                exerciseList.style.display = "block";
                noResultsMessage.style.display = "none";
            } else {
                exerciseList.style.display = "none";
                noResultsMessage.style.display = "block";
            }
        }, 300);
    }

    // Javascript for search question
    document.getElementById("search-btn").addEventListener("click", function () {
        event.preventDefault();
        searchExercises();
        document.getElementById("search-exercises").value = "";
    });

    const styleSearchExercise = document.createElement("style");
    styleSearchExercise.innerHTML = `
    .exercise-item {
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
        transition: background-color 0.2s ease-in-out, opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        position: relative; /* Ensures smooth hiding */
    }

    .exercise-item:hover {
        background-color: #f8f9fa;
    }

    #loading-spinner {
        display: none;
        text-align: center;
        font-weight: bold;
        margin-top: 10px;
    }

    #no-results-message {
        display: none;
        text-align: center;
        color: red;
        font-style: italic;
    }

    .exercise-item.hidden {
        opacity: 0;
        transform: scaleY(0);  /* Collapse smoothly */
        height: 0;
        overflow: hidden;
        position: absolute;
        visibility: hidden;
    }
`;
    document.head.appendChild(styleSearchExercise);

    function searchExercises() {
        let searchInput = document.getElementById("search-exercises").value.toLowerCase().trim();
        let exercises = document.querySelectorAll(".exercise-item");
        let noResultsMessage = document.getElementById("no-results-message");
        let loadingIndicator = document.getElementById("loading-spinner");
        let exerciseList = document.getElementById("exercise-list");

        // Show loading animation
        loadingIndicator.style.display = "block";
        exerciseList.style.display = "none";
        noResultsMessage.style.display = "none";

        setTimeout(() => {
            let anyVisible = false;

            exercises.forEach(exercise => {
                let exerciseName = exercise.querySelector("label").textContent.toLowerCase();
                let matchesSearch = searchInput === "" || exerciseName.includes(searchInput);

                if (matchesSearch) {
                    exercise.classList.remove("hidden");
                    anyVisible = true;
                } else {
                    exercise.classList.add("hidden");
                }
            });

            // Hide loading animation
            loadingIndicator.style.display = "none";

            if (anyVisible) {
                exerciseList.style.display = "block";
                noResultsMessage.style.display = "none";
            } else {
                exerciseList.style.display = "none";
                noResultsMessage.style.display = "block";
            }
        }, 300);
    }

    //Javascript for toggle preview exercise
    function toggleViewButton(button) {
        const previewContainer = document.getElementById('exercise-content');
        const icon = button.querySelector('i');
        const exerciseItem = button.closest('.exercise-item');
        const description = exerciseItem.querySelector('.exercise-description').textContent;

        if (icon.classList.contains('bi-eye')) {
            icon.classList.replace('bi-eye', 'bi-eye-slash');
            icon.classList.replace('text-primary', 'text-secondary');
            previewContainer.innerHTML = `<p>Select an exercise's icon from the list to preview its content here.</p>`;
        } else {
            document.querySelectorAll('.view-button i').forEach(otherIcon => {
                otherIcon.classList.replace('bi-eye', 'bi-eye-slash');
                otherIcon.classList.replace('text-primary', 'text-secondary');
            });

            icon.classList.replace('bi-eye-slash', 'bi-eye');
            icon.classList.replace('text-secondary', 'text-primary');
            previewContainer.innerHTML = `<p>${description}</p>`;
        }
    }

    //Javascript for passing the exercise list
    function updateSelectedExercises() {
        const selectedIds = Array.from(document.querySelectorAll("input[name='exercises']:checked"))
            .map(checkbox => checkbox.value);

        console.log("üî• Selected Exercise IDs:", selectedIds); // Log danh s√°ch ID ƒë√£ ch·ªçn

        const hiddenInput = document.getElementById("exerciseIds");
        if (hiddenInput) {
            hiddenInput.value = selectedIds.join(",");
            console.log("üìå Updated Hidden Input Value:", hiddenInput.value);
        } else {
            console.error("‚ùå Error: Hidden input #exerciseIds not found!");
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        updateSelectedExercises();

        document.querySelectorAll("input[name='exercises']").forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                console.log(`üîÑ Checkbox Changed: ${checkbox.value}, Checked: ${checkbox.checked}`);
                updateSelectedExercises();
            });
        });
    });

    // Javascript for adding and remove question function
    document.addEventListener("DOMContentLoaded", () => {
        console.log("‚úÖ Tr∆∞·ªõc Submit - JSON trong DOM:", document.getElementById("selectedQuestionsJson")?.textContent);
    });

    document.querySelector("form").addEventListener("submit", function (event) {
        setTimeout(() => {
            console.log("‚ùå Sau Submit - JSON trong DOM:", document.getElementById("selectedQuestionsJson")?.textContent);
        }, 1000);
    });

    document.addEventListener("DOMContentLoaded", function () {
        const selectedQuestionsList = document.getElementById("selected-questions");
        let selectedQuestionsFull = [];
        let newAddedQuestions = [];
        let answersMap = {};

        const emptyMessage = document.createElement("p");
        emptyMessage.id = "empty-message";
        emptyMessage.className = "text-danger text-center fst-italic mt-3";
        emptyMessage.style.display = "none";
        emptyMessage.textContent = "There's currently no selected question for this assessment!";
        selectedQuestionsList.parentNode.appendChild(emptyMessage);

        function loadQuestions() {
            const selectedQuestionsJsonElement = document.getElementById("selectedQuestionsJson");

            if (!selectedQuestionsJsonElement) {
                console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ selectedQuestionsJson");
                return;
            }

            let jsonText = selectedQuestionsJsonElement.textContent.trim();

            if (!jsonText || jsonText === "null") {
                console.warn("‚ö†Ô∏è selectedQuestionsJson r·ªóng ho·∫∑c null.");
                return;
            }
            try {
                let parsedQuestions = JSON.parse(jsonText);

                selectedQuestionsFull = parsedQuestions;

                selectedQuestionsFull.forEach((question) => {
                    addQuestionToSelectedList(question.questionId, question.text, question.orderIndex, true);
                });

                updateEmptyMessage();
            } catch (error) {
                console.error("‚ùå L·ªói parse selectedQuestionsJson:", error);
            }
        }

        function loadAnswers() {
            const answersJsonElement = document.getElementById("answersJson");

            if (!answersJsonElement || !answersJsonElement.textContent) return;

            try {
                const jsonText = answersJsonElement.textContent.trim();
                const parser = new DOMParser();
                const decodedJsonText = parser.parseFromString(jsonText, "text/html").body.textContent;

                let parsedAnswers = JSON.parse(decodedJsonText);
                if (!parsedAnswers || typeof parsedAnswers !== "object") throw new Error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!");

                answersMap = {};
                Object.entries(parsedAnswers).forEach(([key, answersArray]) => {
                    if (Array.isArray(answersArray) && answersArray.length > 0) {
                        const questionId = parseInt(key, 10);
                        answersMap[questionId] = answersArray;
                    }
                });
            } catch (error) {
                answersMap = {};
            }
        }

        function addQuestionToSelectedList(questionId, questionText, orderIndex, isNew = true) {
            if (!questionId || isNaN(questionId)) {
                console.error("‚ùå L·ªói: questionId kh√¥ng h·ª£p l·ªá!", questionId);
                return;
            }

            if ([...selectedQuestionsList.children].some(li => li.dataset.questionId == questionId)) {
                return;
            }

            const listItem = document.createElement("li");
            listItem.className = "list-group-item compact-question-item p-2";
            listItem.dataset.questionId = questionId;

            let answersHtml = "";
            const questionIdNum = parseInt(questionId, 10);

            if (answersMap[questionIdNum] && answersMap[questionIdNum].length > 0) {
                answersHtml = answersMap[questionIdNum].map(answer => `
                <li class="list-group-item d-flex justify-content-between">
                    <span>${answer.text}</span>
                    ${answer.isCorrect ? '<span class="badge rounded-pill bg-success"><i class="bi bi-check-lg"></i></span>' : ''}
                </li>
            `).join("");
            } else {
                answersHtml = `<li class="list-group-item text-danger fst-italic">There's no answer for this question!</li>`;
            }

            listItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center w-100">
                <span class="question-text text-truncate" title="${questionText}"
                      style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${orderIndex}. ${questionText}
                </span>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-secondary move-up me-1">‚¨Ü</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary move-down me-2">‚¨á</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary toggle-answers me-2">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger remove-question-selected">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
            <ul class="list-group mt-2 question-answers" style="display: none;">${answersHtml}</ul>
        `;

            selectedQuestionsList.appendChild(listItem);
            newAddedQuestions.push({questionId, orderIndex, text: questionText});

            updateHiddenInput();

            listItem.querySelector(".remove-question-selected").addEventListener("click", function () {
                removeQuestionFromSelectedList(questionId);
            });

            listItem.querySelector(".toggle-answers").addEventListener("click", function () {
                const answersList = listItem.querySelector(".question-answers");
                const icon = this.querySelector("i");

                if (answersList.style.display === "none") {
                    answersList.style.display = "block";
                    icon.classList.replace("fa-chevron-down", "fa-chevron-up");
                } else {
                    answersList.style.display = "none";
                    icon.classList.replace("fa-chevron-up", "fa-chevron-down");
                }
            });

            listItem.querySelector(".move-up").addEventListener("click", function () {
                const index = [...selectedQuestionsList.children].indexOf(listItem);

                if (index > 0) {
                    const prevItem = selectedQuestionsList.children[index - 1];
                    selectedQuestionsList.insertBefore(listItem, prevItem);

                    [newAddedQuestions[index - 1], newAddedQuestions[index]] = [newAddedQuestions[index], newAddedQuestions[index - 1]];

                    updateOrderIndexes();
                    updateMoveButtons();
                }
            });

            listItem.querySelector(".move-down").addEventListener("click", function () {
                const index = [...selectedQuestionsList.children].indexOf(listItem);

                if (index < selectedQuestionsList.children.length - 1) {
                    const nextItem = selectedQuestionsList.children[index + 1];
                    selectedQuestionsList.insertBefore(nextItem, listItem);

                    [newAddedQuestions[index], newAddedQuestions[index + 1]] = [newAddedQuestions[index + 1], newAddedQuestions[index]];

                    updateOrderIndexes();
                    updateMoveButtons();
                }
            });

            document.querySelectorAll(`.library-add-question[data-question-id='${questionId}']`).forEach(btn => {
                btn.style.display = "none";
            });

            updateHiddenInput();
            updateEmptyMessage();
            updateOrderIndexes();
            updateAddAllButton();
            updateMoveButtons();
        }

        function removeQuestionFromSelectedList(questionId) {
            const listItem = [...selectedQuestionsList.children].find((item) => item.dataset.questionId == questionId);

            if (!listItem) return;

            listItem.remove();

            newAddedQuestions = newAddedQuestions.filter((q) => q.questionId !== parseInt(questionId, 10));

            document.querySelectorAll(`.library-add-question[data-question-id='${questionId}']`).forEach(btn => {
                btn.style.display = "inline-block";
            });

            updateHiddenInput();
            updateEmptyMessage();
            updateOrderIndexes();
            updateAddAllButton();
            updateMoveButtons()
        }

        function updateOrderIndexes() {
            [...selectedQuestionsList.children].forEach((li, index) => {
                const questionTextElement = li.querySelector(".question-text");
                const textParts = questionTextElement.textContent.split(". ");

                if (textParts.length > 1) {
                    questionTextElement.textContent = `${index + 1}. ${textParts.slice(1).join(". ")}`;
                }

                const questionId = parseInt(li.dataset.questionId, 10);
                const question = newAddedQuestions.find(q => q.questionId === questionId);
                if (question) {
                    question.orderIndex = index + 1;
                }
            });

            updateHiddenInput();

            console.log("üìå Danh s√°ch c√¢u h·ªèi sau khi c·∫≠p nh·∫≠t:", newAddedQuestions);
        }

        function updateMoveButtons() {
            const items = [...selectedQuestionsList.children];

            items.forEach((li, index) => {
                const moveUpButton = li.querySelector(".move-up");
                const moveDownButton = li.querySelector(".move-down");

                moveUpButton.disabled = index === 0;
                moveDownButton.disabled = index === items.length - 1;
            });
        }

        function updateAddAllButton() {
            document.querySelectorAll(".add-questions").forEach(button => {
                const quizId = button.getAttribute("data-quiz-id");
                const questions = document.querySelectorAll(`#collapse${quizId} .library-add-question`);

                const allAdded = [...questions].every(q => q.style.display === "none");

                button.disabled = allAdded;
            });
        }

        function updateEmptyMessage() {
            emptyMessage.style.display = selectedQuestionsList.children.length === 0 ? "block" : "none";
        }

        function updateHiddenInput() {
            document.getElementById("newAddedQuestionsInput").value = JSON.stringify(newAddedQuestions);
        }

        function getSelectedType() {
            const assessmentTypeSelect = document.getElementById("assessmentType");
            return assessmentTypeSelect.options[assessmentTypeSelect.selectedIndex].text.toLowerCase();
        }

        function resetQuestionsIfNeeded() {
            const selectedType = getSelectedType();

            if (selectedType.includes("assignment") && !selectedType.includes("quiz")) {
                selectedQuestionsList.innerHTML = "";
                newAddedQuestions = [];
                updateHiddenInput();
                updateEmptyMessage();

                console.warn("üìå Danh s√°ch c√¢u h·ªèi ƒë√£ reset v√¨ l√† 'assignment' m√† kh√¥ng ph·∫£i 'quiz'.");

            }
        }

        document.getElementById("assessmentType").addEventListener("change", function () {
            resetQuestionsIfNeeded();
        });

        document.addEventListener("click", function (event) {
            if (event.target.closest(".library-add-question")) {
                const button = event.target.closest(".library-add-question");
                const questionId = button.getAttribute("data-question-id");
                const questionText = button.closest(".list-group-item").querySelector(".question-text").innerText;

                if (!questionId || isNaN(questionId)) {
                    console.error(`‚ùå L·ªói: questionId kh√¥ng h·ª£p l·ªá! Gi√° tr·ªã nh·∫≠n ƒë∆∞·ª£c: "${questionId}"`);
                    return;
                }

                addQuestionToSelectedList(parseInt(questionId, 10), questionText, newAddedQuestions.length + 1);
            }
        });

        document.addEventListener("click", function (event) {
            if (event.target.closest(".add-questions")) {
                const quizId = event.target.closest(".add-questions").getAttribute("data-quiz-id");
                const newQuestions = [];

                document.querySelectorAll(`#collapse${quizId} .library-add-question`).forEach(button => {
                    if (button.style.display !== "none") {
                        newQuestions.push({
                            questionId: parseInt(button.getAttribute("data-question-id"), 10),
                            text: button.closest(".list-group-item").querySelector(".question-text").innerText.trim()
                        });
                    }
                });

                newQuestions.forEach((q, index) => {
                    addQuestionToSelectedList(q.questionId, q.text, newAddedQuestions.length + 1 + index);
                });

                updateAddAllButton();
            }
        });

        document.querySelectorAll(".quiz-dropdown").forEach(dropdown => {
            dropdown.addEventListener("click", function () {
                const quizId = this.id.replace("quizDropdown", "");
                const collapseElement = document.getElementById(`collapse${quizId}`);

                if (collapseElement.classList.contains("show")) {
                    collapseElement.classList.remove("show");
                } else {
                    document.querySelectorAll(".accordion-collapse.show").forEach(open => open.classList.remove("show"));
                    collapseElement.classList.add("show");
                }
            });
        });

        document.getElementById("saveAssessmentBtn").addEventListener("click", function () {
            event.preventDefault();

            if (newAddedQuestions.length === 0) {
                console.warn("üìå Kh√¥ng c√≥ c√¢u h·ªèi m·ªõi ƒë·ªÉ ki·ªÉm tra.");
                document.getElementById("assessment-form").submit();
                return;
            }

                fetch("/assessments/edit/check-similar-new-question/add-batch", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ questions: newAddedQuestions }) // Run check on existing questions
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.duplicateLists && Object.keys(data.duplicateLists).length > 0) {
                            showSimilarQuestionsModal(data.duplicateLists);
                        }
                        else {
                            document.getElementById("assessment-form").submit();
                        }
                    })
                    .catch(error => {
                        console.error("‚ùå Error checking duplicates on page load:", error);
                    });
        });

        document.getElementById("confirmSaveAnywayBtn").addEventListener("click", function () {
            document.getElementById("assessment-form").submit();
        });

        function showSimilarQuestionsModal(duplicateLists) {
            let questionsList = newAddedQuestions || [];

            if (!questionsList.length) {
                console.error("‚ùå Error: newAddedQuestions is empty or undefined.");
                return;
            }

            const modalBody = document.getElementById("similarQuestionsModalBody");
            modalBody.innerHTML = "";

            if (Object.keys(duplicateLists).length === 0) {
                modalBody.innerHTML = "<p>No duplicate questions found.</p>";
            } else {
                let html = `<div style="max-height: 500px; overflow-y: auto;">`;

                for (const [key, duplicates] of Object.entries(duplicateLists)) {
                    const originalQuestion = questionsList.find(q => q.questionId == key);
                    if (!originalQuestion) continue;

                    // Highlight original question
                    html += `
                <div class="alert alert-warning" role="alert">
                    <strong>Original Question:</strong>
                    <span class="fw-bold text-primary" style="font-size: 1.1rem;">${originalQuestion.text}</span>
                </div>
                <table class="table table-bordered table-striped">
                    <tbody>
            `;

                    duplicates.forEach(id => {
                        const duplicate = questionsList.find(q => q.questionId == id);
                        if (duplicate) {
                            html += `
                        <tr>
                            <td style="white-space: nowrap;"><strong>At:</strong> ${duplicate.orderIndex}. ${duplicate.text.replace(/<\/?p>/g, "")}</td>
                        </tr>
                    `;
                        }
                    });

                    html += `</tbody></table><hr>`;
                }

                html += `</div>`;
                modalBody.innerHTML = html;
            }

            $("#similarQuestionsModal").modal("show");
        }

        updateAddAllButton();
        loadAnswers();
        loadQuestions();
    });

    // Javascript for checking duplicate assessment
    document.addEventListener("DOMContentLoaded", function () {
        const titleDisplay = document.getElementById("title-display");
        const titleInput = document.getElementById("title-input");
        const editTitle = document.getElementById("edit-title");
        const saveTitle = document.getElementById("save-title");
        const errorDiv = document.getElementById("duplicateTitleError");
        const saveAssessmentBtn = document.querySelector(".btn-success");

        let initialTitle = titleInput.value.trim();
        let isModified = false;

        saveAssessmentBtn.disabled = false;

        editTitle.addEventListener("click", function (event) {
            event.preventDefault();
            toggleTitleEditing(true);
        });

        titleInput.addEventListener("input", function () {
            isModified = titleInput.value.trim() !== initialTitle;
            updateSaveAssessmentButton();
        });

        saveTitle.addEventListener("click", function (event) {
            event.preventDefault();

            let newTitle = titleInput.value.trim();
            let assessmentTypeId = document.getElementById("assessmentType").value;
            let id = document.getElementById("assessmentId").value;

            if (newTitle === "") {
                showError("The title cannot be empty!");
                titleInput.value = initialTitle;
                return;
            }

            $.get(`/assessments/edit/check-duplicate`, {title: newTitle, assessmentTypeId: assessmentTypeId, id: id})
                .done(function (response) {
                    if (response.isDuplicate) {
                        showError("Assessment title of this assessment type already exists!");
                        titleInput.value = initialTitle;
                        return;
                    }

                    hideError();
                    toggleTitleEditing(false);

                    initialTitle = titleInput.value.trim();
                    isModified = false;
                    updateSaveAssessmentButton();
                })
                .fail(function () {
                    showError("Error when checking!");
                    titleInput.value = initialTitle;
                });
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove("d-none");
            errorDiv.style.opacity = "0";

            setTimeout(() => {
                errorDiv.style.transition = "opacity 0.5s ease-in-out";
                errorDiv.style.opacity = "1";
            }, 10);

            setTimeout(() => {
                errorDiv.style.opacity = "0";
                setTimeout(() => errorDiv.classList.add("d-none"), 500);
            }, 5000);
        }

        function hideError() {
            errorDiv.style.opacity = "0";
            setTimeout(() => errorDiv.classList.add("d-none"), 500);
        }

        function toggleTitleEditing(isEditing) {
            if (isEditing) {
                titleInput.classList.remove("d-none");
                titleDisplay.classList.add("d-none");
                saveTitle.classList.remove("d-none");
                editTitle.classList.add("d-none");
                titleInput.focus();
            } else {
                titleDisplay.textContent = titleInput.value.trim();
                titleDisplay.classList.remove("d-none");
                titleInput.classList.add("d-none");
                saveTitle.classList.add("d-none");
                editTitle.classList.remove("d-none");

                isModified = false;
            }
            updateSaveAssessmentButton();
        }

        function updateSaveAssessmentButton() {
            saveAssessmentBtn.disabled = !isModified && !titleInput.classList.contains("d-none");
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        let isFormChanged = false;

        document.getElementById("assessment-form").addEventListener("input", function () {
            isFormChanged = true;
        });

        document.getElementById("assessment-form").addEventListener("change", function () {
            isFormChanged = true;
        });

        let questionList = document.getElementById("selected-questions");
        if (questionList) {
            new MutationObserver(function () {
                isFormChanged = true;
            }).observe(questionList, { childList: true, subtree: true });
        }

        document.querySelectorAll("#backToList, #previewAssessment").forEach(button => {
            button.addEventListener("click", function (event) {
                if (isFormChanged) {
                    event.preventDefault();
                    showSaveModal(this.href);
                }
            });
        });

        function showSaveModal(redirectUrl) {
            let existingModal = document.getElementById("saveConfirmModal");
            if (!existingModal) {
                let modalHtml = `
            <div class="modal fade" id="saveConfirmModal" tabindex="-1" aria-labelledby="saveConfirmLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="saveConfirmLabel">Unsaved Changes</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            You have unsaved changes. Do you want to save before leaving?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="dontSaveBtn" data-bs-dismiss="modal">Don't Save</button>
                            <button type="button" class="btn btn-success" id="confirmSave">Save & Proceed</button>
                        </div>
                    </div>
                </div>
            </div>
            `;
                document.body.insertAdjacentHTML("beforeend", modalHtml);
            }

            let modalElement = document.getElementById("saveConfirmModal");
            let modal = new bootstrap.Modal(modalElement);
            modal.show();

            document.getElementById("confirmSave").onclick = function () {
                document.getElementById("saveAssessmentBtn").click();
                modal.hide();
            };

            document.getElementById("dontSaveBtn").onclick = function () {
                modal.hide();
                setTimeout(() => window.location.href = redirectUrl, 300);
            };
        }
    });
</script>
