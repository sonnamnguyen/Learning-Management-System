<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversion Results</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-refresh {
            background-color: #6c757d;
            color: white;
        }
        .btn-refresh:hover {
            background-color: #5a6268;
        }
        .content-preview {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
<div class="container mt-5 flex-grow-1">

    <!-- Header -->
    <div th:replace="~{fragments :: header}" class="sticky-top"></div>

    <h1 class="text-center text-success">Conversion Results</h1>
    <p class="text-center">Below is the content of your TXT files converted into JSON format. You can download them individually or all as a ZIP file.</p>

    <!-- File List -->
    <div th:if="${txtData != null}">
        <h4>Converted Content:</h4>
        <ul class="list-group mb-4">
            <li class="list-group-item" th:each="entry : ${txtData}">
                <div>
                    <h5 th:text="${entry.key}"></h5>
                </div>
                <a href="javascript:void(0);"
                   class="btn btn-outline-primary"
                   th:attr="data-file-name=${entry.key}, data-json=${entry.value}">Download</a>
            </li>
        </ul>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-center gap-2">
        <button class="btn btn-primary" onclick="downloadAllAsZip()">Download All as ZIP</button>
        <button class="btn btn-refresh" onclick="window.location.href='/tools/convert_txt'">Convert More</button>
    </div>

</div>

<!-- Footer -->
<footer th:replace="~{fragments :: footer}" class="bg-light py-3 text-center mt-auto">
    <p>&copy; 2025 Your Company. All Rights Reserved.</p>
</footer>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const downloadButtons = document.querySelectorAll('.btn-outline-primary');

        // Event for individual download
        downloadButtons.forEach(button => {
            button.addEventListener('click', function () {
                const fileName = this.getAttribute('data-file-name');
                const jsonData = this.getAttribute('data-json'); // JSON data as string

                downloadFile(fileName, jsonData);
            });
        });
    });

    function downloadFile(fileName, jsonData) {
        // Create Blob with JSON data
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        // Create and trigger download link
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName + '.json';
        a.click();

        // Revoke URL after download
        URL.revokeObjectURL(url);
    }

    async function downloadAllAsZip() {
        // Collect all JSON data
        const zip = new JSZip();
        const listItems = document.querySelectorAll('.list-group-item');

        listItems.forEach(item => {
            const fileName = item.querySelector('h5').textContent;
            const jsonData = item.querySelector('.btn-outline-primary').getAttribute('data-json');

            // Add each JSON file to the zip archive
            zip.file(`${fileName}.json`, jsonData);
        });

        // Generate ZIP file and trigger download
        const content = await zip.generateAsync({ type: 'blob' });
        const zipUrl = URL.createObjectURL(content);

        const a = document.createElement('a');
        a.href = zipUrl;
        a.download = 'all_files.zip';
        a.click();

        // Revoke URL after download
        URL.revokeObjectURL(zipUrl);
    }
</script>

<!-- Include JSZip Library -->
<script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
</body>
</html>
