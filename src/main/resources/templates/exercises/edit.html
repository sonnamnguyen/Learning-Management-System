<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Exercise</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .cke_notification {
            display: none !important;
        }

        /*.tag-container {*/
        /*    display: flex;*/
        /*    flex-wrap: wrap;*/
        /*    gap: 8px;*/
        /*    margin-bottom: 10px;*/
        /*    padding: 5px;*/
        /*    min-height: 35px;*/
        /*    border: 1px solid #ced4da;*/
        /*    border-radius: 4px;*/
        /*}*/

        /*.tag-pill {*/
        /*    display: inline-flex;*/
        /*    align-items: center;*/
        /*    background-color: #007bff;*/
        /*    color: white;*/
        /*    padding: 4px 8px;*/
        /*    border-radius: 16px;*/
        /*    margin-right: 5px;*/
        /*    margin-bottom: 5px;*/
        /*}*/

        /*.remove-tag {*/
        /*    margin-left: 8px;*/
        /*    cursor: pointer;*/
        /*    font-weight: bold;*/
        /*    color: white;*/
        /*}*/

        /*.remove-tag:hover {*/
        /*    color: #ff4444;*/
        /*}*/

        /* Container chính cho tags */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Khoảng cách giữa các tags */
            margin-bottom: 15px;
            min-height: 38px; /* Chiều cao tối thiểu khi có tag */
            position: relative;
            transition: min-height 0.2s ease; /* Hiệu ứng mượt */
        }

        /* Class khi không có tag */
        .tag-container.empty {
            /*min-height: 0; !* Thu gọn khi không có tag *!*/
            min-height: 0 !important;
            margin-bottom: 0 !important;
        }

        /* Style cho mỗi tag pill */
        .tag-pill {
            display: inline-flex;
            align-items: center;
            background-color: #e9ecef;
            color: #495057;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        /* Nút xóa trong tag */
        .remove-tag {
            margin-left: 6px;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        /* Hover effect cho tag */
        .tag-pill:hover {
            background-color: #dee2e6;
        }

        /* Hover effect cho nút xóa */
        .remove-tag:hover {
            background-color: #dc3545;
            color: white;
        }

        /* Style cho form select */
        .form-select#tag {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            /* Điều chỉnh kích thước dựa trên trạng thái */
            min-width: 150px; /* Kích thước mặc định khi có tag */
            transition: min-width 0.3s ease; /* Hiệu ứng mượt */
        }

        /* Thu gọn select khi không có tag */
        .tag-container.empty + .form-select#tag {
            min-width: 120px; /* Kích thước nhỏ hơn khi không có tag */
        }

        /* Focus state cho select */
        .form-select#tag:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
            outline: none;
        }

        /* Responsive adjustments */
        @media (max-width: 576px) {
            .tag-pill {
                font-size: 12px;
                padding: 3px 8px;
            }

            .remove-tag {
                margin-left: 4px;
                font-size: 14px;
                width: 14px;
                height: 14px;
                line-height: 14px;
            }

            .form-select#tag {
                min-width: 100px;
            }

            .tag-container.empty + .form-select#tag {
                min-width: 80px;
            }
        }

        .tag-checkboxes {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .form-check {
            margin: 5px 0;
        }

        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .form-check-label {
            cursor: pointer;
            user-select: none;
        }

        /* Style cho dropdown tags */
        .tag-dropdown {
            position: relative;
            display: inline-block;
        }

        .tag-dropdown-btn {
            background-color: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            min-width: 150px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tag-dropdown-content.show {
            display: block;
        }

        .tag-checkbox-item {
            padding: 8px;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
        }

        .tag-checkbox-item:hover {
            background-color: #f1f1f1;
        }

        /* Style for selected tags container */
        #selected-tags {
            min-height: 38px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            background-color: #fff;
        }

        /* Style for each selected tag badge */
        #selected-tags .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }

        td {
            text-align: center;
            vertical-align: middle;
        }

        td.text-center {
            width: 50px;
            text-align: center;
            vertical-align: middle;
        }

        #selected-tags .badge:hover {
            background-color: #dee2e6;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #selected-tags .badge::after {
            content: "×";
            margin-left: 8px;
            font-size: 1.2rem;
            line-height: 1;
            color: #6c757d;
        }

        #selected-tags:empty::before {
            content: "No tags selected";
            color: #6c757d;
            font-style: italic;
        }

        /* Style cho nút + */
        .tag-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background-color: #007bff;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .tag-button:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }

        .clear-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px; /* Đệm để button trông cân đối */
            border-radius: 5px; /* Bo góc nhẹ */
            border: 1px solid #ced4da; /* Viền mặc định của btn-outline-secondary */
            background-color: transparent; /* Nền trong suốt */
            transition: all 0.3s ease; /* Hiệu ứng mượt mà */
        }

        /* Style cho icon broom */
        .clear-btn .fa-broom-wide {
            font-size: 1.2rem; /* Kích thước icon */
            color: #ff6666; /* Màu đỏ nhẹ như yêu cầu trước đó */
            transition: color 0.3s ease, transform 0.3s ease; /* Hiệu ứng mượt mà */
        }

        /* Hiệu ứng hover cho button */
        .clear-btn:hover {
            background-color: #f8f9fa; /* Màu nền nhạt khi hover */
            border-color: #ff6666; /* Đổi màu viền thành đỏ nhẹ */
        }

        /* Hiệu ứng hover cho icon */
        .clear-btn:hover .fa-broom-wide {
            color: #ff3333; /* Màu đỏ đậm hơn khi hover */
            transform: rotate(15deg); /* Xoay nhẹ icon khi hover */
        }

        /* Đảm bảo button không bị quá nhỏ */
        .clear-btn {
            min-width: 40px; /* Chiều rộng tối thiểu */
            height: 38px; /* Chiều cao phù hợp với input bên cạnh */
        }

        .search-container {
            position: relative;
        }

        .input-group.position-relative {
            position: relative;
        }

        .form-control {
            padding-right: 30px; /* Tạo không gian cho icon x */
        }

        /* Style cho icon x trong input */
        .clear-search-icon {
            position: absolute;
            right: 50px; /* Đặt icon x trước nút Clear Tags */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6c757d; /* Màu xám mặc định */
            font-size: 1rem;
            display: none; /* Ẩn icon khi input rỗng */
            z-index: 10; /* Đảm bảo icon nằm trên input */
            transition: color 0.3s ease;
        }

        /* Hiển thị icon x khi input có nội dung */
        .form-control:not(:placeholder-shown) ~ .clear-search-icon {
            display: block;
        }

        /* Hiệu ứng hover cho icon x */
        .clear-search-icon:hover {
            color: #ff6666; /* Màu đỏ nhẹ khi hover */
        }
    </style>
</head>
<body>
<div class="flex-grow-1 container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">Update Exercise</h3>
        </div>
        <div class="card-body" >
            <form
                    th:action="@{/exercises/edit/{id}(id=${exercise.id})}"
                    th:object="${exercise}"
                    method="post"
                    class="needs-validation"
                    novalidate
                    id="editForm"
            >
                <!-- Name -->
                <div class="mb-3">
                    <label for="name" class="form-label">Title:</label>
                    <input
                            type="text"
                            id="name"
                            th:field="*{name}"
                            class="form-control"
                            placeholder="Enter exercise name"
                            required
                    />
                    <div class="invalid-feedback">Please enter a name.</div>
                </div>

                <!-- Tag Selection -->
                <div class="mb-3">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <label for="tagIds" class="form-label mb-0">Tags</label>
                        <a href="/category" id="tagRedirect" class="tag-button">+</a>
                    </div>
                    <!-- Display selected tags -->
                    <div id="selected-tags" class="mt-2"></div>
                    <div class="tag-container">
                        <div class="tag-dropdown">
                            <button
                                    type="button"
                                    class="btn tag-dropdown-btn"
                                    onclick="toggleTagDropdown(event)"
                            >
                                Select Tags <i class="bi bi-chevron-down"></i>
                            </button>
                            <div class="tag-dropdown-content" id="tagDropdown">
                                <div class="search-container mb-2 p-2" onclick="event.stopPropagation()">
                                    <div class="input-group position-relative">
                                        <input
                                                type="text"
                                                class="form-control"
                                                id="tagSearch"
                                                placeholder="Search tags..."
                                                onkeyup="filterTags(this); toggleClearIcon()"
                                                onfocus="event.stopPropagation()"
                                        />
                                        <span class="clear-search-icon"
                                              onclick="clearSearchInput(); event.stopPropagation()">
                                            <i class="bi bi-x-lg"></i>
                                        </span>
                                        <button
                                                type="button"
                                                class="btn btn-outline-secondary clear-btn"
                                                onclick="clearAllCheckboxes(); event.stopPropagation()"
                                                title="Clear Tags"
                                        >
                                            <i class="fa-solid fa-broom-wide"></i>
                                        </button>
                                    </div>
                                </div>
                                <div th:each="t : ${tags}" class="tag-checkbox-item">
                                    <input
                                            class="form-check-input"
                                            type="checkbox"
                                            th:value="${t.id}"
                                            th:id="'tag-' + ${t.id}"
                                            th:checked="${exercise.exerciseCategories.![category.id].contains(t.id)}"
                                            onchange="handleTagSelection(this)"
                                    />
                                    <label
                                            class="form-check-label ms-2"
                                            th:for="'tag-' + ${t.id}"
                                            th:text="${t.tag}"
                                    ></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input
                            type="hidden"
                            name="tag"
                            id="tagIds"
                            value=""/>
                    <!--                            th:value="${#strings.listJoin(exercise.exerciseCategories.![category.id], ',')}"-->

                    <input
                            type="hidden"
                            name="removedTagIds"
                            id="removedTagIds"
                            value=""/>
                    <!--                            th:value="${#strings.listJoin(exercise.exerciseCategories.![category.id], ',')}"-->

                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" th:field="*{description}"
                              th:class="${#fields.hasErrors('description')} ? 'form-control is-invalid' : 'form-control'"></textarea>
                    <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="error"></div>
                </div>

                <!-- Programming Language -->
                <div class="mb-3">
                    <label for="language" class="form-label">Programming Language:</label>
                    <select id="language" th:field="*{language}" class="form-select" required disabled>
                        <option th:each="lang : ${programmingLanguages}" th:value="${lang.id}"
                                th:text="${lang.language}">Select Language
                        </option>
                        <input type="hidden" name="language" th:value="${exercise.language.id}">
                    </select>
                    <div class="invalid-feedback">Please select a programming language.</div>
                </div>

                <!-- Setup -->
                <div class="mb-3">
                    <label for="setup" class="form-label">Setup:</label>
                    <textarea id="setup" th:field="*{setup}" class="form-control" rows="12"
                              placeholder="Enter any setup instructions"></textarea>
                </div>

                <div id="sqlFields" style="display: none;">
                    <label for="setup_for_sql" class="form-label">SQL Setup Code:</label>
                    <textarea id="setup_for_sql" th:field="*{setupsql}" class="form-control" rows="4"
                              placeholder="Enter SQL setup instructions"></textarea>
                </div>

                <!-- Level -->
                <div class="mb-3">
                    <label for="level" class="form-label">Difficulty Level:</label>
                    <select id="level" th:field="*{level}" class="form-select" required>
                        <option th:value="EASY" th:text="'Easy'"></option>
                        <option th:value="MEDIUM" th:text="'Medium'"></option>
                        <option th:value="HARD" th:text="'Hard'"></option>
                    </select>
                    <div class="invalid-feedback">Please select a difficulty level.</div>
                </div>

                <!-- Test Cases -->
                <div class="mb-3">
                    <label class="form-label d-block">Select Test Case Input Method</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="jsonOption" name="testCaseMethod" value="json"
                               checked onclick="toggleTestCaseMethod()">
                        <label class="form-check-label" for="jsonOption">Enter as JSON</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="uiOption" name="testCaseMethod" value="ui"
                               onclick="toggleTestCaseMethod()">
                        <label class="form-check-label" for="uiOption">Add Manually</label>
                    </div>
                </div>
                <!-- JSON Input Method -->
                <div id="jsonInputDiv">
                    <label for="testCases" class="form-label">Test Cases (JSON Format)</label>
                    <textarea th:text="${testCasesJson}" class="form-control" id="testCases" name="testCasesJson"
                              placeholder='[{"input":" ","expectedOutput":" ","hidden":false},{"input":" ","expectedOutput":" ","hidden":true}]'></textarea>
                </div>

                <!-- Manual UI Input Method with Tabs -->
                <div id="uiInputDiv" style="display: none;">
                    <label class="form-label">Test Cases</label>

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs" id="testCaseTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="normal-tab" data-bs-toggle="tab" href="#normalTestCases"
                               role="tab">Test Cases</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="hidden-tab" data-bs-toggle="tab" href="#hiddenTestCases" role="tab">Hidden
                                Test Cases</a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-2" id="testCaseTabContent">
                        <!-- Normal Test Cases Tab -->
                        <div class="tab-pane fade show active" id="normalTestCases" role="tabpanel">
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Input</th>
                                    <th>Expected Output</th>
                                    <th id="sqlTagHeaderNormal" class="sqlTagHeader" style="display: none;">SQL Tag
                                        Number
                                    </th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <tbody id="normalTestCasesContainer">
                                <tr th:each="testCase, iterStat : ${normalTestCases}">
                                    <td><input type="text" class="form-control"
                                               name="normalTestCases[${iterStat.index}].input"
                                               th:value="${testCase.input}" placeholder="Input"></td>
                                    <td><input type="text" class="form-control"
                                               name="normalTestCases[${iterStat.index}].expectedOutput"
                                               th:value="${testCase.expectedOutput}" placeholder="Expected Output"></td>
                                    <td class="sqlTagInput" th:if="${exercise.language.language == 'SQL'}">
                                        <input type="text" class="form-control"
                                               name="normalTestCases[${iterStat.index}].sqlTagNumber"
                                               th:value="${testCase.sqlTagNumber}" placeholder="SQL Tag Number">
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-danger btn-sm"
                                                onclick="removeTestCase(this)">-
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-success btn-sm"
                                    onclick="addTestCase('normalTestCasesContainer')"><i class="bi bi-plus-circle"></i>
                            </button>
                        </div>

                        <!-- Hidden Test Cases Tab -->
                        <div class="tab-pane fade" id="hiddenTestCases" role="tabpanel">
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Input</th>
                                    <th>Expected Output</th>
                                    <th id="sqlTagHeaderHidden" class="sqlTagHeader" style="display: none;">SQL Tag
                                        Number
                                    </th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <tbody id="hiddenTestCasesContainer">
                                <tr th:each="testCase, iterStat : ${hiddenTestCases}">
                                    <td><input type="text" class="form-control"
                                               name="hiddenTestCases[${iterStat.index}].input"
                                               th:value="${testCase.input}" placeholder="Hidden Input"></td>
                                    <td><input type="text" class="form-control"
                                               name="hiddenTestCases[${iterStat.index}].expectedOutput"
                                               th:value="${testCase.expectedOutput}"
                                               placeholder="Hidden Expected Output"></td>
                                    <td class="sqlTagInput" th:if="${exercise.language.language == 'SQL'}">
                                        <input type="text" class="form-control"
                                               name="hiddenTestCases[${iterStat.index}].sqlTagNumber"
                                               th:value="${testCase.sqlTagNumber}" placeholder="SQL Tag Number">
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-danger btn-sm"
                                                onclick="removeTestCase(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-success btn-sm"
                                    onclick="addTestCase('hiddenTestCasesContainer')"><i class="bi bi-plus-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit and Back Buttons -->
                <div class="d-flex justify-content-end mt-2">
                    <button type="submit" class="btn btn-primary" onclick="saveAndGoBack()">Save</button>
                    <a href="#" class="btn btn-secondary ms-2" onclick="goBackWithFilters()">Back to List</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.ckeditor.com/4.20.2/standard/ckeditor.js"></script>
<script>
    CKEDITOR.replace('description', {
        removePlugins: 'easyimage, cloudservices, toolbar, format, styles, link',
        allowedContent: 'p; br; strong; em; u',
        extraAllowedContent: '',
        enterMode: CKEDITOR.ENTER_BR
    });

    function getPlainTextFromCKEditor() {
        const editorData = CKEDITOR.instances.description.getData();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editorData;
        return tempDiv.textContent || tempDiv.innerText || '';
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let testCases = JSON.parse(document.getElementById("testCases").textContent || "[]");
        let jsonInputDiv = document.getElementById("jsonInputDiv");
        let uiInputDiv = document.getElementById("uiInputDiv");
        let jsonOption = document.getElementById("jsonOption");
        let normalTestCasesContainer = document.getElementById("normalTestCasesContainer");
        let hiddenTestCasesContainer = document.getElementById("hiddenTestCasesContainer");
        let languageSelect = document.getElementById("language");
        let sqlFieldsDiv = document.getElementById("sqlFields");
        let sqlTagHeaderNormal = document.getElementById("sqlTagHeaderNormal");
        let sqlTagHeaderHidden = document.getElementById("sqlTagHeaderHidden");

        function toggleTestCaseMethod() {
            const isJsonSelected = jsonOption.checked;
            jsonInputDiv.style.display = isJsonSelected ? "block" : "none";
            uiInputDiv.style.display = isJsonSelected ? "none" : "block";
            if (!isJsonSelected) {
                renderNormalTestCases();
                renderHiddenTestCases();
            }
        }

        function toggleSqlFields() {
            // Lấy text của option được chọn thay vì dựa vào value
            const selectedOption = languageSelect.options[languageSelect.selectedIndex];
            const isSqlSelected = selectedOption.textContent.trim().toUpperCase() === "SQL";

            sqlFieldsDiv.style.display = isSqlSelected ? "block" : "none";
            sqlTagHeaderNormal.style.display = isSqlSelected ? "table-cell" : "none";
            sqlTagHeaderHidden.style.display = isSqlSelected ? "table-cell" : "none";

            let sqlTagInputs = document.querySelectorAll(".sqlTagInput");
            sqlTagInputs.forEach(input => {
                input.style.display = isSqlSelected ? "table-cell" : "none";
            });

            console.log("All Test Cases:", testCases);
            console.log("Normal Test Cases:", testCases.filter(testCase => !testCase.isHidden));
            console.log("Hidden Test Cases:", testCases.filter(testCase => testCase.isHidden));
            renderNormalTestCases();
            renderHiddenTestCases();
        }

        function renderNormalTestCases() {
            normalTestCasesContainer.innerHTML = "";
            testCases
                .filter(testCase => testCase.hidden === false)
                .forEach((testCase, index) => {
                    let newRow = document.createElement("tr");
                    const selectedOption = languageSelect.options[languageSelect.selectedIndex];
                    const isSqlSelected = selectedOption.textContent.trim().toUpperCase() === "SQL";
                    newRow.innerHTML = `
                <td><input type="text" class="form-control" name="normalTestCases[${index}].input" value="${testCase.input || ''}" placeholder="Input"></td>
                <td><input type="text" class="form-control" name="normalTestCases[${index}].expectedOutput" value="${testCase.expectedOutput || ''}" placeholder="Expected Output"></td>
                <td class="sqlTagInput" style="display: ${isSqlSelected ? 'table-cell' : 'none'};">
                    <input type="text" class="form-control" name="normalTestCases[${index}].sqlTagNumber" value="${testCase.sqlTagNumber || ''}" placeholder="SQL Tag Number">
                </td>
                <td class="text-center"><button type="button" class="btn btn-danger btn-sm" onclick="removeTestCase(this)">
                            <i class="bi bi-trash"></i>
                    </button>
                </td>
<!--                <td><input type="hidden" name="normalTestCases[${index}].hidden" value="false"></td>-->
            `;
                    normalTestCasesContainer.appendChild(newRow);
                });
        }

        function renderHiddenTestCases() {
            hiddenTestCasesContainer.innerHTML = "";
            testCases
                .filter(testCase => testCase.hidden === true)
                .forEach((testCase, index) => {
                    let newRow = document.createElement("tr");
                    const selectedOption = languageSelect.options[languageSelect.selectedIndex];
                    const isSqlSelected = selectedOption.textContent.trim().toUpperCase() === "SQL";
                    newRow.innerHTML = `
                <td><input type="text" class="form-control" name="hiddenTestCases[${index}].input" value="${testCase.input || ''}" placeholder="Hidden Input"></td>
                <td><input type="text" class="form-control" name="hiddenTestCases[${index}].expectedOutput" value="${testCase.expectedOutput || ''}" placeholder="Hidden Expected Output"></td>
                <td class="sqlTagInput" style="display: ${isSqlSelected ? 'table-cell' : 'none'};">
                    <input type="text" class="form-control" name="hiddenTestCases[${index}].sqlTagNumber" value="${testCase.sqlTagNumber || ''}" placeholder="SQL Tag Number">
                </td>
                <td class="text-center"><button type="button" class="btn btn-danger btn-sm" onclick="removeTestCase(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
<!--                <td><input type="hidden" name="hiddenTestCases[${index}].hidden" value="true"></td>-->
            `;
                    hiddenTestCasesContainer.appendChild(newRow);
                });
        }

        window.addTestCase = function (containerId) {
            let container = document.getElementById(containerId);
            let rowCount = container.children.length;
            let prefix = containerId === "normalTestCasesContainer" ? "normalTestCases" : "hiddenTestCases";
            let isHidden = containerId === "hiddenTestCasesContainer";
            const selectedOption = languageSelect.options[languageSelect.selectedIndex];
            const isSqlSelected = selectedOption.textContent.trim().toUpperCase() === "SQL";
            let newRow = document.createElement("tr");
            newRow.innerHTML = `
        <td><input type="text" class="form-control" name="${prefix}[${rowCount}].input" placeholder="${isHidden ? 'Hidden ' : ''}Input"></td>
        <td><input type="text" class="form-control" name="${prefix}[${rowCount}].expectedOutput" placeholder="${isHidden ? 'Hidden ' : ''}Expected Output"></td>
        <td class="sqlTagInput" style="display: ${isSqlSelected ? 'table-cell' : 'none'};">
            <input type="text" class="form-control" name="${prefix}[${rowCount}].sqlTagNumber" placeholder="SQL Tag Number">
        </td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeTestCase(this)">
                            <i class="bi bi-trash"></i>
                    </button>
                </td>
        ${isHidden ? `<td><input type="hidden" name="${prefix}[${rowCount}].hidden" value="true"></td>` :
                `<td><input type="hidden" name="${prefix}[${rowCount}].hidden" value="false"></td>`}
    `;
            container.appendChild(newRow);
        };

        window.removeTestCase = function (button) {
            let row = button.closest('tr');
            let tbody = row.parentNode;

            if (tbody.children.length <= 1) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Delete Failed!',
                    text: 'Needs at least one test case',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
                return;
            }

            // Xóa hàng
            tbody.removeChild(row);

            // Cập nhật lại index cho tất cả các hàng còn lại
            let rows = tbody.querySelectorAll('tr');
            rows.forEach((tr, index) => {
                tr.querySelectorAll('input').forEach(input => {
                    let name = input.getAttribute('name');
                    if (name) {
                        name = name.replace(/\[\d+\]/, `[${index}]`); // Cập nhật index mới
                        input.setAttribute('name', name);
                    }
                });
            });
        };

        document.getElementById("jsonOption").addEventListener("change", toggleTestCaseMethod);
        document.getElementById("uiOption").addEventListener("change", toggleTestCaseMethod);
        languageSelect.addEventListener("change", toggleSqlFields);

        toggleTestCaseMethod();
        toggleSqlFields();

    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('editForm'); // Adjust selector if needed

        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default submission initially

            validateTestCases().then(isValid => {
                if (isValid) {
                    form.submit(); // Submit the form if validation passes
                }
            });
        });

        async function validateTestCases() {
            const jsonOptionSelected = document.getElementById('jsonOption').checked;

            if (jsonOptionSelected) {
                const testCasesJson = document.getElementById('testCases').value.trim();

                //Wrong JSON format
                if (!testCasesJson) {
                    await Swal.fire({
                        title: 'Error!',
                        text: 'Please enter test cases in JSON format.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return false;
                }

                try {
                    const parsedJson = JSON.parse(testCasesJson);

                    //JSON null or blank test case
                    if (!Array.isArray(parsedJson) || parsedJson.length === 0) {
                        await Swal.fire({
                            title: 'Error!',
                            text: 'Please enter valid test cases in JSON format.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        return false;
                    }

                    //Check if input, expected output or hidden is null
                    for (const testCase of parsedJson) {
                        if (!testCase.input.trim() || !testCase.expectedOutput.trim()) {
                            await Swal.fire({
                                title: 'Validation Error!',
                                text: 'Each test case must have a non-empty input and expectedOutput field.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                            return false;
                        }
                    }
                } catch (e) {
                    await Swal.fire({
                        title: 'Invalid JSON',
                        text: 'Invalid JSON format. Please check your test cases.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return false;
                }
            } else {
                const normalTestCases = document.getElementById('normalTestCasesContainer').getElementsByTagName('tr');
                const hiddenTestCases = document.getElementById('hiddenTestCasesContainer').getElementsByTagName('tr');

                //Check if there are more than 1 test case input in
                if (normalTestCases.length === 0 && hiddenTestCases.length === 0) {
                    await Swal.fire({
                        title: 'No Test Cases',
                        text: 'Please add at least one test case.',
                        icon: 'warning',
                        confirmButtonText: 'OK'
                    });
                    return false;
                }
            }
            return true;
        }
    });

    let removedTagIds = []; // Mảng lưu các tag ID đã bị xóa

    function handleTagSelection(checkbox) {
        let selectedTagsDiv = document.getElementById("selected-tags");
        let tagIdsInput = document.getElementById("tagIds");
        let tagLabel = checkbox.nextElementSibling.textContent;
        const tagId = checkbox.value;

        if (checkbox.checked) {
            // Add tag badge
            let tagSpan = document.createElement("span");
            tagSpan.className = "badge me-2";
            tagSpan.textContent = tagLabel;
            tagSpan.setAttribute("data-value", tagId);
            tagSpan.style.cursor = "pointer";
            tagSpan.onclick = function () {
                removeTag(tagSpan, checkbox);
            };
            selectedTagsDiv.appendChild(tagSpan);

            // Remove from removedTagIds if it exists
            const index = removedTagIds.indexOf(tagId);
            if (index > -1) {
                removedTagIds.splice(index, 1);
            }
        } else {
            // Remove tag badge
            let existingTag = selectedTagsDiv.querySelector(
                `span[data-value="${tagId}"]`
            );
            if (existingTag) {
                existingTag.remove();
            }

            // Add to removedTagIds if it's not a new tag
            if (!removedTagIds.includes(tagId)) {
                removedTagIds.push(tagId);
            }
        }

        updateHiddenInput();
    }

    function removeTag(tagSpan, checkbox) {
        // If checkbox is provided, uncheck it
        if (checkbox) {
            checkbox.checked = false;
        } else {
            // If checkbox not provided, find and uncheck it
            let checkboxId = "tag-" + tagSpan.getAttribute("data-value");
            let checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.checked = false;
            }
        }

        const tagId = tagSpan.getAttribute("data-value");
        // Add to removedTagIds if it's not already there
        if (!removedTagIds.includes(tagId)) {
            removedTagIds.push(tagId);
        }

        // Remove the tag span
        tagSpan.remove();
        updateHiddenInput();
    }

    function updateHiddenInput() {
        let selectedTagsDiv = document.getElementById("selected-tags");
        let tagIdsInput = document.getElementById("tagIds");
        let removedTagIdsInput = document.getElementById("removedTagIds");

        let selectedTags = [];
        selectedTagsDiv.querySelectorAll("span").forEach(span => {
            selectedTags.push(span.getAttribute("data-value"));
        });

        // Update tagIds input
        tagIdsInput.value = selectedTags.join(",");

        // Update removedTagIds input
        removedTagIdsInput.value = removedTagIds.join(",");
    }

    function toggleTagDropdown(event) {
        event.stopPropagation();
        document.getElementById("tagDropdown").classList.toggle("show");
    }

    // Close dropdown when clicking outside
    window.onclick = function (event) {
        if (
            !event.target.matches(".tag-dropdown-btn") &&
            !event.target.matches(".tag-checkbox-item") &&
            !event.target.matches(".form-check-input") &&
            !event.target.matches(".form-check-label")
        ) {
            var dropdowns = document.getElementsByClassName(
                "tag-dropdown-content"
            );
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains("show")) {
                    openDropdown.classList.remove("show");
                }
            }
        }
    };

    // Initialize selected tags on page load
    document.addEventListener("DOMContentLoaded", function () {
        const selectedTagsDiv = document.getElementById("selected-tags");
        document
            .querySelectorAll(".tag-checkbox-item input:checked")
            .forEach(checkbox => {
                const tagLabel = checkbox.nextElementSibling.textContent;
                const tagId = checkbox.value;

                let tagSpan = document.createElement("span");
                tagSpan.className = "badge me-2";
                tagSpan.textContent = tagLabel;
                tagSpan.setAttribute("data-value", tagId);
                tagSpan.style.cursor = "pointer";
                tagSpan.onclick = function () {
                    removeTag(tagSpan, checkbox);
                };
                selectedTagsDiv.appendChild(tagSpan);
            });
    });

    function filterTags(input) {
        const filter = input.value.toLowerCase();
        const items = document.getElementsByClassName('tag-checkbox-item');

        for (let item of items) {
            const label = item.getElementsByTagName('label')[0];
            const text = label.textContent || label.innerText;
            item.style.display = text.toLowerCase().includes(filter) ? '' : 'none';
        }
    }

    function clearSearchInput() {
        const input = document.getElementById('tagSearch');
        input.value = ''; // Xóa nội dung input
        filterTags(input); // Gọi lại hàm lọc để cập nhật danh sách tags
        input.focus(); // Đưa con trỏ về input
    }

    // Hàm xóa tất cả checkbox
    function clearAllCheckboxes() {
        const checkboxes = document.querySelectorAll('.tag-checkbox-item input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            handleTagSelection(checkbox); // Gọi hàm xử lý nếu cần
        });
    }

    function toggleClearIcon() {
        const input = document.getElementById('tagSearch');
        const clearIcon = document.querySelector('.clear-search-icon');
        if (input.value.length > 0) {
            clearIcon.classList.add('active');
        } else {
            clearIcon.classList.remove('active');
        }
    }

    document.getElementById("tagRedirect").href += encodeURIComponent(window.location.href);
</script>
<script th:if="${error}">
    Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: '[[${error}]]',
        timer: 2000,
        timerProgressBar: true,
        showConfirmButton: false,
    });
</script>
<script>

    function saveAndGoBack() {
        sessionStorage.setItem("shouldFilterOnce", "true");
        goBackWithFilters();// Đánh dấu để lọc
    }
    function goBackWithFilters() {
        const language = sessionStorage.getItem("selectedLanguage") || "";
        const level = sessionStorage.getItem("selectedLevel") || "";
        const selectedTags = JSON.parse(sessionStorage.getItem("selectedTags")) || [];
        const currentPage = sessionStorage.getItem("currentPage") || 0;
        const searchTitle = sessionStorage.getItem("searchTitle") || "";

        let queryParams = new URLSearchParams();
        if (searchTitle) queryParams.append("title", searchTitle);
        if (currentPage) queryParams.append("page", currentPage);
        if (language) queryParams.append("language", language);
        if (level) queryParams.append("level", level);
        if (selectedTags.length > 0) {
            selectedTags.forEach(tag => queryParams.append("tags", tag));
        }

        // Điều hướng về danh sách với tham số bộ lọc
        window.location.href = "/exercises?" + queryParams.toString();
    }

</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tagRedirect = document.getElementById("tagRedirect");

        if (tagRedirect) {
            // Lấy URL hiện tại và lưu vào localStorage trước khi chuyển trang
            const currentUrl = window.location.href;
            localStorage.setItem("redirectBack", currentUrl);

            // Chuyển hướng đến tag.html với tham số redirect
            tagRedirect.href = `/category?redirect=${encodeURIComponent(currentUrl)}`;
        }
    });
</script>
</body>
</html>