<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Add New Exercise</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<style>
    .cke_notification {
        display: none !important;
    }
    .hidden{
        display: none;
    }
</style>
<body onload="toggleTestCaseMethod()">

<div class="container mt-4">
    <h2 class="text-center">Add New Exercise</h2>

    <!-- Display error if present -->
    <div th:if="${error}" class="alert alert-danger text-center">
        <span th:text="${error}"></span>
    </div>

    <form th:action="@{/exercises/create}" method="post" th:object="${exercise}" id="create-ex-form"
          onsubmit="return false;">
        <!-- Exercise Title -->
        <div class="mb-3">
            <label for="name" class="form-label">Title</label>
            <input type="text" class="form-control" id="name" th:field="*{name}" placeholder="Enter title" required>
            <div class="text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
        </div>

        <!-- Programming Language -->
        <div class="mb-3">
            <label for="language" class="form-label">Programming Language</label>
            <select class="form-select" id="language" th:field="*{language}" required>
                <option value="">-- Select Language --</option>
                <option th:each="lang : ${programmingLanguages}" th:value="${lang.id}"
                        th:text="${lang.language}"></option>
                <div class="text-danger" th:if="${#fields.hasErrors('language')}" th:errors="*{language}"></div>
            </select>
        </div>

        <!-- Exercise Description -->
        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" th:field="*{description}" required></textarea>
            <div class="text-danger" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
        </div>

        <!-- Setup Code -->
        <div class="mb-3">
            <label for="setup" class="form-label">Setup Code</label>
            <textarea class="form-control" id="setup" th:field="*{setup}" rows="13"></textarea>
        </div>

        <!-- Setup Code for SQL -->
        <div class="mb-3 hidden" data-sql>
            <label for="setup_for_sql" class="form-label">Setup Code (SQL)</label>
            <textarea class="form-control" id="setup_for_sql" name="setup_for_sql" rows="5"></textarea>
        </div>

        <!-- Difficulty Level -->
        <div class="mb-3">
            <label for="level" class="form-label">Difficulty Level</label>
            <select class="form-select" id="level" th:field="*{level}">
                <option th:each="lvl : ${T(com.example.exercise.Exercise.Level).values()}" th:value="${lvl}"
                        th:text="${lvl}"></option>
            </select>
            <div class="text-danger" th:if="${#fields.hasErrors('level')}" th:errors="*{level}"></div>
        </div>

        <!-- Select Test Case Input Method -->
        <div class="mb-3">
            <label class="form-label d-block">Select Test Case Input Method</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" id="jsonOption" name="testCaseMethod" value="json" checked
                       onclick="toggleTestCaseMethod()">
                <label class="form-check-label" for="jsonOption">Enter as JSON</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" id="uiOption" name="testCaseMethod" value="ui"
                       onclick="toggleTestCaseMethod()">
                <label class="form-check-label" for="uiOption">Add Manually</label>
            </div>
        </div>

        <!-- JSON Input Method -->
        <div id="jsonInputDiv">
            <label for="testCases" class="form-label">Test Cases (JSON Format)</label>
            <textarea class="form-control" id="testCases"
                      name="testCasesJson">[{"input": " ", "expectedOutput": " "}]</textarea>
        </div>

        <!-- Manual UI Input Method with Tabs -->
        <div id="uiInputDiv" style="display: none;">
            <label class="form-label">Test Cases</label>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" id="testCaseTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="normal-tab" data-bs-toggle="tab" href="#normalTestCases" role="tab">Test
                        Cases</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="hidden-tab" data-bs-toggle="tab" href="#hiddenTestCases" role="tab">Hidden
                        Test Cases</a>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content mt-2" id="testCaseTabContent">
                <!-- Normal Test Cases Tab -->
                <div class="tab-pane fade show active" id="normalTestCases" role="tabpanel">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Input</th>
                            <th>Expected Output</th>
                            <th class="tagSQLColumn" style="display: none;">Tag SQL</th>
                        </tr>
                        </thead>
                        <tbody id="normalTestCasesContainer">
                        <tr th:each="testCase, stat : ${testCaseFormList.testCasesList}">
                            <td>
                                <input type="text" class="form-control"
                                       th:name="|testCaseFormList.testCasesList[${stat.index}].input|"
                                       th:value="${testCase.input}" placeholder="Input" required>
                            </td>
                            <td>
                                <input type="text" class="form-control"
                                       th:name="|testCaseFormList.testCasesList[${stat.index}].expectedOutput|"
                                       th:value="${testCase.expectedOutput}" placeholder="Expected Output" required>
                            </td>
                            <!-- Tag SQL trong bảng Test Case -->
                            <td class="tagSQLColumn hidden" data-sql>
                                <input type="text" class="form-control"
                                       th:name="|testCaseFormList.testCasesList[${stat.index}].sqlTagNumber|"
                                       th:value="${testCase.sqlTagNumber}" placeholder="Tag SQL">
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-success btn-sm"
                            onclick="addTestCase('normalTestCasesContainer')">+
                    </button>
                    <button type="button" class="btn btn-danger btn-sm"
                            onclick="removeLastTestCase('normalTestCasesContainer')">-
                    </button>
                </div>

                <!-- Hidden Test Cases Tab -->
                <div class="tab-pane fade" id="hiddenTestCases" role="tabpanel">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Input</th>
                            <th>Expected Output</th>
<!--                            <th class="tagSQLColumn " style="display: none;">Tag SQL</th>-->
                            <th class="tagSQLColumn hidden" data-sql>Tag SQL</th>
                        </tr>
                        </thead>
                        <tbody id="hiddenTestCasesContainer">
                        <tr>
                            <td><input type="text" class="form-control" name="hiddenTestCases[0].input"
                                       placeholder="HiddenInput" ></td>
                            <td><input type="text" class="form-control" name="hiddenTestCases[0].expectedOutput"
                                       placeholder="HiddenExpected Output" ></td>
                            <td><input type="text" class="form-control" name="hiddenTestCase[0].sqlTagNumber" placeholder="Tag SQL" value=" "></td>
                        </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-success btn-sm"
                            onclick="addTestCase('hiddenTestCasesContainer')">+
                    </button>
                    <button type="button" class="btn btn-danger btn-sm"
                            onclick="removeLastTestCase('hiddenTestCasesContainer')">-
                    </button>
                </div>
            </div>
        </div>

        <!-- Centered Save Exercise Button -->
        <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn btn-primary">Save Exercise</button>
            <a href="#" th:href="@{/exercises}" class="btn btn-secondary ms-2">Back to List</a>
        </div>
    </form>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.ckeditor.com/4.20.2/standard/ckeditor.js"></script>
<script>

    // 1. Cấu hình CKEditor
    // ==========================
    CKEDITOR.replace('description', {
        removePlugins: 'easyimage, cloudservices, toolbar, format, styles, link',
        allowedContent: 'p; br; strong; em; u', // Chỉ cho phép các thẻ cơ bản
        extraAllowedContent: '',
        enterMode: CKEDITOR.ENTER_BR
    });

    // ==========================
    // 2. Lấy dữ liệu dạng plain text từ CKEditor
    // ==========================
    function getPlainTextFromCKEditor() {
        const editorData = CKEDITOR.instances.description.getData();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editorData;
        return tempDiv.textContent || tempDiv.innerText || '';
    }

    // ==========================
    // 3. Xử lý submit form
    // ==========================
    $(document).ready(function () {
        let isSubmitting = false;

        $("#create-ex-form").submit(function (event) {
            event.preventDefault();
            if (isSubmitting) return;
            isSubmitting = true;
            $("button[type=submit]").prop("disabled", true);

            // Cập nhật nội dung CKEditor
            for (var instance in CKEDITOR.instances) {
                CKEDITOR.instances[instance].updateElement();
            }

            // Lấy plain text từ CKEditor
            const plainText = getPlainTextFromCKEditor();
            let formData = new FormData(this);
            formData.set('description', plainText); // Ghi đè description bằng plain text

            $.ajax({
                type: "POST",
                url: "/exercises/create",
                processData: false,
                contentType: false,
                data: formData,
                success: function (response) {
                    alert("Exercise created successfully!");
                    window.location.href = "/exercises";
                },
                error: function (xhr) {
                    alert("Error: " + xhr.responseText);
                    $("button[type=submit]").prop("disabled", false);
                    isSubmitting = false;
                }
            });
        });
    });

    // ==========================
    // 4. Chuyển đổi giữa nhập test case bằng JSON hoặc UI
    // ==========================
    function toggleTestCaseMethod() {
        const isJsonSelected = document.getElementById('jsonOption').checked;
        document.getElementById('jsonInputDiv').style.display = isJsonSelected ? 'block' : 'none';
        document.getElementById('uiInputDiv').style.display = isJsonSelected ? 'none' : 'block';

        document.getElementById('testCases').disabled = !isJsonSelected;
    }

    // ==========================
    // 5. Thêm / Xóa test case
    // ==========================
    function addTestCase(containerId) {
        let container = document.getElementById(containerId);
        let rowCount = container.children.length;
        let isHiddenTestCase = containerId === 'hiddenTestCasesContainer';
        let prefix = isHiddenTestCase ? 'hiddenTestCases' : 'testCaseFormList.testCasesList';

        // Kiểm tra ngôn ngữ đang chọn
        let languageSelect = document.getElementById("language");
        let selectedLang = languageSelect.options[languageSelect.selectedIndex]?.text;
        let isSQL = selectedLang === "SQL";

        // Định nghĩa placeholder dựa vào loại test case
        let inputPlaceholder = isHiddenTestCase ? "HiddenInput" : "Input";
        let expectedOutputPlaceholder = isHiddenTestCase ? "HiddenExpectedOutput" : "Expected Output";
        let sqlTagPlaceholder = isHiddenTestCase ? "HiddenTagSQL" : "Tag SQL";

        let newRow = document.createElement('tr');
        newRow.innerHTML = `
        <td><input type="text" class="form-control" name="${prefix}[${rowCount}].input" placeholder="${inputPlaceholder}"></td>
        <td><input type="text" class="form-control" name="${prefix}[${rowCount}].expectedOutput" placeholder="${expectedOutputPlaceholder}"></td>
        ${isSQL ? `<td class="tagSQLColumn"><input type="text" class="form-control" name="${prefix}[${rowCount}].sqlTagNumber" placeholder="${sqlTagPlaceholder}"></td>` : ''}
    `;

        container.appendChild(newRow);
    }





    function removeLastTestCase(containerId) {
        let container = document.getElementById(containerId);
        if (container.children.length > 1) {
            container.removeChild(container.lastElementChild);
        }
    }

    // ==========================
    // 6. Kiểm tra JSON hợp lệ trước khi submit
    // ==========================
    document.querySelector('form').addEventListener('submit', function (event) {
        const isJsonSelected = document.getElementById('jsonOption').checked;
        if (isJsonSelected) {
            const testCases = document.getElementById('testCases').value;
            try {
                JSON.parse(testCases);
            } catch (e) {
                event.preventDefault();
                alert('Invalid JSON format. Please correct it before submitting.');
            }
        }
    });

    // ==========================
    // 7. Xử lý khi chọn ngôn ngữ là SQL
    // ==========================
    document.addEventListener("DOMContentLoaded", function () {
        const languageSelect = document.getElementById("language");

        function updateSQLUI() {
            const selectedLang = languageSelect.options[languageSelect.selectedIndex]?.text;
            const isSQL = selectedLang === "SQL";

            document.querySelectorAll("[data-sql]").forEach(el => {
                el.classList.toggle("hidden", !isSQL);
                const input = el.querySelector("input, textarea");
                if (input) {
                    if (!isSQL) {
                        input.setAttribute("data-original-value", input.value);
                        input.value = "";
                        input.removeAttribute("placeholder");
                    } else {
                        input.value = input.getAttribute("data-original-value") || "";
                        if (input.tagName.toLowerCase() === "textarea") {
                            input.setAttribute("placeholder", "SQL setup...");
                        }
                    }
                    input.required = false;
                }
            });

            document.querySelectorAll(".tagSQLColumn").forEach(col => {
                col.style.display = isSQL ? "table-cell" : "none";
            });

            document.querySelectorAll("input[name$='.sqlTagNumber']").forEach(input => {
                input.parentElement.style.display = isSQL ? "table-cell" : "none";
                if (!isSQL) {
                    input.setAttribute("data-original-value", input.value);
                    input.value = "";
                    input.removeAttribute("placeholder");
                } else {
                    input.value = input.getAttribute("data-original-value") || "";
                    input.setAttribute("placeholder", "Tag SQL...");
                }
                input.required = false;
            });
        }

        languageSelect.addEventListener("change", updateSQLUI);
        updateSQLUI(); // Gọi ngay khi trang tải
    });




</script>
</body>
</html>