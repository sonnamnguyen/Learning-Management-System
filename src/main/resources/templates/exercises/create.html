<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Add New Exercise</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .cke_notification {
            display: none !important;
        }

        .hidden {
            display: none;
        }

        #testCases {
            width: 100%;
            min-width: 600px;
            resize: horizontal;
        }

        .btn-circle {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
    </style>
</head>
<body onload="toggleTestCaseMethod(); updateJSONSample();">

<div class="container mt-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h2 class="text-center">Add New Exercise</h2>
        </div>
        <div class="card-body">
            <!-- Display error if present -->
            <div th:if="${error}" class="alert alert-danger text-center">
                <span th:text="${error}"></span>
            </div>

            <form th:action="@{/exercises/create}" method="post" th:object="${exercise}" id="create-ex-form">
                <!-- Exercise Title -->
                <div class="mb-3">
                    <label for="name" class="form-label">Title</label>
                    <input type="text" class="form-control" id="name" th:field="*{name}" placeholder="Enter title"
                           required>
                    <div class="text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                </div>

                <!-- Programming Language -->
                <div class="mb-3">
                    <label for="language" class="form-label">Programming Language</label>
                    <select class="form-select" id="language" th:field="*{language}" required
                            onchange="updateJSONSample(); updateSQLUI();">
                        <option value="">-- Select Language --</option>
                        <option th:each="lang : ${programmingLanguages}" th:value="${lang.id}"
                                th:text="${lang.language}"></option>
                    </select>
                    <div class="text-danger" th:if="${#fields.hasErrors('language')}" th:errors="*{language}"></div>
                </div>

                <!-- Exercise Description -->
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" th:field="*{description}" required></textarea>
                    <div class="text-danger" th:if="${#fields.hasErrors('description')}"
                         th:errors="*{description}"></div>
                </div>

                <!-- Setup Code -->
                <div class="mb-3">
                    <label for="setup" class="form-label">Setup Code</label>
                    <textarea class="form-control" id="setup" th:field="*{setup}" rows="13"></textarea>
                </div>

                <!-- Setup Code for SQL -->
                <div class="mb-3 hidden" data-sql>
                    <label for="setup_for_sql" class="form-label">Setup Code (SQL)</label>
                    <textarea class="form-control" id="setup_for_sql" name="setup_for_sql" rows="5"></textarea>
                </div>

                <!-- Difficulty Level -->
                <div class="mb-3">
                    <label for="level" class="form-label">Difficulty Level</label>
                    <select class="form-select" id="level" th:field="*{level}">
                        <option th:each="lvl : ${T(com.example.student_exercise_attemp.model.Exercise.Level).values()}" th:value="${lvl}"
                                th:text="${lvl}"></option>
                    </select>
                    <div class="text-danger" th:if="${#fields.hasErrors('level')}" th:errors="*{level}"></div>
                </div>

                <!-- Select Test Case Input Method -->
                <div class="mb-3">
                    <label class="form-label d-block">Select Test Case Input Method</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="jsonOption" name="testCaseMethod" value="json"
                               checked onclick="toggleTestCaseMethod()">
                        <label class="form-check-label" for="jsonOption">Enter as JSON</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" id="uiOption" name="testCaseMethod" value="ui"
                               onclick="toggleTestCaseMethod()">
                        <label class="form-check-label" for="uiOption">Add Manually</label>
                    </div>
                </div>

                <!-- JSON Input Method -->
                <div id="jsonInputDiv">
                    <label for="testCases" class="form-label">Test Cases (JSON Format)</label>
                    <textarea class="form-control" id="testCases" name="testCasesJson" required>[{"input":" ","expectedOutput":" ","hidden":false},{"input":" ","expectedOutput":" ","hidden":true}]</textarea>
                </div>

                <!-- Manual UI Input Method with Tabs -->
                <div id="uiInputDiv" style="display: none;">
                    <label class="form-label">Test Cases</label>

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs" id="testCaseTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="normal-tab" data-bs-toggle="tab" href="#normalTestCases"
                               role="tab">Test Cases</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="hidden-tab" data-bs-toggle="tab" href="#hiddenTestCases" role="tab">Hidden
                                Test Cases</a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-2" id="testCaseTabContent">
                        <!-- Normal Test Cases Tab -->
                        <div class="tab-pane fade show active" id="normalTestCases" role="tabpanel">
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Input</th>
                                    <th>Expected Output</th>
                                    <th class="tagSQLColumn hidden" data-sql>Tag SQL</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody id="normalTestCasesContainer">
                                <tr th:each="testCase, stat : ${testCaseFormList.testCasesList}">
                                    <td>
                                        <input type="text" class="form-control testcase-input"
                                               th:name="|testCaseFormList.testCasesList[${stat.index}].input|"
                                               th:value="${testCase.input}" placeholder="Input">
                                    </td>
                                    <td>
                                        <input type="text" class="form-control testcase-input"
                                               th:name="|testCaseFormList.testCasesList[${stat.index}].expectedOutput|"
                                               th:value="${testCase.expectedOutput}" placeholder="Expected Output">
                                    </td>
                                    <td class="tagSQLColumn hidden" data-sql>
                                        <input type="text" class="form-control"
                                               th:name="|testCaseFormList.testCasesList[${stat.index}].sqlTagNumber|"
                                               th:value="${testCase.sqlTagNumber}" placeholder="Tag SQL">
                                    </td>
                                    <td>
                                        <button title="Delete" type="button" class="btn btn-danger btn-sm"
                                                onclick="removeTestCase(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <input type="hidden"
                                               th:name="|testCaseFormList.testCasesList[${stat.index}].hidden|"
                                               value="false">
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-success btn-sm"
                                    onclick="addTestCase('normalTestCasesContainer')">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>

                        <!-- Hidden Test Cases Tab -->
                        <div class="tab-pane fade" id="hiddenTestCases" role="tabpanel">
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Input</th>
                                    <th>Expected Output</th>
                                    <th class="tagSQLColumn hidden" data-sql>Tag SQL</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody id="hiddenTestCasesContainer">
                                <tr>
                                    <td><input type="text" class="form-control" name="hiddenTestCases[0].input"
                                               placeholder="HiddenInput"></td>
                                    <td><input type="text" class="form-control" name="hiddenTestCases[0].expectedOutput"
                                               placeholder="HiddenExpected Output"></td>
                                    <td class="tagSQLColumn hidden" data-sql><input type="text" class="form-control"
                                                                                    name="hiddenTestCases[0].sqlTagNumber"
                                                                                    placeholder="HiddenTag SQL"></td>
                                    <td>
                                        <button title="Delete" type="button" class="btn btn-danger btn-sm"
                                                onclick="removeTestCase(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <input type="hidden" name="hiddenTestCases[0].hidden" value="true">
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-success btn-sm"
                                    onclick="addTestCase('hiddenTestCasesContainer')">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Centered Save Exercise Button -->
                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-primary">Add Exercise</button>
                    <a href="#" th:href="@{/exercises}" class="btn btn-secondary ms-2">Back to List</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.ckeditor.com/4.20.2/standard/ckeditor.js"></script>
<script>
    CKEDITOR.replace('description', {
        removePlugins: 'easyimage, cloudservices, toolbar, format, styles, link',
        allowedContent: 'p; br; strong; em; u',
        extraAllowedContent: '',
        enterMode: CKEDITOR.ENTER_BR
    });

    function getPlainTextFromCKEditor() {
        const editorData = CKEDITOR.instances.description.getData();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editorData;
        return tempDiv.textContent || tempDiv.innerText || '';
    }

    $(document).ready(function () {
        let isSubmitting = false;

        $("#create-ex-form").submit(function (event) {
            event.preventDefault();
            if (isSubmitting) return;
            isSubmitting = true;
            $("button[type=submit]").prop("disabled", true);

            for (var instance in CKEDITOR.instances) {
                CKEDITOR.instances[instance].updateElement();
            }

            const plainText = getPlainTextFromCKEditor();
            let formData = new FormData(this);
            formData.set('description', plainText);

            $.ajax({
                type: "POST",
                url: "/exercises/create",
                processData: false,
                contentType: false,
                data: formData,
                success: function (response) {
                    alert("Exercise created successfully!");
                    window.location.href = "/exercises";
                },
                error: function (xhr) {
                    alert("Error: " + xhr.responseText);
                    $("button[type=submit]").prop("disabled", false);
                    isSubmitting = false;
                }
            });
        });
    });

    function toggleTestCaseMethod() {
        const isJsonSelected = document.getElementById('jsonOption').checked;
        const jsonInputDiv = document.getElementById('jsonInputDiv');
        const uiInputDiv = document.getElementById('uiInputDiv');
        const jsonTextarea = document.getElementById('testCases');

        jsonInputDiv.style.display = isJsonSelected ? 'block' : 'none';
        uiInputDiv.style.display = isJsonSelected ? 'none' : 'block';

        // JSON required khi chọn JSON
        jsonTextarea.required = isJsonSelected;

        // Normal Test Cases required khi chọn UI
        const normalTestCaseInputs = document.querySelectorAll('#normalTestCasesContainer .testcase-input');
        normalTestCaseInputs.forEach(input => {
            input.required = !isJsonSelected;
        });

        // Hidden Test Cases không required trong mọi trường hợp
        const hiddenTestCaseInputs = document.querySelectorAll('#hiddenTestCasesContainer input:not([name$=".sqlTagNumber"]):not([name$=".hidden"])');
        hiddenTestCaseInputs.forEach(input => {
            input.required = false;
        });

        // sqlTagNumber không required trong mọi trường hợp
        const sqlTagInputs = document.querySelectorAll('input[name$=".sqlTagNumber"]');
        sqlTagInputs.forEach(input => {
            input.required = false;
        });

        jsonTextarea.disabled = !isJsonSelected;
    }

    function addTestCase(containerId) {
        let container = document.getElementById(containerId);
        let rowCount = container.children.length;
        let isHiddenTestCase = containerId === 'hiddenTestCasesContainer';
        let prefix = isHiddenTestCase ? 'hiddenTestCases' : 'testCaseFormList.testCasesList';

        let languageSelect = document.getElementById("language");
        let selectedLang = languageSelect.options[languageSelect.selectedIndex]?.text;
        let isSQL = selectedLang === "SQL";

        let inputPlaceholder = isHiddenTestCase ? "HiddenInput" : "Input";
        let expectedOutputPlaceholder = isHiddenTestCase ? "HiddenExpected Output" : "Expected Output";
        let sqlTagPlaceholder = isHiddenTestCase ? "HiddenTag SQL" : "Tag SQL";

        let newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control ${isHiddenTestCase ? '' : 'testcase-input'}" name="${prefix}[${rowCount}].input" placeholder="${inputPlaceholder}"></td>
            <td><input type="text" class="form-control ${isHiddenTestCase ? '' : 'testcase-input'}" name="${prefix}[${rowCount}].expectedOutput" placeholder="${expectedOutputPlaceholder}"></td>
            ${isSQL ? `<td class="tagSQLColumn"><input type="text" class="form-control" name="${prefix}[${rowCount}].sqlTagNumber" placeholder="${sqlTagPlaceholder}"></td>` : ''}
            <td>
                <button title="Delete" type="button" class="btn btn-danger btn-sm" onclick="removeTestCase(this)">
                    <i class="bi bi-trash"></i>
                </button>
                <input type="hidden" name="${prefix}[${rowCount}].hidden" value="${isHiddenTestCase}">
            </td>
        `;
        container.appendChild(newRow);

        toggleTestCaseMethod();
    }

    function removeTestCase(button) {
        let row = button.closest('tr');
        let container = row.parentElement;
        if (container.children.length > 1) {
            container.removeChild(row);
        }
    }

    document.querySelector('form').addEventListener('submit', function (event) {
        const isJsonSelected = document.getElementById('jsonOption').checked;
        if (isJsonSelected) {
            const testCases = document.getElementById('testCases').value;
            try {
                JSON.parse(testCases);
            } catch (e) {
                event.preventDefault();
                alert('Invalid JSON format. Please correct it before submitting.');
            }
        }
    });

    function updateJSONSample() {
        const languageSelect = document.getElementById("language");
        const jsonTextarea = document.getElementById("testCases");
        const selectedLang = languageSelect.options[languageSelect.selectedIndex]?.text;
        const isSQL = selectedLang === "SQL";

        let sampleJSON;
        if (isSQL) {
            sampleJSON = '[{"input":" ","expectedOutput":" ","sqlTagNumber":" ","hidden":false},{"input":" ","expectedOutput":" ","sqlTagNumber":" ","hidden":true}]';
        } else {
            sampleJSON = '[{"input":" ","expectedOutput":" ","hidden":false},{"input":" ","expectedOutput":" ","hidden":true}]';
        }

        jsonTextarea.value = sampleJSON;
    }

    document.addEventListener("DOMContentLoaded", function () {
        const languageSelect = document.getElementById("language");

        function updateSQLUI() {
            const selectedLang = languageSelect.options[languageSelect.selectedIndex]?.text;
            const isSQL = selectedLang === "SQL";

            document.querySelectorAll("[data-sql]").forEach(el => {
                el.classList.toggle("hidden", !isSQL);
                const input = el.querySelector("input, textarea");
                if (input) {
                    if (!isSQL) {
                        input.setAttribute("data-original-value", input.value);
                        input.value = "";
                        input.removeAttribute("placeholder");
                    } else {
                        input.value = input.getAttribute("data-original-value") || "";
                        if (input.tagName.toLowerCase() === "textarea") {
                            input.setAttribute("placeholder", "SQL setup...");
                        }
                    }
                    input.required = false;
                }
            });

            document.querySelectorAll(".tagSQLColumn").forEach(col => {
                col.style.display = isSQL ? "table-cell" : "none";
            });

            document.querySelectorAll("input[name$='.sqlTagNumber']").forEach(input => {
                const isHiddenTestCase = input.closest('tbody')?.id === 'hiddenTestCasesContainer';
                const placeholder = isHiddenTestCase ? "HiddenTag SQL" : "Tag SQL";

                input.parentElement.style.display = isSQL ? "table-cell" : "none";

                if (!isSQL) {
                    input.setAttribute('data-original-value', input.value || '');
                    input.value = '';
                    input.removeAttribute('placeholder');
                } else {
                    input.value = input.getAttribute('data-original-value') || '';
                    input.setAttribute('placeholder', placeholder);
                }
                input.required = false; // sqlTagNumber không bắt buộc trong mọi trường hợp
            });
        }

        languageSelect.addEventListener("change", updateSQLUI);
        updateSQLUI();
    });
</script>
</body>
</html>