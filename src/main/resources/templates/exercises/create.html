<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Add New Exercise</title>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="path/to/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
    <style>
        .cke_notification {
            display: none !important;
        }

        .hidden {
            display: none;
        }

        #testCases {
            width: 100%;
            min-width: 600px;
            resize: horizontal;
        }

        .btn-circle {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /*.tag-container {*/
        /*    display: flex;*/
        /*    align-items: center;*/
        /*    gap: 8px; !* Tạo khoảng cách giữa chữ "Tags" và nút "+" *!*/
        /*}*/

        /*.tag-button {*/
        /*    width: 24px;*/
        /*    height: 24px;*/
        /*    font-size: 16px;*/
        /*    font-weight: bold;*/
        /*    text-align: center;*/
        /*    display: flex;*/
        /*    align-items: center;*/
        /*    justify-content: center;*/
        /*    border-radius: 50%;*/
        /*    transition: background-color 0.3s, transform 0.2s;*/
        /*}*/

        /*.tag-button:hover {*/
        /*    background-color: #0056b3;*/
        /*    transform: scale(1.1);*/
        /*}*/

        /*.tag-button:active {*/
        /*    transform: scale(0.9);*/
        /*}*/
        /* Container chính cho tags */
        .tag-container {
            display: flex;
            align-items: center; /* Căn giữa theo chiều dọc */
            gap: 10px; /* Khoảng trắng giữa label và nút + */
            margin-bottom: 15px;
        }

        /* Label styling */
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0; /* Loại bỏ margin-bottom để không tạo khoảng trống thừa */
        }

        /* Style cho nút + */
        .tag-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px; /* Kích thước nút */
            height: 28px;
            background-color: #007bff; /* Màu nền xanh */
            color: white; /* Màu dấu + */
            font-size: 20px; /* Kích thước dấu + */
            font-weight: bold;
            text-decoration: none; /* Bỏ gạch chân của link */
            border-radius: 50%; /* Bo tròn thành hình tròn */
            transition: all 0.2s ease; /* Hiệu ứng mượt khi hover */
        }

        /* Hover effect cho nút + */
        .tag-button:hover {
            background-color: #0056b3; /* Màu xanh đậm hơn khi hover */
            transform: scale(1.1); /* Phóng to nhẹ khi hover */
        }

        /* Responsive adjustments */
        @media (max-width: 576px) {
            .tag-button {
                width: 24px;
                height: 24px;
                font-size: 18px;
            }

            .tag-container {
                gap: 8px; /* Giảm khoảng trắng trên màn hình nhỏ */
            }
        }

        /* Style cho dropdown tags */
        .tag-dropdown {
            position: relative;
            display: inline-block;
        }

        .tag-dropdown-btn {
            background-color: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            min-width: 150px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tag-dropdown-content.show {
            display: block;
        }

        .tag-checkbox-item {
            padding: 8px;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
        }

        .tag-checkbox-item:hover {
            background-color: #f1f1f1;
        }

        /* Style for selected tags container */
        #selected-tags {
            min-height: 38px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            background-color: #fff;
        }

        /* Style for each selected tag badge */
        #selected-tags .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }

        #selected-tags .badge:hover {
            background-color: #dee2e6;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #selected-tags .badge::after {
            content: "×";
            margin-left: 8px;
            font-size: 1.2rem;
            line-height: 1;
            color: #6c757d;
        }

        #selected-tags:empty::before {
            content: "No tags selected";
            color: #6c757d;
            font-style: italic;
        }
        .tag-dropdown-content {
            position: relative;
        }

        .tag-checkbox-list {
            max-height: 200px; /* Chiều cao tối đa cho danh sách checkbox */
            overflow-y: auto; /* Thêm thanh cuộn nếu cần */
            padding-bottom: 40px; /* Để nút Clear All không bị che khuất */
        }

        .clear-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px; /* Đệm để button trông cân đối */
            border-radius: 5px; /* Bo góc nhẹ */
            border: 1px solid #ced4da; /* Viền mặc định của btn-outline-secondary */
            background-color: transparent; /* Nền trong suốt */
            transition: all 0.3s ease; /* Hiệu ứng mượt mà */
        }

        /* Style cho icon broom */
        .clear-btn .fa-broom-wide {
            font-size: 1.2rem; /* Kích thước icon */
            color: #ff6666; /* Màu đỏ nhẹ như yêu cầu trước đó */
            transition: color 0.3s ease, transform 0.3s ease; /* Hiệu ứng mượt mà */
        }

        /* Hiệu ứng hover cho button */
        .clear-btn:hover {
            background-color: #f8f9fa; /* Màu nền nhạt khi hover */
            border-color: #ff6666; /* Đổi màu viền thành đỏ nhẹ */
        }

        /* Hiệu ứng hover cho icon */
        .clear-btn:hover .fa-broom-wide {
            color: #ff3333; /* Màu đỏ đậm hơn khi hover */
            transform: rotate(15deg); /* Xoay nhẹ icon khi hover */
        }

        /* Đảm bảo button không bị quá nhỏ */
        .clear-btn {
            min-width: 40px; /* Chiều rộng tối thiểu */
            height: 38px; /* Chiều cao phù hợp với input bên cạnh */
        }

        .search-container {
            position: relative;
        }

        .input-group.position-relative {
            position: relative;
        }

        .form-control {
            padding-right: 30px; /* Tạo không gian cho icon x */
        }

        /* Style cho icon x trong input */
        .clear-search-icon {
            position: absolute;
            right: 50px; /* Đặt icon x trước nút Clear Tags */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6c757d; /* Màu xám mặc định */
            font-size: 1rem;
            display: none; /* Ẩn icon khi input rỗng */
            z-index: 10; /* Đảm bảo icon nằm trên input */
            transition: color 0.3s ease;
        }

        /* Hiển thị icon x khi input có nội dung */
        .form-control:not(:placeholder-shown) ~ .clear-search-icon {
            display: block;
        }

        /* Hiệu ứng hover cho icon x */
        .clear-search-icon:hover {
            color: #ff6666; /* Màu đỏ nhẹ khi hover */
        }

    </style>
</head>
<body onload="toggleTestCaseMethod(); updateJSONSample();">
<div class="container mt-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="text-center m-0">Add New Exercise</h2>
                    <a href="https://docs.google.com/document/d/1pJQJ7eoA4__OV17WzLvmbPLgGmTj71qx/edit?usp=sharing&ouid=113705567570222338078&rtpof=true&sd=true"
                       class="btn btn-light text-primary" target="_blank">
                        <i class="bi bi-plus-circle me-1"></i> Guide
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Display error if present -->
            <div th:if="${error}" class="alert alert-danger text-center">
                <span th:text="${error}"></span>
            </div>

            <form
                    th:action="@{/exercises/create}"
                    method="post"
                    th:object="${exercise}"
                    id="create-ex-form"
                    novalidate
            >
                <!-- Exercise Title -->
                <div class="mb-3">
                    <label for="name" class="form-label">Title (*)</label>
                    <input
                            type="text"
                            class="form-control"
                            id="name"
                            th:field="*{name}"
                            placeholder="Enter title"
                            required
                    />
                    <div
                            class="text-danger"
                            th:if="${#fields.hasErrors('name')}"
                            th:errors="*{name}"
                    ></div>
                </div>

                <!-- Tag Selection -->
                <div class="mb-3">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <label for="tagIds" class="form-label mb-0">Tags</label>
                        <a href="/category" id="tagRedirect" class="tag-button">+</a>
                    </div>
                    <!-- Display selected tags -->
                    <div id="selected-tags" class="mt-2"></div>
                    <div class="tag-container">
                        <div class="tag-dropdown">
                            <button
                                    type="button"
                                    class="btn tag-dropdown-btn"
                                    onclick="toggleTagDropdown(event)"
                            >
                                Select Tags <i class="bi bi-chevron-down"></i>
                            </button>
                            <div class="tag-dropdown-content" id="tagDropdown">
                                <div class="search-container mb-2 p-2" onclick="event.stopPropagation()">
                                    <div class="input-group position-relative">
                                        <input
                                                type="text"
                                                class="form-control"
                                                id="tagSearch"
                                                placeholder="Search tags..."
                                                onkeyup="filterTags(this); toggleClearIcon()"
                                                onfocus="event.stopPropagation()"
                                        />
                                        <span class="clear-search-icon"
                                              onclick="clearSearchInput(); event.stopPropagation()">
                                            <i class="bi bi-x-lg"></i>
                                        </span>
                                        <button
                                                type="button"
                                                class="btn btn-outline-secondary clear-btn"
                                                onclick="clearAllCheckboxes(); event.stopPropagation()"
                                                title="Clear Tags"
                                        >
                                            <i class="fa-solid fa-broom-wide"></i>
                                        </button>
                                    </div>
                                </div>

                                <div th:each="t : ${tags}" class="tag-checkbox-item">
                                    <input
                                            class="form-check-input"
                                            type="checkbox"
                                            th:value="${t.id}"
                                            th:id="'tag-' + ${t.id}"
                                            onchange="handleTagSelection(this)"
                                    />
                                    <label
                                            class="form-check-label ms-2"
                                            th:for="'tag-' + ${t.id}"
                                            th:text="${t.tag}"
                                    ></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="tag" id="tagIds" />
                </div>

                <!-- Programming Language -->
                <div class="mb-3">
                    <label for="language" class="form-label"
                    >Programming Language (*)</label
                    >
                    <select
                            class="form-select"
                            id="language"
                            th:field="*{language}"
                            required
                            onchange="updateJSONSample(); updateSQLUI();"
                    >
                        <option value="">-- Select Language --</option>
                        <option
                                th:each="lang : ${programmingLanguages}"
                                th:value="${lang.id}"
                                th:text="${lang.language}"
                        ></option>
                    </select>
                    <div
                            class="text-danger"
                            th:if="${#fields.hasErrors('language')}"
                            th:errors="*{language}"
                    ></div>
                </div>

                <!-- Exercise Description -->
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea
                            class="form-control"
                            id="description"
                            th:field="*{description}"
                            required
                    ></textarea>
                    <div
                            class="text-danger"
                            th:if="${#fields.hasErrors('description')}"
                            th:errors="*{description}"
                    ></div>
                </div>

                <!-- Setup Code -->
                <div class="mb-3">
                    <label for="setup" class="form-label">Setup Code</label>
                    <textarea
                            class="form-control"
                            id="setup"
                            th:field="*{setup}"
                            rows="13"
                    ></textarea>
                </div>

                <!-- Setup Code for SQL -->
                <div class="mb-3 hidden" data-sql>
                    <label for="setup_for_sql" class="form-label"
                    >Setup Code (SQL)</label
                    >
                    <textarea
                            class="form-control"
                            id="setup_for_sql"
                            name="setup_for_sql"
                            rows="5"
                    ></textarea>
                </div>

                <!-- Difficulty Level -->
                <div class="mb-3">
                    <label for="level" class="form-label">Difficulty Level (*)</label>
                    <select class="form-select" id="level" th:field="*{level}" required>
                        <option
                                th:each="lvl : ${T(com.example.exercise.model.Exercise.Level).values()}"
                                th:value="${lvl}"
                                th:text="${lvl}"
                        ></option>
                    </select>
                    <div
                            class="text-danger"
                            th:if="${#fields.hasErrors('level')}"
                            th:errors="*{level}"
                    ></div>
                </div>

                <!-- Select Test Case Input Method -->
                <div class="mb-3">
                    <label class="form-label d-block"
                    >Select Test Case Input Method (*)</label
                    >
                    <div class="form-check">
                        <input
                                class="form-check-input"
                                type="radio"
                                id="jsonOption"
                                name="testCaseMethod"
                                value="json"
                                checked
                                onclick="toggleTestCaseMethod()"
                        />
                        <label class="form-check-label" for="jsonOption"
                        >Enter as JSON</label
                        >
                    </div>
                    <div class="form-check">
                        <input
                                class="form-check-input"
                                type="radio"
                                id="uiOption"
                                name="testCaseMethod"
                                value="ui"
                                onclick="toggleTestCaseMethod()"
                        />
                        <label class="form-check-label" for="uiOption"
                        >Add Manually</label
                        >
                    </div>
                </div>

                <!-- JSON Input Method -->
                <div id="jsonInputDiv">
                    <label for="testCases" class="form-label"
                    >Test Cases (JSON Format)</label
                    >
                    <textarea
                            class="form-control"
                            id="testCases"
                            name="testCasesJson"
                            required
                    >
[{"input":" ","expectedOutput":" ","hidden":false},{"input":" ","expectedOutput":" ","hidden":true}]</textarea
                    >
                    <div class="mt-2 d-flex gap-2 align-items-center">
                        <input type="file" id="jsonFileUpload" accept=".json" class="form-control" style="width: auto;" />
                        <button type="button" class="btn btn-primary btn-sm" onclick="uploadJsonFile()">Upload JSON</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadJsonTemplate()">Download Template</button>
                    </div>
                </div>

                <!-- Manual UI Input Method with Tabs -->
                <div id="uiInputDiv" style="display: none">
                    <label class="form-label">Test Cases</label>

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs" id="testCaseTabs" role="tablist">
                        <li class="nav-item">
                            <a
                                    class="nav-link active"
                                    id="normal-tab"
                                    data-bs-toggle="tab"
                                    href="#normalTestCases"
                                    role="tab"
                            >Test Cases</a
                            >
                        </li>
                        <li class="nav-item">
                            <a
                                    class="nav-link"
                                    id="hidden-tab"
                                    data-bs-toggle="tab"
                                    href="#hiddenTestCases"
                                    role="tab"
                            >Hidden Test Cases</a
                            >
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-2" id="testCaseTabContent">
                        <!-- Normal Test Cases Tab -->
                        <!-- Normal Test Cases Tab -->
                        <div class="tab-pane fade show active" id="normalTestCases" role="tabpanel">
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Input</th>
                                    <th>Expected Output</th>
                                    <th class="tagSQLColumn hidden" data-sql>Tag SQL</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody id="normalTestCasesContainer">
                                <tr th:each="testCase, stat : ${testCaseFormList.testCasesList}">
                                    <td>
                                        <input
                                                type="text"
                                                class="form-control testcase-input"
                                                th:name="|testCaseFormList.testCasesList[${stat.index}].input|"
                                                th:value="${testCase.input}"
                                                placeholder="Input"
                                        />
                                    </td>
                                    <td>
                                        <input
                                                type="text"
                                                class="form-control testcase-input"
                                                th:name="|testCaseFormList.testCasesList[${stat.index}].expectedOutput|"
                                                th:value="${testCase.expectedOutput}"
                                                placeholder="Expected Output"
                                        />
                                    </td>
                                    <td class="tagSQLColumn hidden" data-sql>
                                        <input
                                                type="text"
                                                class="form-control"
                                                th:name="|testCaseFormList.testCasesList[${stat.index}].sqlTagNumber|"
                                                th:value="${testCase.sqlTagNumber}"
                                                placeholder="Tag SQL"
                                        />
                                    </td>
                                    <td>
                                        <button
                                                title="Delete"
                                                type="button"
                                                class="btn btn-danger btn-sm"
                                                onclick="removeTestCase(this)"
                                        >
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <input
                                                type="hidden"
                                                th:name="|testCaseFormList.testCasesList[${stat.index}].hidden|"
                                                value="false"
                                        />
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <button
                                    type="button"
                                    class="btn btn-success btn-sm"
                                    onclick="addTestCase('normalTestCasesContainer')"
                            >
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>

                        <!-- Hidden Test Cases Tab -->
                        <div class="tab-pane fade" id="hiddenTestCases" role="tabpanel">
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th>Input</th>
                                    <th>Expected Output</th>
                                    <th class="tagSQLColumn hidden" data-sql>Tag SQL</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody id="hiddenTestCasesContainer">
                                <tr>
                                    <td>
                                        <input
                                                type="text"
                                                class="form-control"
                                                name="hiddenTestCases[0].input"
                                                placeholder="HiddenInput"
                                        />
                                    </td>
                                    <td>
                                        <input
                                                type="text"
                                                class="form-control"
                                                name="hiddenTestCases[0].expectedOutput"
                                                placeholder="HiddenExpected Output"
                                        />
                                    </td>
                                    <td class="tagSQLColumn hidden" data-sql>
                                        <input
                                                type="text"
                                                class="form-control"
                                                name="hiddenTestCases[0].sqlTagNumber"
                                                placeholder="HiddenTag SQL"
                                        />
                                    </td>
                                    <td>
                                        <button
                                                title="Delete"
                                                type="button"
                                                class="btn btn-danger btn-sm"
                                                onclick="removeTestCase(this)"
                                        >
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <input
                                                type="hidden"
                                                name="hiddenTestCases[0].hidden"
                                                value="true"
                                        />
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <button
                                    type="button"
                                    class="btn btn-success btn-sm"
                                    onclick="addTestCase('hiddenTestCasesContainer')"
                            >
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Centered Save Exercise Button -->
                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-primary">
                        Add Exercise
                    </button>
                    <a href="#" th:href="@{/exercises}" class="btn btn-secondary ms-2"
                    >Back to List</a
                    >
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.ckeditor.com/4.20.2/standard/ckeditor.js"></script>
<script>
    CKEDITOR.replace("description", {
        removePlugins:
            "easyimage, cloudservices, toolbar, format, styles, link",
        allowedContent: "p; br; strong; em; u",
        extraAllowedContent: "",
        enterMode: CKEDITOR.ENTER_BR,
    });

    function getPlainTextFromCKEditor() {
        const editorData = CKEDITOR.instances.description.getData();
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = editorData;
        return tempDiv.textContent || tempDiv.innerText || "";
    }
    // Hàm xử lý upload file JSON
    function uploadJsonFile() {
        const fileInput = document.getElementById("jsonFileUpload");
        const testCasesTextarea = document.getElementById("testCases");
        const file = fileInput.files[0];

        if (!file) {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Please select a JSON file to upload!",
                timer: 10000,
                timerProgressBar: true,
                showConfirmButton: false,
            });
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const jsonContent = JSON.parse(e.target.result);
                if (!Array.isArray(jsonContent)) {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Uploaded file must contain a JSON array!",
                        timer: 10000,
                        timerProgressBar: true,
                        showConfirmButton: false,
                    });
                    return;
                }

                // Format JSON để hiển thị đẹp hơn trong preview
                const formattedJson = JSON.stringify(jsonContent, null, 2);

                // Hiển thị preview với SweetAlert2
                Swal.fire({
                    title: "Preview JSON Content",
                    html: `<pre style="text-align: left; max-height: 300px; overflow-y: auto;">${formattedJson}</pre>`,
                    showCancelButton: true,
                    confirmButtonText: "Apply",
                    cancelButtonText: "Cancel",
                    width: "600px",
                    customClass: {
                        confirmButton: "btn btn-primary",
                        cancelButton: "btn btn-secondary",
                    },
                    buttonsStyling: false,
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Nếu người dùng nhấn "Apply", cập nhật textarea
                        testCasesTextarea.value = formattedJson;
                    }
                    // Nếu nhấn "Cancel", không làm gì cả
                });
            } catch (error) {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "Invalid JSON file: " + error.message,
                    timer: 10000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                });
            }
        };
        reader.readAsText(file);
    }

    // Hàm tải template JSON
    function downloadJsonTemplate() {
        const languageSelect = document.getElementById("language");
        const selectedLang = languageSelect.options[languageSelect.selectedIndex]?.text;
        const isSQL = selectedLang === "SQL";

        let template;
        if (isSQL) {
            template = [
                {"input": " ", "expectedOutput": " ", "sqlTagNumber": " ", "hidden": false},
                {"input": " ", "expectedOutput": " ", "sqlTagNumber": " ", "hidden": true}
            ];
        } else {
            template = [
                {"input": " ", "expectedOutput": " ", "hidden": false},
                {"input": " ", "expectedOutput": " ", "hidden": true}
            ];
        }

        const jsonString = JSON.stringify(template, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const tempLink = document.createElement("a");
        tempLink.href = url;
        tempLink.download = "test_cases_template.json";
        document.body.appendChild(tempLink);
        tempLink.click();
        document.body.removeChild(tempLink);
        URL.revokeObjectURL(url);
    }
    $(document).ready(function () {
        let isSubmitting = false;

        $("#create-ex-form").submit(function (event) {
            event.preventDefault(); // Prevent default form submission
            if (isSubmitting) return;
            isSubmitting = true;
            $("button[type=submit]").prop("disabled", true);

            // Update CKEditor content
            for (var instance in CKEDITOR.instances) {
                CKEDITOR.instances[instance].updateElement();
            }

            const plainText = getPlainTextFromCKEditor();
            let formData = new FormData(this);
            formData.set("description", plainText);

            // Kiểm tra các trường bắt buộc
            const title = $("#name").val().trim();
            const language = $("#language").val();
            const level = $("#level").val();

            // Validation cho các trường bắt buộc
            if (!title) {
                Swal.fire({
                    icon: "warning",
                    title: "Warning",
                    text: "Title is required!",
                    timer: 10000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                });
                $("button[type=submit]").prop("disabled", false);
                isSubmitting = false;
                return;
            }

            if (!language) {
                Swal.fire({
                    icon: "warning",
                    title: "Warning",
                    text: "Programming Language is required!",
                    timer: 10000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                });
                $("button[type=submit]").prop("disabled", false);
                isSubmitting = false;
                return;
            }

            if (!level) {
                Swal.fire({
                    icon: "warning",
                    title: "Warning",
                    text: "Difficulty Level is required!",
                    timer: 10000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                });
                $("button[type=submit]").prop("disabled", false);
                isSubmitting = false;
                return;
            }
            // Check if "Add Manually" is selected
            const isJsonSelected = document.getElementById("jsonOption").checked;
            if (!isJsonSelected) {
                // Validate manual test case inputs
                const normalTestCaseInputs = document.querySelectorAll(
                    "#normalTestCasesContainer .testcase-input"
                );
                let hasValidTestCase = false;

                normalTestCaseInputs.forEach(input => {
                    if (input.value.trim() !== "") {
                        hasValidTestCase = true;
                    }
                });

                if (!hasValidTestCase) {
                    // Show custom error message if no valid test case is provided
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "At least one valid test case is required!",
                        timer: 10000,
                        timerProgressBar: true,
                        showConfirmButton: false,
                    });
                    $("button[type=submit]").prop("disabled", false);
                    isSubmitting = false;
                    return; // Stop form submission
                }
            } else {
                // Validate JSON input if "Enter as JSON" is selected
                const testCases = document.getElementById("testCases").value.trim();
                if (!testCases) {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Test Cases (JSON Format) cannot be empty!",
                        timer: 10000,
                        timerProgressBar: true,
                        showConfirmButton: false,
                    });
                    $("button[type=submit]").prop("disabled", false);
                    isSubmitting = false;
                    return;
                }

                try {
                    const parsedTestCases = JSON.parse(testCases);
                    if (!Array.isArray(parsedTestCases) || parsedTestCases.length === 0) {
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: "Test Cases (JSON Format) cannot be empty or must be an array!",
                            timer: 10000,
                            timerProgressBar: true,
                            showConfirmButton: false,
                        });
                        $("button[type=submit]").prop("disabled", false);
                        isSubmitting = false;
                        return;
                    }
                } catch (e) {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Invalid JSON format: " + e.message,
                        timer: 10000,
                        timerProgressBar: true,
                        showConfirmButton: false,
                    });
                    $("button[type=submit]").prop("disabled", false);
                    isSubmitting = false;
                    return;
                }
            }

            // If validation passes, proceed with form submission
            $.ajax({
                type: "POST",
                url: "/exercises/create",
                processData: false,
                contentType: false,
                data: formData,
                success: function (response) {
                    Swal.fire({
                        icon: "success",
                        title: "Created successfully!",
                        text: response.message || "Exercise created successfully!",
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false,
                    }).then(() => {
                        window.location.href = "/exercises";
                    });
                },
                error: function (xhr) {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: xhr.responseText || "An unexpected error occurred!",
                        timer: 10000,
                        timerProgressBar: true,
                        showConfirmButton: false,
                    });
                    $("button[type=submit]").prop("disabled", false);
                    isSubmitting = false;
                },
            });
        });
    });

    function toggleTestCaseMethod() {
        const isJsonSelected = document.getElementById("jsonOption").checked;
        const jsonInputDiv = document.getElementById("jsonInputDiv");
        const uiInputDiv = document.getElementById("uiInputDiv");
        const jsonTextarea = document.getElementById("testCases");


        jsonInputDiv.style.display = isJsonSelected ? "block" : "none";
        uiInputDiv.style.display = isJsonSelected ? "none" : "block";

        // JSON required khi chọn JSON
        <!--        jsonTextarea.required = isJsonSelected;-->
        jsonTextarea.disabled = !isJsonSelected

        // Normal Test Cases required khi chọn UI
        const normalTestCaseInputs = document.querySelectorAll(
            "#normalTestCasesContainer .testcase-input"
        );
        normalTestCaseInputs.forEach(input => {
            input.required = !isJsonSelected;
        });

        // Hidden Test Cases không required trong mọi trường hợp
        const hiddenTestCaseInputs = document.querySelectorAll(
            '#hiddenTestCasesContainer input:not([name$=".sqlTagNumber"]):not([name$=".hidden"])'
        );
        hiddenTestCaseInputs.forEach(input => {
            input.required = false;
        });

        // sqlTagNumber không required trong mọi trường hợp
        const sqlTagInputs = document.querySelectorAll(
            'input[name$=".sqlTagNumber"]'
        );
        sqlTagInputs.forEach(input => {
            input.required = false;
        });

        jsonTextarea.disabled = !isJsonSelected;
    }

    function addTestCase(containerId) {
        let container = document.getElementById(containerId);
        let rowCount = container.children.length;
        let isHiddenTestCase = containerId === "hiddenTestCasesContainer";
        let prefix = isHiddenTestCase
            ? "hiddenTestCases"
            : "testCaseFormList.testCasesList";

        let languageSelect = document.getElementById("language");
        let selectedLang =
            languageSelect.options[languageSelect.selectedIndex]?.text;
        let isSQL = selectedLang === "SQL";

        let inputPlaceholder = isHiddenTestCase ? "HiddenInput" : "Input";
        let expectedOutputPlaceholder = isHiddenTestCase
            ? "HiddenExpected Output"
            : "Expected Output";
        let sqlTagPlaceholder = isHiddenTestCase ? "HiddenTag SQL" : "Tag SQL";

        let newRow = document.createElement("tr");
        newRow.innerHTML = `
        <td><input type="text" class="form-control ${
            isHiddenTestCase ? "" : "testcase-input"
        }" name="${prefix}[${rowCount}].input" placeholder="${inputPlaceholder}"></td>
        <td><input type="text" class="form-control ${
            isHiddenTestCase ? "" : "testcase-input"
        }" name="${prefix}[${rowCount}].expectedOutput" placeholder="${expectedOutputPlaceholder}"></td>
        ${
            isSQL
                ? `<td class="tagSQLColumn"><input type="text" class="form-control" name="${prefix}[${rowCount}].sqlTagNumber" placeholder="${sqlTagPlaceholder}"></td>`
                : ""
        }
        <td>
            <button title="Delete" type="button" class="btn btn-danger btn-sm" onclick="removeTestCase(this)">
                <i class="bi bi-trash"></i>
            </button>
            <input type="hidden" name="${prefix}[${rowCount}].hidden" value="${isHiddenTestCase}">
        </td>
    `;
        container.appendChild(newRow);

        toggleTestCaseMethod();
    }

    function removeTestCase(button) {
        let row = button.closest("tr");
        let container = row.parentElement;
        if (container.children.length > 1) {
            container.removeChild(row);
        }
    }

    document
        .querySelector("form")
        .addEventListener("submit", function (event) {
            const isJsonSelected = document.getElementById("jsonOption").checked;
            if (isJsonSelected) {
                const testCases = document.getElementById("testCases").value;
                try {
                    JSON.parse(testCases);
                } catch (e) {
                    event.preventDefault();
                    alert(
                        "Invalid JSON format. Please correct it before submitting."
                    );
                }
            }
        });

    function updateJSONSample() {
        const languageSelect = document.getElementById("language");
        const jsonTextarea = document.getElementById("testCases");
        const selectedLang =
            languageSelect.options[languageSelect.selectedIndex]?.text;
        const isSQL = selectedLang === "SQL";

        let sampleJSON;
        if (isSQL) {
            sampleJSON =
                '[{"input":" ","expectedOutput":" ","sqlTagNumber":" ","hidden":false},{"input":" ","expectedOutput":" ","sqlTagNumber":" ","hidden":true}]';
        } else {
            sampleJSON =
                '[{"input":" ","expectedOutput":" ","hidden":false},{"input":" ","expectedOutput":" ","hidden":true}]';
        }

        jsonTextarea.value = sampleJSON;
    }

    document.addEventListener("DOMContentLoaded", function () {
        const languageSelect = document.getElementById("language");

        function updateSQLUI() {
            const selectedLang =
                languageSelect.options[languageSelect.selectedIndex]?.text;
            const isSQL = selectedLang === "SQL";

            document.querySelectorAll("[data-sql]").forEach(el => {
                el.classList.toggle("hidden", !isSQL);
                const input = el.querySelector("input, textarea");
                if (input) {
                    if (!isSQL) {
                        input.setAttribute("data-original-value", input.value);
                        input.value = "";
                        input.removeAttribute("placeholder");
                    } else {
                        input.value = input.getAttribute("data-original-value") || "";
                        if (input.tagName.toLowerCase() === "textarea") {
                            input.setAttribute("placeholder", "SQL setup...");
                        }
                    }
                    input.required = false;
                }
            });

            document.querySelectorAll(".tagSQLColumn").forEach(col => {
                col.style.display = isSQL ? "table-cell" : "none";
            });

            document
                .querySelectorAll("input[name$='.sqlTagNumber']")
                .forEach(input => {
                    const isHiddenTestCase =
                        input.closest("tbody")?.id === "hiddenTestCasesContainer";
                    const placeholder = isHiddenTestCase
                        ? "HiddenTag SQL"
                        : "Tag SQL";

                    input.parentElement.style.display = isSQL ? "table-cell" : "none";

                    if (!isSQL) {
                        input.setAttribute("data-original-value", input.value || "");
                        input.value = "";
                        input.removeAttribute("placeholder");
                    } else {
                        input.value = input.getAttribute("data-original-value") || "";
                        input.setAttribute("placeholder", placeholder);
                    }
                    input.required = false; // sqlTagNumber không bắt buộc trong mọi trường hợp
                });
        }

        languageSelect.addEventListener("change", updateSQLUI);
        updateSQLUI();
    });

    function handleTagSelection(checkbox) {
        let selectedTagsDiv = document.getElementById("selected-tags");
        let tagIdsInput = document.getElementById("tagIds");
        let tagLabel = checkbox.nextElementSibling.textContent;

        if (checkbox.checked) {
            // Add tag badge
            let tagSpan = document.createElement("span");
            tagSpan.className = "badge me-2";
            tagSpan.textContent = tagLabel;
            tagSpan.setAttribute("data-value", checkbox.value);
            tagSpan.style.cursor = "pointer";
            tagSpan.onclick = function () {
                removeTag(tagSpan, checkbox);
            };
            selectedTagsDiv.appendChild(tagSpan);
        } else {
            // Remove tag badge
            let existingTag = selectedTagsDiv.querySelector(
                `span[data-value="${checkbox.value}"]`
            );
            if (existingTag) {
                existingTag.remove();
            }
        }

        updateHiddenInput();
    }

    function removeTag(tagSpan, checkbox) {
        // If checkbox is provided, uncheck it
        if (checkbox) {
            checkbox.checked = false;
        } else {
            // If checkbox not provided, find and uncheck it
            let checkboxId = "tag-" + tagSpan.getAttribute("data-value");
            let checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.checked = false;
            }
        }

        // Remove the tag span
        tagSpan.remove();
        updateHiddenInput();
    }

    function updateHiddenInput() {
        let selectedTagsDiv = document.getElementById("selected-tags");
        let tagIdsInput = document.getElementById("tagIds");

        let selectedTags = [];
        selectedTagsDiv.querySelectorAll("span").forEach(span => {
            selectedTags.push(span.getAttribute("data-value"));
        });

        // Assign the list of tag IDs to hidden input, separated by commas
        tagIdsInput.value = selectedTags.join(",");
    }

    // Add these new functions for tag dropdown
    function toggleTagDropdown(event) {
        event.stopPropagation();
        document.getElementById("tagDropdown").classList.toggle("show");
    }

    // Close dropdown when clicking outside
    window.onclick = function (event) {
        if (
            !event.target.matches(".tag-dropdown-btn") &&
            !event.target.matches(".tag-checkbox-item") &&
            !event.target.matches(".form-check-input") &&
            !event.target.matches(".form-check-label")
        ) {
            var dropdowns = document.getElementsByClassName(
                "tag-dropdown-content"
            );
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains("show")) {
                    openDropdown.classList.remove("show");
                }
            }
        }
    };

    function clearAllTags() {
        const checkboxes = document.querySelectorAll('#tagDropdown .form-check-input');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            const tagSpan = document.querySelector(`span[data-value="${checkbox.value}"]`);
            if (tagSpan) {
                tagSpan.remove();
            }
        });
        updateHiddenInput();
    }

    function filterTags(input) {
        const filter = input.value.toLowerCase();
        const items = document.getElementsByClassName('tag-checkbox-item');

        for (let item of items) {
            const label = item.getElementsByTagName('label')[0];
            const text = label.textContent || label.innerText;
            item.style.display = text.toLowerCase().includes(filter) ? '' : 'none';
        }
    }

    function clearSearchInput() {
        const input = document.getElementById('tagSearch');
        input.value = ''; // Xóa nội dung input
        filterTags(input); // Gọi lại hàm lọc để cập nhật danh sách tags
        input.focus(); // Đưa con trỏ về input
    }

    // Hàm xóa tất cả checkbox
    function clearAllCheckboxes() {
        const checkboxes = document.querySelectorAll('.tag-checkbox-item input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            handleTagSelection(checkbox); // Gọi hàm xử lý nếu cần
        });
    }

    function toggleClearIcon() {
        const input = document.getElementById('tagSearch');
        const clearIcon = document.querySelector('.clear-search-icon');
        if (input.value.length > 0) {
            clearIcon.classList.add('active');
        } else {
            clearIcon.classList.remove('active');
        }
    }

</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tagRedirect = document.getElementById("tagRedirect");

        if (tagRedirect) {
            // Lấy URL hiện tại và lưu vào localStorage trước khi chuyển trang
            const currentUrl = window.location.href;
            localStorage.setItem("redirectBack", currentUrl);

            // Chuyển hướng đến tag.html với tham số redirect
            tagRedirect.href = `/category?redirect=${encodeURIComponent(currentUrl)}`;
        }
    });
</script>
</body>
</html>