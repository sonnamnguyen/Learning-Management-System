<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Exercises List</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- Bootstrap Icons CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet"/>
    <style>
        /* Sử dụng table-bordered để có đường viền giữa các cột */
        table.table-bordered th,
        table.table-bordered td {
            border: 1px solid #dee2e6;
        }

        /* Dòng tiêu đề với màu xanh nhạt */
        table.table-bordered thead tr {
            background-color: #e3f2fd; /* Màu xanh nhạt */
            color: #000;
        }

        .btn-outline-search {
            border: 2px solid #0d6efd; /* Viền màu xanh Bootstrap */
            background-color: transparent; /* Không có màu nền */
            color: #0d6efd; /* Màu chữ mặc định */
            transition: all 0.3s ease; /* Hiệu ứng mượt */
        }

        .btn-outline-search:hover {
            background-color: #0d6efd; /* Màu nền xanh khi hover */
            color: white; /* Chữ trắng khi hover */
        }

        .btn-danger {
            background-color: transparent !important; /* Nền trong suốt */
            color: red !important; /* Màu chữ đỏ */
            border-color: red !important; /* Viền đỏ */
            transition: all 0.3s ease-in-out; /* Hiệu ứng mượt */
        }

        .btn-danger:hover {
            background-color: red !important; /* Nền đỏ khi hover */
            color: white !important; /* Chữ trắng khi hover */
        }

        .clear-btn {
            background-color: transparent; /* Nền trong suốt */
            border: 1px solid #ccc; /* Viền xám nhẹ */
            color: #000; /* Màu chữ đen */
            transition: background-color 0.3s, color 0.3s; /* Hiệu ứng mượt */
        }

        .clear-btn:hover {
            background-color: #6c757d; /* Màu nền xám khi hover */
            color: #fff; /* Màu chữ trắng khi hover */
        }

        /*    Alert css */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            max-width: 400px;
        }

        .custom-alert {
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 1rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.5s ease-out;
        }

        .alert-success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .alert-icon {
            margin-right: 12px;
            font-size: 1.2rem;
        }

        .alert-message {
            flex-grow: 1;
            margin-right: 12px;
        }

        .alert-close {
            background: transparent;
            border: none;
            color: inherit;
            padding: 0;
            font-size: 1.1rem;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .alert-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .col-md-6.d-flex .btn {
            height: 37px;
            position: relative;
            top: -23px;
            display: flex;
            align-items: center;
        }

        .col-md-6.d-flex a.btn {
            text-decoration: none;
        }
    </style>
</head>
<body>
<!-- Wrapper for the whole page -->
<div class="d-flex flex-column min-vh-100">
    <!-- Header -->
    <div th:replace="~{fragments :: header}" class="sticky-top"></div>

    <div class="alert-container">
        <!-- Success Alert -->
        <div th:if="${success}" class="custom-alert alert-success" role="alert" id="successAlert">
            <i class="bi bi-check-circle-fill alert-icon"></i>
            <span class="alert-message" th:text="${success}">Success message</span>
            <button type="button" class="alert-close" onclick="closeAlert('successAlert')">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <!-- Error Alert -->
        <div th:if="${error}" class="custom-alert alert-danger" role="alert" id="errorAlert">
            <i class="bi bi-exclamation-circle-fill alert-icon"></i>
            <span class="alert-message" th:text="${error}">Error message</span>
            <button type="button" class="alert-close" onclick="closeAlert('errorAlert')">
                <i class="bi bi-x"></i>
            </button>
        </div>
    </div>


    <!-- Main Content -->
    <div class="flex-grow-1 container-fluid mt-5">
        <div class="px-5">
            <!-- Title -->
            <h1 class="text-center mb-4">Exercises</h1>

            <!-- Combined Filter and Toolbar Section -->
            <div class="container-fluid mt-4">
                <div class="row gx-2 align-items-center mb-3">
                    <!-- Search Bar and Filters -->
                    <div class="col-md-6">
                        <div class="row gx-2 align-items-center">
                            <!-- Search Input -->
                            <div class="col-9">
                                <form id="filterForm" method="get" action="/exercises">
                                    <label for="searchInput" class="form-label">Search</label>
                                    <div class="input-group">
                                        <input type="text" id="searchInput" name="title" class="form-control"
                                               placeholder="Searching title..." th:value="${param.title}">
                                        <button type="submit" class="btn btn-outline-search">
                                            <i class="bi bi-search"></i>
                                        </button>
                                        <button type="button" class="btn clear-btn btn-secondary ms-1 px-4"
                                                onclick="clearFilters()">Clear</button>
                                    </div>

                                    <div class="row gx-2 mt-2">
                                        <!-- Language Filter -->
                                        <div class="col-md-6">
                                            <label for="languageFilter" class="form-label">Language</label>
                                            <select id="languageFilter" name="language" class="form-select">
                                                <option value="" th:selected="${currentLanguage == null}">All Languages</option>
                                                <option th:each="lang : ${languages}"
                                                        th:value="${lang.id}"
                                                        th:text="${lang.language}"
                                                        th:selected="${lang.id == currentLanguage}">
                                                </option>
                                            </select>
                                        </div>
                                        <!-- Difficulty Filter -->
                                        <div class="col-md-6">
                                            <label for="levelFilter" class="form-label">Difficulty</label>
                                            <select id="levelFilter" name="level" class="form-select">
                                                <option value="" th:selected="${currentLevel == null or currentLevel == ''}">All Levels</option>
                                                <option value="EASY" th:selected="${currentLevel == 'EASY'}">Easy</option>
                                                <option value="MEDIUM" th:selected="${currentLevel == 'MEDIUM'}">Medium</option>
                                                <option value="HARD" th:selected="${currentLevel == 'HARD'}">Hard</option>
                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons: Import, Export, Print, Add, Delete -->
                    <div class="col-md-6 d-flex justify-content-end align-items-center">
                        <!-- Import Button (Opens Modal) -->
                        <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal"
                                data-bs-target="#importModal">
                            <i class="bi bi-upload"></i> Import
                        </button>
                        <!-- Export Button -->
                        <a href="/exercises/export" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-file-earmark-excel"></i> Export
                        </a>
                        <!-- Print Button -->
                        <a href="/exercises/print" class="btn btn-outline-secondary me-2" target="_blank">
                            <i class="bi bi-printer"></i> Print
                        </a>
                        <a href="/exercises/create" class="btn btn-primary me-2">
                            <i class="bi bi-plus-circle"></i> Add
                        </a>
                        <button id="deleteSelected" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>

                <!-- Import Modal -->
                <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="importModalLabel">Import Excel File</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Template Import -->
                                <div class="mb-3">
                                    <p>Download the Excel template before uploading your file:</p>
                                    <a href="https://drive.usercontent.google.com/u/0/uc?id=19rJnBMdN-b76hpcq6G0W_Y3EOjiefa7H&export=download" class="btn btn-link" download>Download Exercise Template</a>
                                </div>
                                <!-- Form Upload -->
                                <form id="UploadForm" action="/exercises/import" method="post" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="file" class="form-label">Choose Excel File:</label>
                                        <input type="file" name="file" id="file" class="form-control" accept=".xlsx, .xls" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-upload"></i> Upload
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover table-bordered">
                    <thead>
                    <tr>
                        <th class="text-center">
                            <input type="checkbox" id="selectAll"/>
                        </th>
                        <th style="width: 20%;">Title</th>
                        <th class="text-center" style="width: 10%;">Language</th>
                        <th class="text-center" style="width: 10%;">Difficulty</th>
                        <th style="width: 40%;">Description</th>
                        <th class="text-center" style="width: 15%;">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="exercise : ${exercises}" th:attr="data-id=${exercise.id}">
                        <td class="text-center">
                            <input type="checkbox" class="selectItem"/>
                        </td>
                        <td th:text="${exercise.name}"></td>
                        <td class="text-center" th:text="${exercise.language.language}">Language</td>
                        <td class="text-center">
                <span th:class="${'badge ' + (exercise.level.name() == 'HARD' ? 'bg-danger' :
                         (exercise.level.name() == 'MEDIUM' ? 'bg-warning' : 'bg-success'))}"
                      th:text="${exercise.level}">
                </span>
                        </td>
                        <td th:utext="${exercise.description}"></td>
                        <td class="text-center">
                            <a th:href="@{'/judgement/code_space/' + ${exercise.id}}"
                               class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-info-circle"></i>
                            </a>
                            <a th:href="@{'/exercises/edit/' + ${exercise.id}}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a th:href="@{'/exercises/delete/' + ${exercise.id}}" class="btn btn-outline-danger btn-sm"
                               onclick="return confirm('Are you sure you want to delete this exercise?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(exercises)}">
                        <td colspan="6" class="text-center">No exercises found.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-center mt-4" th:if="${totalPages >= 1}">
                <nav>
                    <ul class="pagination">
                        <!-- Nút First: chỉ hiển thị nếu có nhiều hơn 1 trang và không phải trang đầu -->
                        <li class="page-item" th:if="${totalPages > 1 and currentPage > 0}">
                            <a class="page-link"
                               th:href="@{/exercises(page=0, language=${currentLanguage}, level=${currentLevel})}">
                                First
                            </a>
                        </li>
                        <!-- Nút Previous: chỉ hiển thị nếu có nhiều hơn 1 trang và không phải trang đầu -->
                        <li class="page-item" th:if="${totalPages > 1 and currentPage > 0}">
                            <a class="page-link"
                               th:href="@{/exercises(page=${currentPage - 1}, language=${currentLanguage}, level=${currentLevel})}">
                                Previous
                            </a>
                        </li>
                        <!-- Danh sách số trang -->
                        <li class="page-item"
                            th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            th:classappend="${i == currentPage} ? ' active'">
                            <a class="page-link"
                               th:href="@{/exercises(page=${i}, language=${currentLanguage}, level=${currentLevel})}"
                               th:text="${i + 1}">Page</a>
                        </li>
                        <!-- Nút Next: chỉ hiển thị nếu có nhiều hơn 1 trang và chưa ở trang cuối -->
                        <li class="page-item" th:if="${totalPages > 1 and currentPage < totalPages - 1}">
                            <a class="page-link"
                               th:href="@{/exercises(page=${currentPage + 1}, language=${currentLanguage}, level=${currentLevel})}">
                                Next
                            </a>
                        </li>
                        <!-- Nút Last: chỉ hiển thị nếu có nhiều hơn 1 trang và chưa ở trang cuối -->
                        <li class="page-item" th:if="${totalPages > 1 and currentPage < totalPages - 1}">
                            <a class="page-link"
                               th:href="@{/exercises(page=${totalPages - 1}, language=${currentLanguage}, level=${currentLevel})}">
                                Last
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

</div>

<!-- Toast Notification -->
<div id="deleteSuccessToast" class="toast position-fixed top-50 start-50 translate-middle" role="alert"
     aria-live="assertive" aria-atomic="true" style="z-index: 1050; display: none;">
    <div class="toast-header bg-success text-white">
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body text-center">
        Deleted Successfully!
    </div>
</div>
<!-- Footer -->
<div th:replace="~{fragments :: footer}" class="mt-auto"></div>
</div>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const selectAllCheckbox = document.getElementById("selectAll");
        const itemCheckboxes = document.querySelectorAll(".selectItem");
        const deleteButton = document.getElementById("deleteSelected");
        const toastElement = document.getElementById("deleteSuccessToast");

        function setupAlertAutoDismiss(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                setTimeout(() => {
                    closeAlert(alertId);
                }, 3000);
            }
        }

        function closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => {
                    alert.remove();
                }, 2000);
            }
        }

        // Setup auto-dismiss for both alerts
        setupAlertAutoDismiss('successAlert');
        setupAlertAutoDismiss('errorAlert');


        // Chọn tất cả checkbox
        selectAllCheckbox.addEventListener("change", function () {
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });

        // Nếu bỏ chọn một checkbox, bỏ chọn "Select All"
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                selectAllCheckbox.checked = [...itemCheckboxes].every(cb => cb.checked);
            });
        });

        // Xử lý khi nhấn nút "Delete Selected"
        deleteButton.addEventListener("click", function () {
            const selectedIds = [...document.querySelectorAll(".selectItem:checked")]
                .map(cb => cb.closest("tr").getAttribute("data-id"));

            if (selectedIds.length === 0) {
                alert("No exercises selected.");
                return;
            }

            if (confirm("Are you sure you want to delete selected exercises?")) {
                fetch('/exercises/delete-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ids: selectedIds})
                }).then(response => {
                    if (response.ok) {
                        showToast();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        alert("Failed to delete exercises.");
                    }
                });
            }
        });

        // Hiển thị thông báo
        function showToast() {
            toastElement.style.display = "block";
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
    });
    document.addEventListener("DOMContentLoaded", function () {
        const languageFilter = document.getElementById("languageFilter");
        const levelFilter = document.getElementById("levelFilter");
        const filterForm = document.getElementById("filterForm");

        // Submit form khi thay đổi dropdown
        languageFilter.addEventListener("change", function () {
            filterForm.submit();
        });

        levelFilter.addEventListener("change", function () {
            filterForm.submit();
        });

    });

    function clearFilters() {
        // Clear the dropdowns and input
        document.getElementById('languageFilter').value = '';
        document.getElementById('levelFilter').value = '';
        document.getElementById('searchInput').value = '';

        // Submit the form without filters
        document.getElementById('filterForm').submit();
    }
</script>

</body>
</html>

